<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Sign In - 增强版</title>
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:20px; }
#video { width: 640px; height: 480px; border-radius:10px; }
#status { margin: 10px 0; font-weight: bold; font-size: 18px; }
.loading { color: blue; }
.success { color: green; }
.error { color: red; }
canvas { position: absolute; top: 0; left: 0; z-index: 10; }
.video-container { 
    position: relative; 
    display: inline-block; 
    margin-bottom: 20px;
}
#recognitionInfo {
    margin: 20px auto;
    padding: 15px;
    background-color: #f5f5f5;
    border-radius: 8px;
    max-width: 600px;
    text-align: left;
}
.signin-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 15px;
    margin: 20px auto;
    border-radius: 8px;
    max-width: 600px;
}
#resultIframe {
    display: none;
    width: 0;
    height: 0;
    border: 0;
}
.security-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}
.security-high { background-color: #4CAF50; }
.security-medium { background-color: #FFC107; }
.security-low { background-color: #F44336; }
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
}
.stat-item {
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-size: 14px;
}
</style>
</head>
<body>

<h2>会议签到 - 增强版人脸识别</h2>

<div class="video-container">
    <video id="video" width="640" height="480" autoplay muted></video>
</div>

<div id="status" class="loading">正在初始化增强版识别系统...</div>

<div id="recognitionInfo" style="display: none;">
    <h3>识别结果</h3>
    <p>姓名: <span id="recognizedName">-</span></p>
    <div class="stats-grid">
        <div class="stat-item">置信度: <span id="recognitionConfidence">-</span></div>
        <div class="stat-item">相似度: <span id="recognitionSimilarity">-</span></div>
        <div class="stat-item">连续匹配: <span id="consecutiveMatches">0/3</span></div>
        <div class="stat-item">Z-score: <span id="zScore">-</span></div>
    </div>
    <p>状态: <span id="recognitionStatus">正在初始化...</span></p>
</div>

<!-- 签到成功提示区域 -->
<div id="signinSuccess" class="signin-success" style="display: none;">
    <h3>✓ 签到成功！</h3>
    <p>姓名: <span id="successName">-</span></p>
    <p>时间: <span id="successTime">-</span></p>
    <p>安全等级: <span id="securityLevel">高</span> <span class="security-indicator security-high"></span></p>
    <p>数据已成功提交到Google表格</p>
</div>

<!-- 隐藏的表单和iframe -->
<iframe id="resultIframe" name="resultIframe"></iframe>
<form id="sendForm" method="post" target="resultIframe" 
      action="https://script.google.com/macros/s/AKfycbwredN437XGaJCdq8qH9dQPM2CkXNNIkPLFfvB8BMxqAvSv7Dd4WnlhIn5wXKY5nsZs/exec" 
      style="display: none;">
    <input type="hidden" name="name" id="nameField">
    <input type="hidden" name="timestamp" id="timeField">
</form>

<script>
// ===============================
// 增强版人脸验证器
// ===============================
class EnhancedFaceVerifier {
  constructor() {
    this.knownFaces = new Map();
    this.consecutiveMatches = new Map();
    this.REQUIRED_CONSECUTIVE = 3; // 需要连续3帧匹配
    this.lastVerificationTime = 0;
    this.verificationDelay = 300; // 毫秒
  }
  
  // 添加已知人脸（支持多样本）
  addKnownFace(name, embeddings) {
    if (!Array.isArray(embeddings[0])) {
      embeddings = [embeddings]; // 单样本转为数组
    }
    
    // 计算统计特征
    const mean = this.calculateMean(embeddings);
    const std = this.calculateStd(embeddings, mean);
    const minSimilarity = this.calculateMinSimilarity(embeddings);
    
    this.knownFaces.set(name, {
      name: name,
      embeddings: embeddings,
      mean: mean,
      std: std,
      minSimilarity: minSimilarity
    });
    
    this.consecutiveMatches.set(name, 0);
    console.log(`已加载用户: ${name}, 样本数: ${embeddings.length}, 内部相似度: ${minSimilarity.toFixed(4)}`);
  }
  
  // 计算均值向量
  calculateMean(embeddings) {
    const dimensions = embeddings[0].length;
    const mean = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        mean[i] += emb[i];
      }
    }
    
    return mean.map(val => val / embeddings.length);
  }
  
  // 计算标准差向量
  calculateStd(embeddings, mean) {
    const dimensions = embeddings[0].length;
    const variance = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        variance[i] += Math.pow(emb[i] - mean[i], 2);
      }
    }
    
    // 加一个小值防止除零
    return variance.map(val => Math.sqrt(val / embeddings.length) + 1e-8);
  }
  
  // 计算内部最小相似度
  calculateMinSimilarity(embeddings) {
    if (embeddings.length <= 1) return 0.9; // 单样本默认
    
    let minSim = 1;
    for (let i = 0; i < embeddings.length; i++) {
      for (let j = i + 1; j < embeddings.length; j++) {
        const sim = this.cosineSimilarity(embeddings[i], embeddings[j]);
        if (sim < minSim) minSim = sim;
      }
    }
    return minSim;
  }
  
  // 余弦相似度（更准确）
  cosineSimilarity(a, b) {
    let dot = 0, normA = 0, normB = 0;
    for (let i = 0; i < a.length; i++) {
      dot += a[i] * b[i];
      normA += a[i] * a[i];
      normB += b[i] * b[i];
    }
    return dot / (Math.sqrt(normA) * Math.sqrt(normB));
  }
  
  // Z-score标准化距离
  zScoreDistance(liveEmbedding, knownFace) {
    let totalZ = 0;
    const dimensions = liveEmbedding.length;
    
    for (let i = 0; i < dimensions; i++) {
      const z = Math.abs((liveEmbedding[i] - knownFace.mean[i]) / knownFace.std[i]);
      totalZ += z;
    }
    
    return totalZ / dimensions; // 平均Z-score
  }
  
  // 综合验证人脸
  verifyFace(liveEmbedding) {
    const now = Date.now();
    if (now - this.lastVerificationTime < this.verificationDelay) {
      return null; // 防止过于频繁验证
    }
    this.lastVerificationTime = now;
    
    let bestMatch = null;
    let bestScore = Infinity;
    let bestSimilarity = -1;
    let bestZScore = Infinity;
    
    // 遍历所有已知人脸
    for (const [name, faceData] of this.knownFaces) {
      // 计算Z-score距离
      const zScore = this.zScoreDistance(liveEmbedding, faceData);
      
      // 计算余弦相似度
      const similarity = this.cosineSimilarity(liveEmbedding, faceData.mean);
      
      // 综合得分（Z-score权重70%，相似度30%）
      const combinedScore = zScore * 0.7 + (1 - similarity) * 0.3;
      
      if (combinedScore < bestScore) {
        bestScore = combinedScore;
        bestSimilarity = similarity;
        bestZScore = zScore;
        bestMatch = name;
      }
    }
    
    if (!bestMatch) return null;
    
    const faceData = this.knownFaces.get(bestMatch);
    
    // 三重阈值验证
    const isZScoreValid = bestZScore < 0.85;                    // Z-score阈值
    const isSimilarityValid = bestSimilarity > 0.75;           // 相似度阈值
    const isInternalValid = bestSimilarity > (faceData.minSimilarity * 0.85); // 内部一致性
    
    if (isZScoreValid && isSimilarityValid && isInternalValid) {
      // 更新连续匹配计数
      const currentCount = this.consecutiveMatches.get(bestMatch) + 1;
      this.consecutiveMatches.set(bestMatch, currentCount);
      
      // 重置其他用户的计数
      for (const [name] of this.consecutiveMatches) {
        if (name !== bestMatch) {
          this.consecutiveMatches.set(name, 0);
        }
      }
      
      // 计算综合置信度
      const confidence = Math.min(0.99, 0.7 * (1 - bestZScore) + 0.3 * bestSimilarity);
      
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: confidence,
        consecutiveMatches: currentCount,
        isConfirmed: currentCount >= this.REQUIRED_CONSECUTIVE,
        securityLevel: this.getSecurityLevel(confidence, bestZScore, bestSimilarity)
      };
    } else {
      // 验证失败，重置该用户的计数
      this.consecutiveMatches.set(bestMatch, 0);
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: 0,
        consecutiveMatches: 0,
        isConfirmed: false,
        securityLevel: 'low',
        reason: !isZScoreValid ? 'Z-score过高' : !isSimilarityValid ? '相似度不足' : '内部不一致'
      };
    }
  }
  
  // 获取安全等级
  getSecurityLevel(confidence, zScore, similarity) {
    if (confidence > 0.85 && zScore < 0.7 && similarity > 0.8) return 'high';
    if (confidence > 0.75 && zScore < 0.8 && similarity > 0.75) return 'medium';
    return 'low';
  }
  
  // 获取状态
  getStatus() {
    const status = {};
    for (const [name, count] of this.consecutiveMatches) {
      status[name] = { consecutiveMatches: count };
    }
    return status;
  }
}

// ===============================
// 已知用户数据（需要从collector复制过来）
// ===============================
const KNOWN_DATA = [
{
  "name": "BABABABA",
  "embeddings": [
    [
      -0.03767793998122215,
      0.050449665635824203,
      0.02824389562010765,
      0.004812910221517086,
      -0.030086806043982506,
      -0.03123791702091694,
      -0.05220964923501015,
      -0.1557183414697647,
      0.1346820890903473,
      -0.12355262786149979,
      0.2138390839099884,
      -0.054653480648994446,
      -0.20846836268901825,
      -0.09657574445009232,
      -0.07237505167722702,
      0.17556634545326233,
      -0.1987365037202835,
      -0.08766717463731766,
      -0.020405171439051628,
      -0.04576976224780083,
      0.10875667631626129,
      0.014204753562808037,
      0.03161334991455078,
      0.00945607852190733,
      -0.07587946951389313,
      -0.3022347688674927,
      -0.10600700974464417,
      -0.1144944354891777,
      0.058871280401945114,
      -0.04344511032104492,
      -0.07481007277965546,
      0.0013714013621211052,
      -0.15015390515327454,
      -0.0472036749124527,
      0.011306379921734333,
      0.0922693982720375,
      -0.06856723129749298,
      -0.10095362365245819,
      0.18441586196422577,
      -0.04698272794485092,
      -0.1715621054172516,
      0.011811798438429832,
      0.034026335924863815,
      0.21446570754051208,
      0.16087490320205688,
      0.08837633579969406,
      0.009137250483036041,
      -0.1205151304602623,
      0.07181946188211441,
      -0.17798598110675812,
      0.0137263722717762,
      0.11633042246103287,
      0.053825922310352325,
      0.08502786606550217,
      0.0030924773309379816,
      -0.12468239665031433,
      0.05686291307210922,
      0.07647164911031723,
      -0.12858015298843384,
      0.0021279649809002876,
      0.0957300215959549,
      -0.12856999039649963,
      -0.002558260690420866,
      -0.027355240657925606,
      0.2560119330883026,
      0.036759257316589355,
      -0.11959055811166763,
      -0.1186249777674675,
      0.0697607472538948,
      -0.1743318736553192,
      -0.0990428626537323,
      0.02916553057730198,
      -0.11858760565519333,
      -0.1747036576271057,
      -0.3103175461292267,
      0.033834636211395264,
      0.43742674589157104,
      0.11973012238740921,
      -0.12436413764953613,
      0.07548440247774124,
      -0.004248169716447592,
      0.0007543486426584423,
      0.21589690446853638,
      0.15294353663921356,
      -0.015451432205736637,
      0.007245208136737347,
      -0.10872138291597366,
      0.002123009879142046,
      0.1988910734653473,
      -0.1001524031162262,
      -0.05675049126148224,
      0.14925837516784668,
      -0.05975387617945671,
      0.098748579621315,
      -0.0032019438222050667,
      0.014549018815159798,
      -0.04568858444690704,
      0.07792168110609055,
      -0.06812545657157898,
      0.01614239066839218,
      0.11743326485157013,
      -0.012808965519070625,
      0.019028132781386375,
      0.09597266465425491,
      -0.10699013620615005,
      0.08286472409963608,
      -0.022750815376639366,
      -0.002185444813221693,
      0.07582055032253265,
      -0.052679091691970825,
      -0.15272457897663116,
      -0.030129512771964073,
      0.14313296973705292,
      -0.24121499061584473,
      0.2177971452474594,
      0.19564808905124664,
      0.05223064869642258,
      0.1325274109840393,
      0.1333349049091339,
      0.09459812939167023,
      -0.01671006716787815,
      -0.012307018972933292,
      -0.2628411650657654,
      -0.034554243087768555,
      0.11473789066076279,
      0.001301313517615199,
      0.12893344461917877,
      -0.02638120763003826
    ],
    [
      -0.040434274822473526,
      0.0465756319463253,
      0.03754270076751709,
      -0.0047346376813948154,
      -0.015295247547328472,
      -0.049187034368515015,
      -0.05770771950483322,
      -0.15683704614639282,
      0.15025301277637482,
      -0.11868447065353394,
      0.2091383934020996,
      -0.04363873973488808,
      -0.2003268152475357,
      -0.09419267624616623,
      -0.06624758243560791,
      0.1690651923418045,
      -0.18775105476379395,
      -0.07162122428417206,
      -0.02882964350283146,
      -0.04579184204339981,
      0.09547298401594162,
      0.025411812588572502,
      0.033600568771362305,
      0.003406131872907281,
      -0.06217886507511139,
      -0.2919462323188782,
      -0.10510919243097305,
      -0.10146751254796982,
      0.038279905915260315,
      -0.03799585998058319,
      -0.0888531431555748,
      0.014945928007364273,
      -0.1562740057706833,
      -0.0683213472366333,
      0.021718576550483704,
      0.11869324743747711,
      -0.0643722414970398,
      -0.09450450539588928,
      0.17590296268463135,
      -0.05376337096095085,
      -0.1648288369178772,
      0.024879368022084236,
      0.043643198907375336,
      0.20718978345394135,
      0.17393039166927338,
      0.09112723916769028,
      0.0072034611366689205,
      -0.12428900599479675,
      0.07821615040302277,
      -0.17557798326015472,
      0.012869558297097683,
      0.109002985060215,
      0.06284579634666443,
      0.08136603236198425,
      -0.001807846361771226,
      -0.14540262520313263,
      0.060598015785217285,
      0.06943083554506302,
      -0.12778034806251526,
      -0.006554750259965658,
      0.10653921961784363,
      -0.1417059749364853,
      -0.011092131957411766,
      -0.014577947556972504,
      0.25233644247055054,
      0.04362794756889343,
      -0.12705084681510925,
      -0.12598291039466858,
      0.049583710730075836,
      -0.1804160326719284,
      -0.08914781361818314,
      0.026493368670344353,
      -0.12053439766168594,
      -0.17518766224384308,
      -0.3182002305984497,
      0.04060640558600426,
      0.42629361152648926,
      0.11255855113267899,
      -0.1314781904220581,
      0.08298587799072266,
      -0.008143254555761814,
      0.0024868217296898365,
      0.19865475594997406,
      0.1597651094198227,
      -0.021132323890924454,
      0.023969560861587524,
      -0.11356742680072784,
      -0.003737146034836769,
      0.19637013971805573,
      -0.08801692724227905,
      -0.05332357436418533,
      0.14807207882404327,
      -0.057964030653238297,
      0.1028624102473259,
      -0.008249731734395027,
      0.01681254804134369,
      -0.05146035552024841,
      0.07122471928596497,
      -0.0752166286110878,
      0.018056711181998253,
      0.11770854890346527,
      -0.018731800839304924,
      0.016078447923064232,
      0.10173212736845016,
      -0.12344729155302048,
      0.0930708721280098,
      -0.037969548255205154,
      -0.002032238757237792,
      0.0731087327003479,
      -0.06612169742584229,
      -0.13162654638290405,
      -0.028195885941386223,
      0.14220762252807617,
      -0.23736689984798431,
      0.20669309794902802,
      0.19465985894203186,
      0.050713203847408295,
      0.14858639240264893,
      0.132805734872818,
      0.10489007830619812,
      -0.012451349757611752,
      0.009728399105370045,
      -0.260663777589798,
      -0.036043811589479446,
      0.10152215510606766,
      0.007394557353109121,
      0.14472568035125732,
      -0.01535410899668932
    ],
    [
      -0.039189934730529785,
      0.036099351942539215,
      0.024077503010630608,
      0.010610034689307213,
      -0.044292375445365906,
      -0.019388223066926003,
      -0.04494897648692131,
      -0.1445130854845047,
      0.15410500764846802,
      -0.13487404584884644,
      0.21855682134628296,
      -0.03995069861412048,
      -0.20271120965480804,
      -0.08002814650535583,
      -0.07700426131486893,
      0.18061910569667816,
      -0.18142248690128326,
      -0.08111922442913055,
      -0.023952653631567955,
      -0.04300033301115036,
      0.10184624046087265,
      -0.004392237868160009,
      0.0202195905148983,
      0.02017693780362606,
      -0.07293926179409027,
      -0.29327264428138733,
      -0.11924394220113754,
      -0.1042313352227211,
      0.03897281736135483,
      -0.046437740325927734,
      -0.08108443766832352,
      0.019552702084183693,
      -0.15200398862361908,
      -0.0577034130692482,
      0.01991398073732853,
      0.10092727839946747,
      -0.07237154245376587,
      -0.08339780569076538,
      0.18071578443050385,
      -0.049041058868169785,
      -0.16666722297668457,
      0.009880616329610348,
      0.03038409911096096,
      0.22220644354820251,
      0.15778352320194244,
      0.08825046569108963,
      0.0022042205091565847,
      -0.11762857437133789,
      0.08785288780927658,
      -0.17022958397865295,
      0.009850055910646915,
      0.12061996012926102,
      0.0849216878414154,
      0.09196481108665466,
      -0.0027964343316853046,
      -0.12687502801418304,
      0.0656394511461258,
      0.07967044413089752,
      -0.11797860264778137,
      0.002710410626605153,
      0.08232720196247101,
      -0.15193423628807068,
      0.009187841787934303,
      -0.024954915046691895,
      0.2567906975746155,
      0.03635311499238014,
      -0.12426018714904785,
      -0.12365611642599106,
      0.06778412312269211,
      -0.1642320305109024,
      -0.08586664497852325,
      0.01614193245768547,
      -0.13822120428085327,
      -0.18726560473442078,
      -0.3307214379310608,
      0.032950449734926224,
      0.4319714605808258,
      0.1205650120973587,
      -0.13208094239234924,
      0.0750066414475441,
      -0.013365309685468674,
      0.005729674361646175,
      0.19158899784088135,
      0.16511762142181396,
      -0.018461139872670174,
      0.008858189918100834,
      -0.11169164627790451,
      0.004870692268013954,
      0.19546906650066376,
      -0.1153927594423294,
      -0.051889996975660324,
      0.14806021749973297,
      -0.0671662837266922,
      0.10146208852529526,
      -0.012859195470809937,
      0.018709247931838036,
      -0.057479165494441986,
      0.07284250855445862,
      -0.07064551115036011,
      0.019828256219625473,
      0.09874960035085678,
      -0.012542071752250195,
      0.025680111721158028,
      0.09440017491579056,
      -0.11743612587451935,
      0.0792749896645546,
      -0.03261619433760643,
      0.008967956528067589,
      0.05806906148791313,
      -0.05243224650621414,
      -0.16950112581253052,
      -0.03782644867897034,
      0.1431158185005188,
      -0.23979274928569794,
      0.21695531904697418,
      0.19386418163776398,
      0.04097185656428337,
      0.13656505942344666,
      0.14146217703819275,
      0.09733131527900696,
      -0.019285213202238083,
      -0.011480317451059818,
      -0.24841393530368805,
      -0.02469136007130146,
      0.11685527861118317,
      0.0039113350212574005,
      0.12416129559278488,
      -0.026684604585170746
    ],
    [
      -0.02987237647175789,
      0.05308954045176506,
      0.03999835625290871,
      0.0036904022563248873,
      -0.031746603548526764,
      -0.036164119839668274,
      -0.04526538401842117,
      -0.15780656039714813,
      0.15021057426929474,
      -0.12546351552009583,
      0.21627099812030792,
      -0.048161350190639496,
      -0.20410902798175812,
      -0.08801375329494476,
      -0.07148623466491699,
      0.17308968305587769,
      -0.19950152933597565,
      -0.09233111143112183,
      -0.006180293392390013,
      -0.04293814301490784,
      0.10177712142467499,
      0.014222913421690464,
      0.031307585537433624,
      0.005830432754009962,
      -0.05603375658392906,
      -0.29526010155677795,
      -0.11760780215263367,
      -0.11328114569187164,
      0.0574861541390419,
      -0.04351119324564934,
      -0.08300651609897614,
      0.00966455228626728,
      -0.1582893580198288,
      -0.0672241672873497,
      0.013470906764268875,
      0.09713836759328842,
      -0.07194750756025314,
      -0.09278012067079544,
      0.18068116903305054,
      -0.05217922478914261,
      -0.16544847190380096,
      0.02187596820294857,
      0.03914669528603554,
      0.21245507895946503,
      0.16132718324661255,
      0.08979644626379013,
      0.003083528485149145,
      -0.12597909569740295,
      0.06441310048103333,
      -0.15969716012477875,
      0.0075469850562512875,
      0.11519388854503632,
      0.0777936577796936,
      0.081797756254673,
      -0.0046069687232375145,
      -0.1378701627254486,
      0.05608188360929489,
      0.07049987465143204,
      -0.14180266857147217,
      0.0055850776843726635,
      0.1014600321650505,
      -0.13355587422847748,
      0.0010366758797317743,
      -0.015348290093243122,
      0.2585986256599426,
      0.03641318157315254,
      -0.11804226785898209,
      -0.12917453050613403,
      0.06727960705757141,
      -0.1741712987422943,
      -0.09444563090801239,
      0.03289991244673729,
      -0.12326350063085556,
      -0.17602697014808655,
      -0.30641159415245056,
      0.030660178512334824,
      0.42287665605545044,
      0.10199160873889923,
      -0.1180516928434372,
      0.08639150112867355,
      -0.002519567497074604,
      -0.001507761306129396,
      0.1970120668411255,
      0.15954828262329102,
      -0.023119216784834862,
      0.022869061678647995,
      -0.11232253909111023,
      0.003590981476008892,
      0.18186114728450775,
      -0.09949459880590439,
      -0.05632184445858002,
      0.14436432719230652,
      -0.07158944010734558,
      0.10583897680044174,
      -0.0014828918501734734,
      0.020671844482421875,
      -0.04316335916519165,
      0.08359925448894501,
      -0.0838465541601181,
      0.014602531678974628,
      0.10385522246360779,
      -0.01625744439661503,
      0.013252886943519115,
      0.09446192532777786,
      -0.10777442902326584,
      0.06873393803834915,
      -0.03330120071768761,
      -0.0029008022975176573,
      0.05367633327841759,
      -0.06671424955129623,
      -0.1485055536031723,
      -0.024235226213932037,
      0.14748182892799377,
      -0.2524947226047516,
      0.21822990477085114,
      0.1939038336277008,
      0.03444307669997215,
      0.13368476927280426,
      0.13279816508293152,
      0.08903169631958008,
      -0.013306869193911552,
      -0.022248024120926857,
      -0.26877665519714355,
      -0.025311443954706192,
      0.11419060081243515,
      -0.0030339029617607594,
      0.13934752345085144,
      -0.021511932834982872
    ],
    [
      -0.035818036645650864,
      0.021963590756058693,
      0.028579968959093094,
      0.0029124030843377113,
      -0.022521065548062325,
      -0.053136128932237625,
      -0.038023870438337326,
      -0.1552935242652893,
      0.1488172560930252,
      -0.1088905930519104,
      0.20988929271697998,
      -0.06617899239063263,
      -0.20853401720523834,
      -0.08315237611532211,
      -0.0853194072842598,
      0.15771618485450745,
      -0.1853226274251938,
      -0.06745326519012451,
      0.004031042568385601,
      -0.04178295657038689,
      0.10812588036060333,
      0.03161470592021942,
      0.027775170281529427,
      0.016725318506360054,
      -0.07844597846269608,
      -0.27888327836990356,
      -0.10992663353681564,
      -0.11794862896203995,
      0.032079167664051056,
      -0.05471903830766678,
      -0.05594979226589203,
      0.02974206954240799,
      -0.13951486349105835,
      -0.04902824014425278,
      0.0188639797270298,
      0.1005111113190651,
      -0.06649349629878998,
      -0.0909697636961937,
      0.18371199071407318,
      -0.04952232539653778,
      -0.17441518604755402,
      -0.0059776948764920235,
      0.05331893265247345,
      0.21345405280590057,
      0.16557089984416962,
      0.09631014615297318,
      -0.015446387231349945,
      -0.12232640385627747,
      0.08262079954147339,
      -0.18677733838558197,
      0.0016434673452749848,
      0.10626618564128876,
      0.049983881413936615,
      0.06762979179620743,
      -0.012445809319615364,
      -0.13855841755867004,
      0.06551851332187653,
      0.05001736432313919,
      -0.163983553647995,
      -0.0015359412645921111,
      0.10434681922197342,
      -0.14211566746234894,
      -0.0036067632026970387,
      0.004829146899282932,
      0.23149949312210083,
      0.03713616356253624,
      -0.11597476899623871,
      -0.1111811101436615,
      0.07546325027942657,
      -0.21191368997097015,
      -0.08992228657007217,
      0.04307931661605835,
      -0.11174578964710236,
      -0.19220976531505585,
      -0.3152187168598175,
      0.016942927613854408,
      0.447490394115448,
      0.10748043656349182,
      -0.10355924814939499,
      0.08517497032880783,
      0.007344846148043871,
      0.00536655867472291,
      0.21491871774196625,
      0.14309880137443542,
      -0.019759176298975945,
      0.005933467764407396,
      -0.1229129359126091,
      -0.007742833346128464,
      0.1988857388496399,
      -0.09578724950551987,
      -0.0648084208369255,
      0.13203203678131104,
      -0.059760142117738724,
      0.09680946171283722,
      0.012085502035915852,
      0.02533312514424324,
      -0.044233061373233795,
      0.07544910162687302,
      -0.08334461599588394,
      0.021490447223186493,
      0.10102131962776184,
      -0.0188089981675148,
      0.02245114929974079,
      0.0990925058722496,
      -0.11557590961456299,
      0.10239674150943756,
      -0.016394684091210365,
      -0.031940195709466934,
      0.057294633239507675,
      -0.06289870291948318,
      -0.15106886625289917,
      -0.01792912557721138,
      0.15028439462184906,
      -0.23508739471435547,
      0.20602338016033173,
      0.17063584923744202,
      0.057783517986536026,
      0.15451009571552277,
      0.11634950339794159,
      0.0993398055434227,
      -0.026073021814227104,
      -0.011413904838263988,
      -0.2502668797969818,
      -0.04226668179035187,
      0.09375651180744171,
      0.0014760966878384352,
      0.15170368552207947,
      -0.03057202696800232
    ],
    [
      -0.06779221445322037,
      0.03438147157430649,
      0.02952258661389351,
      -0.020465290173888206,
      -0.08271688222885132,
      -0.03843121603131294,
      -0.03128678724169731,
      -0.14449384808540344,
      0.08452602475881577,
      -0.14809627830982208,
      0.18863064050674438,
      -0.08275306224822998,
      -0.1940324902534485,
      -0.07775448262691498,
      -0.0832432433962822,
      0.18275047838687897,
      -0.21367555856704712,
      -0.12211377918720245,
      -0.0709189772605896,
      -0.06288595497608185,
      0.0870267003774643,
      0.008088077418506145,
      -0.0005855077179148793,
      0.009854497388005257,
      -0.07267148792743683,
      -0.3349907696247101,
      -0.08399629592895508,
      -0.08321712166070938,
      0.05518145486712456,
      -0.07429001480340958,
      -0.024994289502501488,
      0.01877082884311676,
      -0.19086024165153503,
      -0.01798422262072563,
      0.005791612900793552,
      0.06980197876691818,
      -0.05268894508481026,
      -0.09759073704481125,
      0.17695096135139465,
      -0.05922916159033775,
      -0.17392507195472717,
      -0.028071481734514236,
      0.0771603062748909,
      0.21148964762687683,
      0.1346392035484314,
      0.050949882715940475,
      0.004529482219368219,
      -0.12618769705295563,
      0.08350638300180435,
      -0.18655234575271606,
      0.018432091921567917,
      0.10786122828722,
      0.01050730049610138,
      0.10871153324842453,
      0.002214668085798621,
      -0.10454390943050385,
      0.0537743903696537,
      0.12714055180549622,
      -0.08635976165533066,
      0.02995881251990795,
      0.07727625221014023,
      -0.14749057590961456,
      -0.03360188379883766,
      -0.057323064655065536,
      0.26802727580070496,
      0.02686994895339012,
      -0.10048943758010864,
      -0.10431236773729324,
      0.10116741806268692,
      -0.13655491173267365,
      -0.088782899081707,
      -0.008950435556471348,
      -0.09944116324186325,
      -0.14122289419174194,
      -0.30846935510635376,
      0.022766657173633575,
      0.4555013179779053,
      0.101285420358181,
      -0.13837529718875885,
      0.05803248658776283,
      -0.035948727279901505,
      0.00972534716129303,
      0.22865337133407593,
      0.13084222376346588,
      -0.03985923156142235,
      -0.006382022053003311,
      -0.08303289115428925,
      0.05563906207680702,
      0.2233860045671463,
      -0.0740286186337471,
      -0.0484490729868412,
      0.12712639570236206,
      -0.04978138580918312,
      0.06202580779790878,
      0.02081253007054329,
      -0.005520448554307222,
      -0.05288923159241676,
      0.04072612524032593,
      -0.08868660032749176,
      0.010369575582444668,
      0.10425179451704025,
      -0.045823145657777786,
      -0.003432819852605462,
      0.10285079479217529,
      -0.10136266052722931,
      0.07715817540884018,
      0.017815886065363884,
      -0.006227330770343542,
      0.08412005007266998,
      -0.022768164053559303,
      -0.14118891954421997,
      -0.058763932436704636,
      0.11846775561571121,
      -0.21584177017211914,
      0.23458106815814972,
      0.19306829571723938,
      0.05172587186098099,
      0.15988771617412567,
      0.1195342093706131,
      0.11046743392944336,
      -0.031067362055182457,
      -0.022272324189543724,
      -0.21672867238521576,
      -0.014623280614614487,
      0.14767980575561523,
      0.034542229026556015,
      0.10794653743505478,
      -0.031430684030056
    ],
    [
      -0.050714340060949326,
      0.04405651241540909,
      0.035317547619342804,
      -0.003159658284857869,
      -0.018358733505010605,
      -0.05017612501978874,
      -0.05723103508353233,
      -0.1571296602487564,
      0.1365841031074524,
      -0.12732501327991486,
      0.22015540301799774,
      -0.059433769434690475,
      -0.2090091109275818,
      -0.09490454196929932,
      -0.07699409127235413,
      0.16334490478038788,
      -0.1937040388584137,
      -0.08427561074495316,
      -0.011611255817115307,
      -0.036199070513248444,
      0.10758163779973984,
      0.019737502560019493,
      0.035404954105615616,
      0.00640899920836091,
      -0.08152196556329727,
      -0.3060350716114044,
      -0.11517295986413956,
      -0.09850920736789703,
      0.037628885358572006,
      -0.056171514093875885,
      -0.0696759819984436,
      0.018574729561805725,
      -0.15437014400959015,
      -0.04670538380742073,
      0.016215920448303223,
      0.11597669124603271,
      -0.05358134210109711,
      -0.08594278991222382,
      0.17123819887638092,
      -0.06633507460355759,
      -0.17350690066814423,
      -0.0031148723792284727,
      0.058934297412633896,
      0.21638202667236328,
      0.17658017575740814,
      0.09816405177116394,
      -0.008887634612619877,
      -0.13181746006011963,
      0.08092179149389267,
      -0.17309816181659698,
      0.02455064095556736,
      0.10181668400764465,
      0.05238211154937744,
      0.08547713607549667,
      -0.005075718276202679,
      -0.12081508338451385,
      0.059175122529268265,
      0.07604581117630005,
      -0.13260994851589203,
      -0.014320030808448792,
      0.10348398983478546,
      -0.13606809079647064,
      -0.007883683778345585,
      -0.01260922197252512,
      0.2564449608325958,
      0.03365207463502884,
      -0.12978056073188782,
      -0.12232717871665955,
      0.07139783352613449,
      -0.18539896607398987,
      -0.09309446066617966,
      0.040439438074827194,
      -0.11516870558261871,
      -0.17047177255153656,
      -0.324337899684906,
      0.031447332352399826,
      0.4413670003414154,
      0.10130801796913147,
      -0.11413336545228958,
      0.08165214210748672,
      -0.0071982028894126415,
      -0.0010096683399751782,
      0.20549140870571136,
      0.14528988301753998,
      -0.023857833817601204,
      0.00570581154897809,
      -0.1254054754972458,
      0.008387100882828236,
      0.2104395180940628,
      -0.08785201609134674,
      -0.061672110110521317,
      0.13128142058849335,
      -0.06016112118959427,
      0.10053320974111557,
      0.005642082076519728,
      0.03677169978618622,
      -0.05650407075881958,
      0.074610136449337,
      -0.08943530172109604,
      0.011037873104214668,
      0.11432941257953644,
      -0.00392258632928133,
      0.005043440032750368,
      0.11437518149614334,
      -0.10637079179286957,
      0.09834932535886765,
      -0.016557462513446808,
      -0.00856296718120575,
      0.08208902180194855,
      -0.058301933109760284,
      -0.14442886412143707,
      -0.04300836846232414,
      0.12868769466876984,
      -0.24669528007507324,
      0.19937244057655334,
      0.17312772572040558,
      0.061931610107421875,
      0.14529137313365936,
      0.12553861737251282,
      0.10609830915927887,
      -0.019037755206227303,
      -0.008231434039771557,
      -0.2606503963470459,
      -0.03333539143204689,
      0.11425349116325378,
      0.010421553626656532,
      0.1483241468667984,
      -0.02712167613208294
    ]
  ],
  "sample_count": 7,
  "collected_at": "2025-12-10T07:30:32.307Z",
  "angles_collected": [
    "正面",
    "左转",
    "右转",
    "抬头",
    "低头",
    "微笑",
    "中性"
  ],
  "average_quality": "high",
  "note": "增强版多角度采集数据"
}
];

// ===============================
// 主程序
// ===============================
let faceVerifier = null;
let isRecognizing = false;
let modelsLoaded = false;
let hasSignedIn = false;
let isSubmitting = false;

// DOM 元素引用
const videoElement = document.getElementById('video');
const statusEl = document.getElementById('status');
const recognitionInfoEl = document.getElementById('recognitionInfo');
const recognizedNameEl = document.getElementById('recognizedName');
const recognitionConfidenceEl = document.getElementById('recognitionConfidence');
const recognitionSimilarityEl = document.getElementById('recognitionSimilarity');
const consecutiveMatchesEl = document.getElementById('consecutiveMatches');
const zScoreEl = document.getElementById('zScore');
const recognitionStatusEl = document.getElementById('recognitionStatus');
const signinSuccessEl = document.getElementById('signinSuccess');
const successNameEl = document.getElementById('successName');
const successTimeEl = document.getElementById('successTime');
const securityLevelEl = document.getElementById('securityLevel');

// 页面加载后执行
window.addEventListener('load', async () => {
  try {
    statusEl.textContent = '正在初始化增强版人脸识别系统...';
    statusEl.className = 'loading';
    
    // 1. 检查face-api.js
    await checkFaceAPI();
    
    // 2. 启动摄像头
    await startCamera();
    
    // 3. 加载模型
    await loadModels();
    
    // 4. 初始化增强验证器
    faceVerifier = new EnhancedFaceVerifier();
    
    // 5. 加载已知人脸数据
    await loadKnownFaces();
    
    modelsLoaded = true;
    statusEl.textContent = '✓ 增强版系统已就绪！开始识别...';
    statusEl.className = 'success';
    
    // 显示识别信息区域
    recognitionInfoEl.style.display = 'block';
    
    // 开始识别循环
    recognizeLoop();
    
  } catch (error) {
    console.error('初始化失败:', error);
    statusEl.textContent = '初始化失败: ' + error.message;
    statusEl.className = 'error';
  }
});

// 检查 faceapi 是否加载
function checkFaceAPI() {
  return new Promise((resolve, reject) => {
    if (window.faceapi) {
      console.log('faceapi 已加载');
      resolve();
      return;
    }
    
    let attempts = 0;
    const maxAttempts = 30;
    const interval = setInterval(() => {
      attempts++;
      if (window.faceapi) {
        clearInterval(interval);
        console.log('faceapi 加载成功');
        resolve();
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        reject(new Error('face-api.js 加载超时'));
      }
    }, 100);
  });
}

// 启动摄像头
async function startCamera() {
  try {
    statusEl.textContent = '正在请求摄像头权限...';
    statusEl.className = 'loading';
    
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: 640, 
        height: 480,
        facingMode: "user" 
      } 
    });
    
    videoElement.srcObject = stream;
    
    return new Promise((resolve) => {
      videoElement.onloadedmetadata = () => {
        videoElement.play();
        console.log('摄像头启动完成');
        resolve();
      };
    });
  } catch (error) {
    console.error('摄像头错误:', error);
    throw new Error('无法访问摄像头: ' + error.message);
  }
}

// 加载模型
async function loadModels() {
  try {
    statusEl.textContent = '正在加载人脸识别模型...';
    statusEl.className = 'loading';
    
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
    
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    
    console.log('所有模型加载成功');
    
  } catch (error) {
    console.error('模型加载失败:', error);
    throw new Error('模型加载失败: ' + error.message);
  }
}

// 加载已知人脸数据
async function loadKnownFaces() {
  try {
    statusEl.textContent = '正在加载已知人脸数据...';
    
    // 支持两种格式：旧格式（单样本）和新格式（多样本）
    KNOWN_DATA.forEach(person => {
      if (person.embeddings && Array.isArray(person.embeddings[0])) {
        // 新格式：多样本
        faceVerifier.addKnownFace(person.name, person.embeddings);
      } else if (person.embedding) {
        // 旧格式：单样本
        faceVerifier.addKnownFace(person.name, person.embedding);
      } else {
        console.warn('未知的数据格式:', person);
      }
    });
    
    const userCount = faceVerifier.knownFaces.size;
    console.log(`已加载 ${userCount} 个用户数据`);
    statusEl.textContent = `✓ 已加载 ${userCount} 个用户数据`;
    
  } catch (error) {
    console.error('加载人脸数据失败:', error);
    throw new Error('人脸数据加载失败: ' + error.message);
  }
}

// 增强版识别循环
async function recognizeLoop() {
  if (!modelsLoaded || isRecognizing || hasSignedIn) return;
  
  try {
    isRecognizing = true;
    
    // 检测人脸（提高检测阈值）
    const detection = await faceapi
      .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions({
        inputSize: 320,
        scoreThreshold: 0.6
      }))
      .withFaceLandmarks()
      .withFaceDescriptor();
    
    if (detection && detection.detection.score > 0.7) {
      // 使用增强验证器
      const result = faceVerifier.verifyFace(detection.descriptor);
      
      if (result && result.confidence > 0) {
        // 更新UI显示
        updateRecognitionUI(result);
        
        // 检查是否确认
        if (result.isConfirmed && result.confidence > 0.85 && !hasSignedIn) {
          hasSignedIn = true;
          showSignInSuccess(result.name, result);
          sendSignIn(result.name, result.confidence);
        }
        
        // 绘制检测框
        drawDetection(detection, result);
        
      } else {
        // 验证失败
        resetRecognitionUI();
        if (result && result.reason) {
          recognitionStatusEl.textContent = `验证失败: ${result.reason}`;
        } else {
          recognitionStatusEl.textContent = '验证失败';
        }
        recognitionStatusEl.style.color = 'red';
      }
      
    } else {
      // 未检测到人脸或质量太低
      resetRecognitionUI();
      if (detection) {
        recognitionStatusEl.textContent = `检测质量低: ${detection.detection.score.toFixed(3)}`;
      } else {
        recognitionStatusEl.textContent = '未检测到人脸';
      }
      recognitionStatusEl.style.color = 'orange';
    }
    
  } catch (error) {
    console.error('识别错误:', error);
    recognitionStatusEl.textContent = '识别错误: ' + error.message;
    recognitionStatusEl.style.color = 'red';
  } finally {
    isRecognizing = false;
    
    // 继续识别循环（如果未签到）
    if (!hasSignedIn) {
      setTimeout(recognizeLoop, 300);
    }
  }
}

// 更新识别UI
function updateRecognitionUI(result) {
  recognizedNameEl.textContent = result.name;
  recognitionConfidenceEl.textContent = result.confidence.toFixed(4);
  recognitionSimilarityEl.textContent = result.similarity.toFixed(4);
  consecutiveMatchesEl.textContent = `${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE}`;
  zScoreEl.textContent = result.zScore.toFixed(4);
  
  // 设置状态颜色
  if (result.isConfirmed) {
    recognitionStatusEl.textContent = '✓ 高置信度确认！';
    recognitionStatusEl.style.color = 'green';
  } else if (result.confidence > 0.8) {
    recognitionStatusEl.textContent = `✓ 匹配中... (${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE})`;
    recognitionStatusEl.style.color = 'orange';
  } else if (result.confidence > 0.7) {
    recognitionStatusEl.textContent = `低置信度，请保持姿势`;
    recognitionStatusEl.style.color = '#FF9800';
  } else {
    recognitionStatusEl.textContent = '置信度不足';
    recognitionStatusEl.style.color = 'red';
  }
}

// 重置识别UI
function resetRecognitionUI() {
  recognizedNameEl.textContent = '-';
  recognitionConfidenceEl.textContent = '-';
  recognitionSimilarityEl.textContent = '-';
  consecutiveMatchesEl.textContent = '0/3';
  zScoreEl.textContent = '-';
}

// 绘制检测框
function drawDetection(detection, result) {
  const oldCanvas = document.querySelector('canvas');
  if (oldCanvas) oldCanvas.remove();
  
  const canvas = faceapi.createCanvasFromMedia(videoElement);
  const container = document.querySelector('.video-container');
  container.appendChild(canvas);
  
  const displaySize = { width: videoElement.width, height: videoElement.height };
  faceapi.matchDimensions(canvas, displaySize);
  
  const resizedDetection = faceapi.resizeResults(detection, displaySize);
  
  // 设置边框颜色
  const borderColor = result.confidence > 0.85 ? '#00ff00' : 
                     result.confance > 0.75 ? '#ff9900' : '#ff0000';
  
  const ctx = canvas.getContext('2d');
  
  // 绘制检测框
  faceapi.draw.drawDetections(canvas, [resizedDetection]);
  faceapi.draw.drawFaceLandmarks(canvas, [resizedDetection]);
  
  // 添加文字标签
  ctx.font = '16px Arial';
  ctx.fillStyle = borderColor;
  ctx.fillText(`${result.name} (${(result.confidence*100).toFixed(1)}%)`, 
               resizedDetection.detection.box.x, 
               resizedDetection.detection.box.y - 10);
}

// 显示签到成功信息
function showSignInSuccess(name, result) {
  const now = new Date();
  successNameEl.textContent = name;
  successTimeEl.textContent = now.toLocaleString();
  
  // 设置安全等级显示
  const securityLevels = {
    high: { text: '高', class: 'security-high', color: '#4CAF50' },
    medium: { text: '中', class: 'security-medium', color: '#FFC107' },
    low: { text: '低', class: 'security-low', color: '#F44336' }
  };
  
  const level = securityLevels[result.securityLevel || 'medium'];
  securityLevelEl.textContent = level.text;
  securityLevelEl.style.color = level.color;
  
  // 隐藏识别信息区域，显示成功区域
  recognitionInfoEl.style.display = 'none';
  signinSuccessEl.style.display = 'block';
  
  // 停止摄像头
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
    videoElement.style.opacity = '0.3';
  }
  
  statusEl.textContent = `✓ ${name} 签到成功！安全等级: ${level.text}`;
  statusEl.className = 'success';
}

// 发送签到信息
function sendSignIn(name, confidence) {
  try {
    isSubmitting = true;
    
    document.getElementById("nameField").value = name;
    document.getElementById("timeField").value = new Date().toISOString();
    
    console.log('正在提交签到数据:', name, '置信度:', confidence);
    
    const iframe = document.getElementById('resultIframe');
    iframe.onload = function() {
      console.log('数据提交完成！');
      isSubmitting = false;
      
      // 显示成功消息
      setTimeout(() => {
        alert(`✓ 签到成功！\n姓名: ${name}\n置信度: ${(confidence*100).toFixed(1)}%\n数据已保存到Google表格`);
      }, 300);
    };
    
    // 提交表单
    document.getElementById("sendForm").submit();
    
  } catch (error) {
    console.error('提交失败:', error);
    statusEl.textContent = '提交失败: ' + error.message;
    statusEl.className = 'error';
    alert('签到提交失败，请手动记录。错误: ' + error.message);
    isSubmitting = false;
    hasSignedIn = false; // 允许重试
  }
}

// 添加页面卸载时的清理
window.addEventListener('beforeunload', () => {
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
  }
});

// 全局错误处理
window.addEventListener('error', (e) => {
  console.error('全局错误:', e.error);
  if (statusEl) {
    statusEl.textContent = '发生错误: ' + e.message;
    statusEl.className = 'error';
  }
});
</script>

</body>
</html>
