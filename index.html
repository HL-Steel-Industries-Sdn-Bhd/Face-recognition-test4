<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Sign In - 增强版</title>
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:20px; }
#video { width: 640px; height: 480px; border-radius:10px; }
#status { margin: 10px 0; font-weight: bold; font-size: 18px; }
.loading { color: blue; }
.success { color: green; }
.error { color: red; }
canvas { position: absolute; top: 0; left: 0; z-index: 10; }
.video-container { 
    position: relative; 
    display: inline-block; 
    margin-bottom: 20px;
}
#recognitionInfo {
    margin: 20px auto;
    padding: 15px;
    background-color: #f5f5f5;
    border-radius: 8px;
    max-width: 600px;
    text-align: left;
}
.signin-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 15px;
    margin: 20px auto;
    border-radius: 8px;
    max-width: 600px;
}
#resultIframe {
    display: none;
    width: 0;
    height: 0;
    border: 0;
}
.security-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}
.security-high { background-color: #4CAF50; }
.security-medium { background-color: #FFC107; }
.security-low { background-color: #F44336; }
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
}
.stat-item {
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-size: 14px;
}
</style>
</head>
<body>

<h2>会议签到 - 增强版人脸识别</h2>

<div class="video-container">
    <video id="video" width="640" height="480" autoplay muted></video>
</div>

<div id="status" class="loading">正在初始化增强版识别系统...</div>

<div id="recognitionInfo" style="display: none;">
    <h3>识别结果</h3>
    <p>姓名: <span id="recognizedName">-</span></p>
    <div class="stats-grid">
        <div class="stat-item">置信度: <span id="recognitionConfidence">-</span></div>
        <div class="stat-item">相似度: <span id="recognitionSimilarity">-</span></div>
        <div class="stat-item">连续匹配: <span id="consecutiveMatches">0/3</span></div>
        <div class="stat-item">Z-score: <span id="zScore">-</span></div>
    </div>
    <p>状态: <span id="recognitionStatus">正在初始化...</span></p>
</div>

<!-- 签到成功提示区域 -->
<div id="signinSuccess" class="signin-success" style="display: none;">
    <h3>✓ 签到成功！</h3>
    <p>姓名: <span id="successName">-</span></p>
    <p>时间: <span id="successTime">-</span></p>
    <p>安全等级: <span id="securityLevel">高</span> <span class="security-indicator security-high"></span></p>
    <p>数据已成功提交到Google表格</p>
</div>

<!-- 隐藏的表单和iframe -->
<iframe id="resultIframe" name="resultIframe"></iframe>
<form id="sendForm" method="post" target="resultIframe" 
      action="https://script.google.com/macros/s/AKfycbwredN437XGaJCdq8qH9dQPM2CkXNNIkPLFfvB8BMxqAvSv7Dd4WnlhIn5wXKY5nsZs/exec" 
      style="display: none;">
    <input type="hidden" name="name" id="nameField">
    <input type="hidden" name="timestamp" id="timeField">
</form>

<script>
// ===============================
// 增强版人脸验证器
// ===============================
class EnhancedFaceVerifier {
  constructor() {
    this.knownFaces = new Map();
    this.consecutiveMatches = new Map();
    this.REQUIRED_CONSECUTIVE = 3; // 需要连续3帧匹配
    this.lastVerificationTime = 0;
    this.verificationDelay = 300; // 毫秒
  }
  
  // 添加已知人脸（支持多样本）
  addKnownFace(name, embeddings) {
    if (!Array.isArray(embeddings[0])) {
      embeddings = [embeddings]; // 单样本转为数组
    }
    
    // 计算统计特征
    const mean = this.calculateMean(embeddings);
    const std = this.calculateStd(embeddings, mean);
    const minSimilarity = this.calculateMinSimilarity(embeddings);
    
    this.knownFaces.set(name, {
      name: name,
      embeddings: embeddings,
      mean: mean,
      std: std,
      minSimilarity: minSimilarity
    });
    
    this.consecutiveMatches.set(name, 0);
    console.log(`已加载用户: ${name}, 样本数: ${embeddings.length}, 内部相似度: ${minSimilarity.toFixed(4)}`);
  }
  
  // 计算均值向量
  calculateMean(embeddings) {
    const dimensions = embeddings[0].length;
    const mean = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        mean[i] += emb[i];
      }
    }
    
    return mean.map(val => val / embeddings.length);
  }
  
  // 计算标准差向量
  calculateStd(embeddings, mean) {
    const dimensions = embeddings[0].length;
    const variance = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        variance[i] += Math.pow(emb[i] - mean[i], 2);
      }
    }
    
    // 加一个小值防止除零
    return variance.map(val => Math.sqrt(val / embeddings.length) + 1e-8);
  }
  
  // 计算内部最小相似度
  calculateMinSimilarity(embeddings) {
    if (embeddings.length <= 1) return 0.9; // 单样本默认
    
    let minSim = 1;
    for (let i = 0; i < embeddings.length; i++) {
      for (let j = i + 1; j < embeddings.length; j++) {
        const sim = this.cosineSimilarity(embeddings[i], embeddings[j]);
        if (sim < minSim) minSim = sim;
      }
    }
    return minSim;
  }
  
  // 余弦相似度（更准确）
  cosineSimilarity(a, b) {
    let dot = 0, normA = 0, normB = 0;
    for (let i = 0; i < a.length; i++) {
      dot += a[i] * b[i];
      normA += a[i] * a[i];
      normB += b[i] * b[i];
    }
    return dot / (Math.sqrt(normA) * Math.sqrt(normB));
  }
  
  // Z-score标准化距离
  zScoreDistance(liveEmbedding, knownFace) {
    let totalZ = 0;
    const dimensions = liveEmbedding.length;
    
    for (let i = 0; i < dimensions; i++) {
      const z = Math.abs((liveEmbedding[i] - knownFace.mean[i]) / knownFace.std[i]);
      totalZ += z;
    }
    
    return totalZ / dimensions; // 平均Z-score
  }
  
  // 综合验证人脸
  verifyFace(liveEmbedding) {
    const now = Date.now();
    if (now - this.lastVerificationTime < this.verificationDelay) {
      return null; // 防止过于频繁验证
    }
    this.lastVerificationTime = now;
    
    let bestMatch = null;
    let bestScore = Infinity;
    let bestSimilarity = -1;
    let bestZScore = Infinity;
    
    // 遍历所有已知人脸
    for (const [name, faceData] of this.knownFaces) {
      // 计算Z-score距离
      const zScore = this.zScoreDistance(liveEmbedding, faceData);
      
      // 计算余弦相似度
      const similarity = this.cosineSimilarity(liveEmbedding, faceData.mean);
      
      // 综合得分（Z-score权重70%，相似度30%）
      const combinedScore = zScore * 0.7 + (1 - similarity) * 0.3;
      
      if (combinedScore < bestScore) {
        bestScore = combinedScore;
        bestSimilarity = similarity;
        bestZScore = zScore;
        bestMatch = name;
      }
    }
    
    if (!bestMatch) return null;
    
    const faceData = this.knownFaces.get(bestMatch);
    
    // 三重阈值验证
    const isZScoreValid = bestZScore < 0.85;                    // Z-score阈值
    const isSimilarityValid = bestSimilarity > 0.75;           // 相似度阈值
    const isInternalValid = bestSimilarity > (faceData.minSimilarity * 0.85); // 内部一致性
    
    if (isZScoreValid && isSimilarityValid && isInternalValid) {
      // 更新连续匹配计数
      const currentCount = this.consecutiveMatches.get(bestMatch) + 1;
      this.consecutiveMatches.set(bestMatch, currentCount);
      
      // 重置其他用户的计数
      for (const [name] of this.consecutiveMatches) {
        if (name !== bestMatch) {
          this.consecutiveMatches.set(name, 0);
        }
      }
      
      // 计算综合置信度
      const confidence = Math.min(0.99, 0.7 * (1 - bestZScore) + 0.3 * bestSimilarity);
      
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: confidence,
        consecutiveMatches: currentCount,
        isConfirmed: currentCount >= this.REQUIRED_CONSECUTIVE,
        securityLevel: this.getSecurityLevel(confidence, bestZScore, bestSimilarity)
      };
    } else {
      // 验证失败，重置该用户的计数
      this.consecutiveMatches.set(bestMatch, 0);
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: 0,
        consecutiveMatches: 0,
        isConfirmed: false,
        securityLevel: 'low',
        reason: !isZScoreValid ? 'Z-score过高' : !isSimilarityValid ? '相似度不足' : '内部不一致'
      };
    }
  }
  
  // 获取安全等级
  getSecurityLevel(confidence, zScore, similarity) {
    if (confidence > 0.85 && zScore < 0.7 && similarity > 0.8) return 'high';
    if (confidence > 0.75 && zScore < 0.8 && similarity > 0.75) return 'medium';
    return 'low';
  }
  
  // 获取状态
  getStatus() {
    const status = {};
    for (const [name, count] of this.consecutiveMatches) {
      status[name] = { consecutiveMatches: count };
    }
    return status;
  }
}

// ===============================
// 已知用户数据（需要从collector复制过来）
// ===============================
const KNOWN_DATA = [
{
  "name": "USER_1765352641887",
  "embeddings": [
    [
      -0.04158829525113106,
      0.04578545317053795,
      0.03633306920528412,
      0.0007845837390050292,
      -0.04548589140176773,
      -0.02801973558962345,
      -0.039168380200862885,
      -0.13258139789104462,
      0.15973830223083496,
      -0.1300429403781891,
      0.23483701050281525,
      -0.05804450437426567,
      -0.18729960918426514,
      -0.06594441086053848,
      -0.07678568363189697,
      0.1671367734670639,
      -0.19658666849136353,
      -0.06518756598234177,
      -0.02049591764807701,
      -0.05007393658161163,
      0.11228739470243454,
      0.028737401589751244,
      -0.002960289129987359,
      0.014454647898674011,
      -0.07495898008346558,
      -0.2915358245372772,
      -0.12070532143115997,
      -0.08177413046360016,
      0.06798939406871796,
      -0.04247100651264191,
      -0.07074453681707382,
      0.008939428254961967,
      -0.15257149934768677,
      -0.06410253047943115,
      0.010508106090128422,
      0.09567433595657349,
      -0.08507167547941208,
      -0.0940260961651802,
      0.15335604548454285,
      -0.04044656455516815,
      -0.16431455314159393,
      0.032649729400873184,
      0.037204161286354065,
      0.21064665913581848,
      0.14551229774951935,
      0.11528899520635605,
      -0.009045821614563465,
      -0.10748311877250671,
      0.06187295913696289,
      -0.19355793297290802,
      -0.01929936185479164,
      0.13080495595932007,
      0.058725133538246155,
      0.08923711627721786,
      -0.005130847450345755,
      -0.11983436346054077,
      0.04336538910865784,
      0.08770778030157089,
      -0.1375553458929062,
      0.007626980543136597,
      0.07792187482118607,
      -0.12851956486701965,
      0.011957124806940556,
      -0.024601640179753304,
      0.2396242767572403,
      0.054006822407245636,
      -0.12172827124595642,
      -0.12596659362316132,
      0.07073508203029633,
      -0.19092680513858795,
      -0.10781890898942947,
      0.03277187421917915,
      -0.09767737984657288,
      -0.1926465630531311,
      -0.2990967929363251,
      0.04043088108301163,
      0.43127307295799255,
      0.12034360319375992,
      -0.11069337278604507,
      0.07412668317556381,
      0.000961266690865159,
      -0.0006259667570702732,
      0.19329750537872314,
      0.1465766578912735,
      -0.01879888027906418,
      0.0015511905075982213,
      -0.11290448904037476,
      -0.008221069350838661,
      0.1997731477022171,
      -0.09506171196699142,
      -0.03574959933757782,
      0.1744501143693924,
      -0.05371623486280441,
      0.10375743359327316,
      -0.01614457741379738,
      0.02725875750184059,
      -0.05655122175812721,
      0.07697620987892151,
      -0.059217214584350586,
      0.013309757225215435,
      0.1200399100780487,
      -0.005335903726518154,
      0.01832307130098343,
      0.10039328038692474,
      -0.1122165098786354,
      0.10947562754154205,
      -0.03892679139971733,
      -0.0006304381531663239,
      0.06612278521060944,
      -0.048516809940338135,
      -0.13730750977993011,
      -0.018022285774350166,
      0.14561504125595093,
      -0.24565251171588898,
      0.20847226679325104,
      0.20002129673957825,
      0.032170817255973816,
      0.13980181515216827,
      0.13699308037757874,
      0.08237946778535843,
      -0.009312454611063004,
      -0.020344464108347893,
      -0.2560496926307678,
      -0.051629438996315,
      0.09122299402952194,
      -0.02862512692809105,
      0.1083177775144577,
      -0.03130430728197098
    ],
    [
      -0.0525854267179966,
      0.0361136794090271,
      0.03401849418878555,
      0.0015621042111888528,
      -0.03685556724667549,
      -0.03811485692858696,
      -0.047093186527490616,
      -0.12360721081495285,
      0.18655019998550415,
      -0.12625397741794586,
      0.22106601297855377,
      -0.03315802663564682,
      -0.21491579711437225,
      -0.04658261314034462,
      -0.08422708511352539,
      0.1553221195936203,
      -0.18771500885486603,
      -0.053663574159145355,
      -0.0072872815653681755,
      -0.027216028422117233,
      0.1455962210893631,
      0.04291877523064613,
      0.025136904790997505,
      -0.002042461419478059,
      -0.08203664422035217,
      -0.31757375597953796,
      -0.12004996836185455,
      -0.07087007164955139,
      0.042607471346855164,
      -0.039682865142822266,
      -0.07905828952789307,
      0.040465760976076126,
      -0.15175969898700714,
      -0.061739612370729446,
      0.011458532884716988,
      0.11175460368394852,
      -0.024461625143885612,
      -0.06012909486889839,
      0.17295312881469727,
      -0.039434242993593216,
      -0.1929503083229065,
      0.0190268661826849,
      0.043694868683815,
      0.22504892945289612,
      0.14842525124549866,
      0.10155712813138962,
      -0.01674138754606247,
      -0.12496630102396011,
      0.05971227586269379,
      -0.19472558796405792,
      0.030020443722605705,
      0.12013153731822968,
      0.06218200922012329,
      0.05949970334768295,
      0.0007280089193955064,
      -0.13766150176525116,
      0.04572802782058716,
      0.10065940767526627,
      -0.17769816517829895,
      0.0019228729652240872,
      0.09911002218723297,
      -0.1439218372106552,
      0.018573107197880745,
      -0.0006700947415083647,
      0.25159668922424316,
      0.07277295738458633,
      -0.10674265027046204,
      -0.12666717171669006,
      0.09454407542943954,
      -0.1794722080230713,
      -0.0651199221611023,
      0.02482510730624199,
      -0.1310213804244995,
      -0.1973334550857544,
      -0.32485032081604004,
      0.04313475266098976,
      0.43239834904670715,
      0.10748392343521118,
      -0.10241571068763733,
      0.10621518641710281,
      -0.0035160055849701166,
      -0.002512300619855523,
      0.21880099177360535,
      0.15596076846122742,
      -0.010770116001367569,
      0.01140373945236206,
      -0.11066043376922607,
      0.03806129842996597,
      0.18919706344604492,
      -0.08535270392894745,
      -0.04390338063240051,
      0.17748534679412842,
      -0.0405704602599144,
      0.09811115264892578,
      -0.0003683732938952744,
      0.031087789684534073,
      -0.05177568271756172,
      0.06927387416362762,
      -0.10328835248947144,
      0.035033125430345535,
      0.09035016596317291,
      0.007911082357168198,
      0.03354273736476898,
      0.12816593050956726,
      -0.11460119485855103,
      0.054523490369319916,
      -0.033587291836738586,
      -0.02765263058245182,
      0.07090853154659271,
      -0.06412853300571442,
      -0.1170562282204628,
      -0.0658077523112297,
      0.12463578581809998,
      -0.24709495902061462,
      0.1986480951309204,
      0.17045651376247406,
      0.03486622869968414,
      0.1574450433254242,
      0.09469544887542725,
      0.09617653489112854,
      0.018268564715981483,
      -0.018911847844719887,
      -0.268444687128067,
      0.007700364105403423,
      0.10963410884141922,
      -0.01782933808863163,
      0.11796710640192032,
      -0.013051919639110565
    ],
    [
      -0.05620186775922775,
      0.04176436364650726,
      0.02819468080997467,
      0.011808604933321476,
      -0.04455887898802757,
      -0.03694348409771919,
      -0.042856279760599136,
      -0.13768801093101501,
      0.161722332239151,
      -0.12779133021831512,
      0.20905263721942902,
      -0.05614180117845535,
      -0.20148734748363495,
      -0.0612432062625885,
      -0.07918709516525269,
      0.1503160148859024,
      -0.20083661377429962,
      -0.0714041069149971,
      0.001566055347211659,
      -0.04239830747246742,
      0.12251784652471542,
      0.012219135649502277,
      0.019986063241958618,
      -0.004021951928734779,
      -0.0935763344168663,
      -0.306662917137146,
      -0.12767770886421204,
      -0.10581793636083603,
      0.04317991062998772,
      -0.04533231630921364,
      -0.08582305908203125,
      0.03198612853884697,
      -0.16044996678829193,
      -0.0694735124707222,
      0.010171924717724323,
      0.0918956771492958,
      -0.05764647200703621,
      -0.07284717261791229,
      0.1712988317012787,
      -0.041008323431015015,
      -0.1625789999961853,
      0.008591452613472939,
      0.0395943783223629,
      0.21791504323482513,
      0.15084491670131683,
      0.09906697273254395,
      -0.021104490384459496,
      -0.11620734632015228,
      0.06336242705583572,
      -0.16996346414089203,
      0.0006518592708744109,
      0.12475938349962234,
      0.07591211050748825,
      0.0917121097445488,
      -0.015221165493130684,
      -0.1175510361790657,
      0.059841398149728775,
      0.06810048222541809,
      -0.14571307599544525,
      0.0023049889132380486,
      0.09258289635181427,
      -0.1574363261461258,
      0.008593015372753143,
      -0.011849821545183659,
      0.27179616689682007,
      0.05373965948820114,
      -0.11526525765657425,
      -0.11184042692184448,
      0.0693550780415535,
      -0.1702226847410202,
      -0.08571173995733261,
      0.012078995816409588,
      -0.11455170065164566,
      -0.18562066555023193,
      -0.301251620054245,
      0.03527679666876793,
      0.42167437076568604,
      0.10351850092411041,
      -0.11902297288179398,
      0.08971250802278519,
      -0.025306399911642075,
      -0.014199847355484962,
      0.20115846395492554,
      0.1632179617881775,
      -0.024256518110632896,
      0.01625450700521469,
      -0.09718453139066696,
      0.010220031253993511,
      0.19684068858623505,
      -0.10577493906021118,
      -0.04612515866756439,
      0.1550593376159668,
      -0.06392864882946014,
      0.11390872299671173,
      0.0056561739183962345,
      0.010297330096364021,
      -0.05979616940021515,
      0.06892768293619156,
      -0.06866252422332764,
      0.024315208196640015,
      0.10018883645534515,
      -0.025548474863171577,
      0.011743423528969288,
      0.10412129759788513,
      -0.11414893716573715,
      0.07251002639532089,
      -0.024482620880007744,
      -0.014212790876626968,
      0.06343792378902435,
      -0.07390572130680084,
      -0.13744211196899414,
      -0.04364462569355965,
      0.13182954490184784,
      -0.25883516669273376,
      0.21742022037506104,
      0.180771604180336,
      0.026249339804053307,
      0.16009989380836487,
      0.11998067796230316,
      0.0889001414179802,
      -0.010042695328593254,
      -0.005178185645490885,
      -0.2531481087207794,
      -0.017066484317183495,
      0.12542207539081573,
      -0.006768150720745325,
      0.11944624036550522,
      -0.03242623433470726
    ],
    [
      -0.04724784195423126,
      0.03697916120290756,
      0.04448919743299484,
      0.015913892537355423,
      -0.04745488613843918,
      -0.03893357515335083,
      -0.05255497619509697,
      -0.17130617797374725,
      0.15116451680660248,
      -0.1684620976448059,
      0.21201613545417786,
      -0.0714370384812355,
      -0.19661815464496613,
      -0.06733683496713638,
      -0.0785335898399353,
      0.16140791773796082,
      -0.19964717328548431,
      -0.08468106389045715,
      -0.00014124027802608907,
      -0.03450162708759308,
      0.13030768930912018,
      0.018927056342363358,
      0.015778662636876106,
      0.005538687109947205,
      -0.09321253001689911,
      -0.3051929175853729,
      -0.15418045222759247,
      -0.08186616748571396,
      0.036157090216875076,
      -0.033991385251283646,
      -0.08800238370895386,
      0.015833288431167603,
      -0.1637047380208969,
      -0.06543731689453125,
      -0.005270134191960096,
      0.08795168250799179,
      -0.0673956647515297,
      -0.07880396395921707,
      0.17721734941005707,
      -0.06012366712093353,
      -0.16885730624198914,
      0.01849232241511345,
      0.057936154305934906,
      0.19793708622455597,
      0.1617409586906433,
      0.09817390888929367,
      -0.014345617033541203,
      -0.1315503567457199,
      0.07156522572040558,
      -0.16272534430027008,
      0.004680276848375797,
      0.13038326799869537,
      0.06703173369169235,
      0.08995555341243744,
      0.0008849637815728784,
      -0.12803484499454498,
      0.02995341084897518,
      0.11358286440372467,
      -0.10588710755109787,
      0.02669183909893036,
      0.08918058127164841,
      -0.14664985239505768,
      0.02756519615650177,
      -0.019412510097026825,
      0.261655330657959,
      0.029587455093860626,
      -0.1170613169670105,
      -0.11869052052497864,
      0.09146634489297867,
      -0.16600754857063293,
      -0.08330495655536652,
      0.022626278921961784,
      -0.12267190217971802,
      -0.1934223771095276,
      -0.3120598793029785,
      0.028366774320602417,
      0.4318837821483612,
      0.09033209830522537,
      -0.11066146939992905,
      0.09117888659238815,
      -0.024587983265519142,
      -0.010845773853361607,
      0.2014666348695755,
      0.15520454943180084,
      -0.004741822835057974,
      -0.007640087977051735,
      -0.11368940025568008,
      0.009497947059571743,
      0.20861516892910004,
      -0.0954124927520752,
      -0.024763379245996475,
      0.17840981483459473,
      -0.0681077316403389,
      0.10869601368904114,
      0.00238044117577374,
      0.019505804404616356,
      -0.07443991303443909,
      0.07500311732292175,
      -0.07430519908666611,
      0.028622863814234734,
      0.0930139571428299,
      -0.028816306963562965,
      0.011699814349412918,
      0.1156998723745346,
      -0.10068591684103012,
      0.07690735906362534,
      -0.031353142112493515,
      0.01214512437582016,
      0.06484825164079666,
      -0.06309312582015991,
      -0.15990771353244781,
      -0.04134589806199074,
      0.1444864124059677,
      -0.25199106335639954,
      0.19232439994812012,
      0.16554342210292816,
      0.015003171749413013,
      0.15559709072113037,
      0.13305531442165375,
      0.12085633724927902,
      -0.020937291905283928,
      -0.015056019648909569,
      -0.2798592448234558,
      -0.004375893156975508,
      0.12413197010755539,
      -0.01298652682453394,
      0.11988340318202972,
      -0.01351915579289198
    ],
    [
      -0.06372229009866714,
      0.021239105612039566,
      0.034027405083179474,
      0.018062304705381393,
      -0.016107773408293724,
      -0.06744681298732758,
      -0.04708683118224144,
      -0.1483209878206253,
      0.15060892701148987,
      -0.10641530156135559,
      0.21885250508785248,
      -0.05603218078613281,
      -0.19743014872074127,
      -0.08161220699548721,
      -0.07609330862760544,
      0.1663619726896286,
      -0.19190406799316406,
      -0.07610845565795898,
      -0.00883216131478548,
      -0.04623061791062355,
      0.10880380123853683,
      0.027333877980709076,
      0.022444525733590126,
      0.012640157714486122,
      -0.08558923006057739,
      -0.28600698709487915,
      -0.11032538115978241,
      -0.11384781450033188,
      0.03161820024251938,
      -0.0345887616276741,
      -0.08470460772514343,
      0.024476666003465652,
      -0.15214894711971283,
      -0.06966227293014526,
      0.027219539508223534,
      0.1035442054271698,
      -0.06023629382252693,
      -0.08885033428668976,
      0.1825806349515915,
      -0.046142809092998505,
      -0.1660715490579605,
      0.005122414790093899,
      0.05703161284327507,
      0.2250066101551056,
      0.16401901841163635,
      0.10721442103385925,
      -0.008019127883017063,
      -0.11943002045154572,
      0.07664702832698822,
      -0.18569079041481018,
      -0.003910080995410681,
      0.10527081787586212,
      0.07018233835697174,
      0.07145307213068008,
      -0.01647988148033619,
      -0.13922856748104095,
      0.04906933009624481,
      0.06441865861415863,
      -0.1414346843957901,
      -0.002719644457101822,
      0.10283134877681732,
      -0.14875663816928864,
      -0.015894979238510132,
      -0.028396282345056534,
      0.26261505484580994,
      0.03732124716043472,
      -0.1377323865890503,
      -0.09386693686246872,
      0.06062942370772362,
      -0.18271878361701965,
      -0.08831879496574402,
      0.02729736641049385,
      -0.10871294140815735,
      -0.19546166062355042,
      -0.31388217210769653,
      0.02773001417517662,
      0.43850624561309814,
      0.09481650590896606,
      -0.12730664014816284,
      0.08647821098566055,
      -0.006638840306550264,
      0.009389650076627731,
      0.2061922401189804,
      0.1550390124320984,
      -0.012421621941030025,
      0.01635596714913845,
      -0.11919870227575302,
      -0.021244555711746216,
      0.2078372836112976,
      -0.09504836052656174,
      -0.04044901579618454,
      0.1350724846124649,
      -0.05577513575553894,
      0.10142099857330322,
      -0.0016066726529970765,
      0.020740173757076263,
      -0.048827920109033585,
      0.06427603960037231,
      -0.07716946303844452,
      0.02700410597026348,
      0.09085738658905029,
      -0.007405437994748354,
      0.014672121033072472,
      0.08292538672685623,
      -0.1123119667172432,
      0.08667244017124176,
      -0.011017002165317535,
      -0.017919819802045822,
      0.06334307789802551,
      -0.07243992388248444,
      -0.13863931596279144,
      -0.0366133414208889,
      0.12921959161758423,
      -0.24803821742534637,
      0.19275085628032684,
      0.17909842729568481,
      0.047829464077949524,
      0.1700531244277954,
      0.11709311604499817,
      0.10064765810966492,
      -0.030184781178832054,
      0.009436242282390594,
      -0.2613712549209595,
      -0.037516288459300995,
      0.11219128966331482,
      -0.00009834750380832702,
      0.1446557641029358,
      -0.027401458472013474
    ],
    [
      -0.06625239551067352,
      0.050342146307229996,
      0.03065156564116478,
      0.009620764292776585,
      -0.09678032994270325,
      -0.03859305754303932,
      -0.023655876517295837,
      -0.12969271838665009,
      0.08584306389093399,
      -0.13402678072452545,
      0.1893688440322876,
      -0.0915604680776596,
      -0.1807483732700348,
      -0.0740446150302887,
      -0.07018084079027176,
      0.1784469038248062,
      -0.20265276730060577,
      -0.12242631614208221,
      -0.07742192596197128,
      -0.0749664306640625,
      0.10812075436115265,
      0.005137433297932148,
      -0.01931985281407833,
      0.01882617548108101,
      -0.08548886328935623,
      -0.32022878527641296,
      -0.07920222729444504,
      -0.07957915216684341,
      0.07889819145202637,
      -0.07283121347427368,
      -0.03622293844819069,
      0.011154858395457268,
      -0.18970632553100586,
      -0.04724022373557091,
      0.00881587527692318,
      0.0778258740901947,
      -0.0619477853178978,
      -0.11425415426492691,
      0.15882065892219543,
      -0.05622265860438347,
      -0.1706439107656479,
      -0.023146916180849075,
      0.07344267517328262,
      0.21135666966438293,
      0.13241100311279297,
      0.06250660121440887,
      -0.00034055826836265624,
      -0.10437661409378052,
      0.07362855225801468,
      -0.1969519853591919,
      -0.0002044790016952902,
      0.118987075984478,
      0.020597688853740692,
      0.12985724210739136,
      0.0017487544100731611,
      -0.10068535804748535,
      0.055937737226486206,
      0.13382314145565033,
      -0.08814039826393127,
      0.025068607181310654,
      0.07008706033229828,
      -0.15008309483528137,
      -0.016289865598082542,
      -0.06556089222431183,
      0.27279967069625854,
      0.03701533004641533,
      -0.08857722580432892,
      -0.10399550199508667,
      0.08777763694524765,
      -0.1451738327741623,
      -0.10700076818466187,
      -0.003942959941923618,
      -0.0887545719742775,
      -0.13553471863269806,
      -0.3033407926559448,
      0.030310133472085,
      0.4548564851284027,
      0.1121438667178154,
      -0.14055831730365753,
      0.04976863041520119,
      -0.032390445470809937,
      0.020160753279924393,
      0.23090140521526337,
      0.1290784627199173,
      -0.02487952634692192,
      -0.016018977388739586,
      -0.08650621771812439,
      0.03587770089507103,
      0.22589832544326782,
      -0.07987315952777863,
      -0.04057977721095085,
      0.13682441413402557,
      -0.04277843236923218,
      0.06489632278680801,
      0.016593139618635178,
      -0.017530707642436028,
      -0.053349871188402176,
      0.047217100858688354,
      -0.06355558335781097,
      0.007519284728914499,
      0.10778120160102844,
      -0.036870937794446945,
      0.0022415167186409235,
      0.09591168165206909,
      -0.09559694677591324,
      0.06537885963916779,
      0.011551350355148315,
      0.010870972648262978,
      0.0849023088812828,
      -0.02734915353357792,
      -0.14451411366462708,
      -0.05522092059254646,
      0.11937917768955231,
      -0.22258250415325165,
      0.2358604073524475,
      0.20205217599868774,
      0.031191252171993256,
      0.15015800297260284,
      0.12447541952133179,
      0.10604438185691833,
      -0.020915480330586433,
      -0.025352977216243744,
      -0.21071934700012207,
      -0.017142625525593758,
      0.14623263478279114,
      0.013937623240053654,
      0.08130660653114319,
      -0.03804640844464302
    ],
    [
      -0.050349730998277664,
      0.05723825842142105,
      0.03379356488585472,
      0.005417413543909788,
      -0.029212648048996925,
      -0.05092230439186096,
      -0.05355731025338173,
      -0.14701418578624725,
      0.1508481502532959,
      -0.13184329867362976,
      0.23548908531665802,
      -0.06203387677669525,
      -0.17677170038223267,
      -0.09224830567836761,
      -0.07042458653450012,
      0.148000106215477,
      -0.18938131630420685,
      -0.074883371591568,
      -0.002272521611303091,
      -0.058909133076667786,
      0.11529750376939774,
      0.021210288628935814,
      0.007760496344417334,
      0.009716236032545567,
      -0.06482087075710297,
      -0.299458384513855,
      -0.1276758462190628,
      -0.08908270299434662,
      0.08237574249505997,
      -0.057363077998161316,
      -0.08388011157512665,
      0.022077569738030434,
      -0.1646377146244049,
      -0.0804692953824997,
      0.022775327786803246,
      0.10355492681264877,
      -0.06629706919193268,
      -0.07317530363798141,
      0.1541285365819931,
      -0.06982450932264328,
      -0.1430414915084839,
      0.015477342531085014,
      0.05009550228714943,
      0.22455306351184845,
      0.1696188598871231,
      0.09861988574266434,
      -0.00861333217471838,
      -0.12413771450519562,
      0.07331144064664841,
      -0.14795413613319397,
      0.0003585323865991086,
      0.12604451179504395,
      0.08322496712207794,
      0.09756689518690109,
      0.00012041407899232581,
      -0.11142855137586594,
      0.048458077013492584,
      0.08278138935565948,
      -0.1325893998146057,
      0.007062679622322321,
      0.09048415720462799,
      -0.13719406723976135,
      0.0037216530181467533,
      -0.008880124427378178,
      0.24935276806354523,
      0.023815007880330086,
      -0.11307007819414139,
      -0.14897264540195465,
      0.0708802193403244,
      -0.18823157250881195,
      -0.09227517992258072,
      0.0428665429353714,
      -0.103770911693573,
      -0.1784374713897705,
      -0.2951435148715973,
      0.0430903360247612,
      0.41209927201271057,
      0.10694041103124619,
      -0.115848109126091,
      0.10881207138299942,
      -0.008588816039264202,
      -0.023688945919275284,
      0.1924460232257843,
      0.1476563662290573,
      -0.01992085762321949,
      0.013074908405542374,
      -0.11404910683631897,
      0.007786722853779793,
      0.1995353251695633,
      -0.09180128574371338,
      -0.03865527734160423,
      0.15189799666404724,
      -0.06705208867788315,
      0.10101397335529327,
      0.0015917203854769468,
      0.023924361914396286,
      -0.06691146641969681,
      0.08356758207082748,
      -0.07186891883611679,
      0.0030579727608710527,
      0.10844042152166367,
      -0.013565833680331707,
      0.007519473321735859,
      0.10272625833749771,
      -0.11361215263605118,
      0.10378968715667725,
      -0.035379860550165176,
      0.012441806495189667,
      0.05654133856296539,
      -0.07286512106657028,
      -0.12873990833759308,
      -0.02904287725687027,
      0.1312185674905777,
      -0.26136866211891174,
      0.20826463401317596,
      0.17707347869873047,
      0.04674093797802925,
      0.15074355900287628,
      0.12335603684186935,
      0.08508775383234024,
      0.008755306713283062,
      -0.024915248155593872,
      -0.24787403643131256,
      -0.030918356031179428,
      0.09903973340988159,
      -0.016077641397714615,
      0.11434615403413773,
      -0.03367181494832039
    ]
  ],
  "sample_count": 7,
  "collected_at": "2025-12-10T07:44:25.440Z",
  "angles_collected": [
    "正面",
    "左转",
    "右转",
    "抬头",
    "低头",
    "微笑",
    "中性"
  ],
  "average_quality": "high",
  "note": "增强版多角度采集数据"
}
];

// ===============================
// 主程序
// ===============================
let faceVerifier = null;
let isRecognizing = false;
let modelsLoaded = false;
let hasSignedIn = false;
let isSubmitting = false;

// DOM 元素引用
const videoElement = document.getElementById('video');
const statusEl = document.getElementById('status');
const recognitionInfoEl = document.getElementById('recognitionInfo');
const recognizedNameEl = document.getElementById('recognizedName');
const recognitionConfidenceEl = document.getElementById('recognitionConfidence');
const recognitionSimilarityEl = document.getElementById('recognitionSimilarity');
const consecutiveMatchesEl = document.getElementById('consecutiveMatches');
const zScoreEl = document.getElementById('zScore');
const recognitionStatusEl = document.getElementById('recognitionStatus');
const signinSuccessEl = document.getElementById('signinSuccess');
const successNameEl = document.getElementById('successName');
const successTimeEl = document.getElementById('successTime');
const securityLevelEl = document.getElementById('securityLevel');

// 页面加载后执行
window.addEventListener('load', async () => {
  try {
    statusEl.textContent = '正在初始化增强版人脸识别系统...';
    statusEl.className = 'loading';
    
    // 1. 检查face-api.js
    await checkFaceAPI();
    
    // 2. 启动摄像头
    await startCamera();
    
    // 3. 加载模型
    await loadModels();
    
    // 4. 初始化增强验证器
    faceVerifier = new EnhancedFaceVerifier();
    
    // 5. 加载已知人脸数据
    await loadKnownFaces();
    
    modelsLoaded = true;
    statusEl.textContent = '✓ 增强版系统已就绪！开始识别...';
    statusEl.className = 'success';
    
    // 显示识别信息区域
    recognitionInfoEl.style.display = 'block';
    
    // 开始识别循环
    recognizeLoop();
    
  } catch (error) {
    console.error('初始化失败:', error);
    statusEl.textContent = '初始化失败: ' + error.message;
    statusEl.className = 'error';
  }
});

// 检查 faceapi 是否加载
function checkFaceAPI() {
  return new Promise((resolve, reject) => {
    if (window.faceapi) {
      console.log('faceapi 已加载');
      resolve();
      return;
    }
    
    let attempts = 0;
    const maxAttempts = 30;
    const interval = setInterval(() => {
      attempts++;
      if (window.faceapi) {
        clearInterval(interval);
        console.log('faceapi 加载成功');
        resolve();
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        reject(new Error('face-api.js 加载超时'));
      }
    }, 100);
  });
}

// 启动摄像头
async function startCamera() {
  try {
    statusEl.textContent = '正在请求摄像头权限...';
    statusEl.className = 'loading';
    
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: 640, 
        height: 480,
        facingMode: "user" 
      } 
    });
    
    videoElement.srcObject = stream;
    
    return new Promise((resolve) => {
      videoElement.onloadedmetadata = () => {
        videoElement.play();
        console.log('摄像头启动完成');
        resolve();
      };
    });
  } catch (error) {
    console.error('摄像头错误:', error);
    throw new Error('无法访问摄像头: ' + error.message);
  }
}

// 加载模型
async function loadModels() {
  try {
    statusEl.textContent = '正在加载人脸识别模型...';
    statusEl.className = 'loading';
    
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
    
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    
    console.log('所有模型加载成功');
    
  } catch (error) {
    console.error('模型加载失败:', error);
    throw new Error('模型加载失败: ' + error.message);
  }
}

// 加载已知人脸数据
async function loadKnownFaces() {
  try {
    statusEl.textContent = '正在加载已知人脸数据...';
    
    // 支持两种格式：旧格式（单样本）和新格式（多样本）
    KNOWN_DATA.forEach(person => {
      if (person.embeddings && Array.isArray(person.embeddings[0])) {
        // 新格式：多样本
        faceVerifier.addKnownFace(person.name, person.embeddings);
      } else if (person.embedding) {
        // 旧格式：单样本
        faceVerifier.addKnownFace(person.name, person.embedding);
      } else {
        console.warn('未知的数据格式:', person);
      }
    });
    
    const userCount = faceVerifier.knownFaces.size;
    console.log(`已加载 ${userCount} 个用户数据`);
    statusEl.textContent = `✓ 已加载 ${userCount} 个用户数据`;
    
  } catch (error) {
    console.error('加载人脸数据失败:', error);
    throw new Error('人脸数据加载失败: ' + error.message);
  }
}

// 增强版识别循环
async function recognizeLoop() {
  if (!modelsLoaded || isRecognizing || hasSignedIn) return;
  
  try {
    isRecognizing = true;
    
    // 检测人脸（提高检测阈值）
    const detection = await faceapi
      .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions({
        inputSize: 320,
        scoreThreshold: 0.6
      }))
      .withFaceLandmarks()
      .withFaceDescriptor();
    
    if (detection && detection.detection.score > 0.7) {
      // 使用增强验证器
      const result = faceVerifier.verifyFace(detection.descriptor);
      
      if (result && result.confidence > 0) {
        // 更新UI显示
        updateRecognitionUI(result);
        
        // 检查是否确认
        if (result.isConfirmed && result.confidence > 0.85 && !hasSignedIn) {
          hasSignedIn = true;
          showSignInSuccess(result.name, result);
          sendSignIn(result.name, result.confidence);
        }
        
        // 绘制检测框
        drawDetection(detection, result);
        
      } else {
        // 验证失败
        resetRecognitionUI();
        if (result && result.reason) {
          recognitionStatusEl.textContent = `验证失败: ${result.reason}`;
        } else {
          recognitionStatusEl.textContent = '验证失败';
        }
        recognitionStatusEl.style.color = 'red';
      }
      
    } else {
      // 未检测到人脸或质量太低
      resetRecognitionUI();
      if (detection) {
        recognitionStatusEl.textContent = `检测质量低: ${detection.detection.score.toFixed(3)}`;
      } else {
        recognitionStatusEl.textContent = '未检测到人脸';
      }
      recognitionStatusEl.style.color = 'orange';
    }
    
  } catch (error) {
    console.error('识别错误:', error);
    recognitionStatusEl.textContent = '识别错误: ' + error.message;
    recognitionStatusEl.style.color = 'red';
  } finally {
    isRecognizing = false;
    
    // 继续识别循环（如果未签到）
    if (!hasSignedIn) {
      setTimeout(recognizeLoop, 300);
    }
  }
}

// 更新识别UI
function updateRecognitionUI(result) {
  recognizedNameEl.textContent = result.name;
  recognitionConfidenceEl.textContent = result.confidence.toFixed(4);
  recognitionSimilarityEl.textContent = result.similarity.toFixed(4);
  consecutiveMatchesEl.textContent = `${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE}`;
  zScoreEl.textContent = result.zScore.toFixed(4);
  
  // 设置状态颜色
  if (result.isConfirmed) {
    recognitionStatusEl.textContent = '✓ 高置信度确认！';
    recognitionStatusEl.style.color = 'green';
  } else if (result.confidence > 0.8) {
    recognitionStatusEl.textContent = `✓ 匹配中... (${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE})`;
    recognitionStatusEl.style.color = 'orange';
  } else if (result.confidence > 0.7) {
    recognitionStatusEl.textContent = `低置信度，请保持姿势`;
    recognitionStatusEl.style.color = '#FF9800';
  } else {
    recognitionStatusEl.textContent = '置信度不足';
    recognitionStatusEl.style.color = 'red';
  }
}

// 重置识别UI
function resetRecognitionUI() {
  recognizedNameEl.textContent = '-';
  recognitionConfidenceEl.textContent = '-';
  recognitionSimilarityEl.textContent = '-';
  consecutiveMatchesEl.textContent = '0/3';
  zScoreEl.textContent = '-';
}

// 绘制检测框
function drawDetection(detection, result) {
  const oldCanvas = document.querySelector('canvas');
  if (oldCanvas) oldCanvas.remove();
  
  const canvas = faceapi.createCanvasFromMedia(videoElement);
  const container = document.querySelector('.video-container');
  container.appendChild(canvas);
  
  const displaySize = { width: videoElement.width, height: videoElement.height };
  faceapi.matchDimensions(canvas, displaySize);
  
  const resizedDetection = faceapi.resizeResults(detection, displaySize);
  
  // 设置边框颜色
  const borderColor = result.confidence > 0.85 ? '#00ff00' : 
                     result.confance > 0.75 ? '#ff9900' : '#ff0000';
  
  const ctx = canvas.getContext('2d');
  
  // 绘制检测框
  faceapi.draw.drawDetections(canvas, [resizedDetection]);
  faceapi.draw.drawFaceLandmarks(canvas, [resizedDetection]);
  
  // 添加文字标签
  ctx.font = '16px Arial';
  ctx.fillStyle = borderColor;
  ctx.fillText(`${result.name} (${(result.confidence*100).toFixed(1)}%)`, 
               resizedDetection.detection.box.x, 
               resizedDetection.detection.box.y - 10);
}

// 显示签到成功信息
function showSignInSuccess(name, result) {
  const now = new Date();
  successNameEl.textContent = name;
  successTimeEl.textContent = now.toLocaleString();
  
  // 设置安全等级显示
  const securityLevels = {
    high: { text: '高', class: 'security-high', color: '#4CAF50' },
    medium: { text: '中', class: 'security-medium', color: '#FFC107' },
    low: { text: '低', class: 'security-low', color: '#F44336' }
  };
  
  const level = securityLevels[result.securityLevel || 'medium'];
  securityLevelEl.textContent = level.text;
  securityLevelEl.style.color = level.color;
  
  // 隐藏识别信息区域，显示成功区域
  recognitionInfoEl.style.display = 'none';
  signinSuccessEl.style.display = 'block';
  
  // 停止摄像头
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
    videoElement.style.opacity = '0.3';
  }
  
  statusEl.textContent = `✓ ${name} 签到成功！安全等级: ${level.text}`;
  statusEl.className = 'success';
}

// 发送签到信息
function sendSignIn(name, confidence) {
  try {
    isSubmitting = true;
    
    document.getElementById("nameField").value = name;
    document.getElementById("timeField").value = new Date().toISOString();
    
    console.log('正在提交签到数据:', name, '置信度:', confidence);
    
    const iframe = document.getElementById('resultIframe');
    iframe.onload = function() {
      console.log('数据提交完成！');
      isSubmitting = false;
      
      // 显示成功消息
      setTimeout(() => {
        alert(`✓ 签到成功！\n姓名: ${name}\n置信度: ${(confidence*100).toFixed(1)}%\n数据已保存到Google表格`);
      }, 300);
    };
    
    // 提交表单
    document.getElementById("sendForm").submit();
    
  } catch (error) {
    console.error('提交失败:', error);
    statusEl.textContent = '提交失败: ' + error.message;
    statusEl.className = 'error';
    alert('签到提交失败，请手动记录。错误: ' + error.message);
    isSubmitting = false;
    hasSignedIn = false; // 允许重试
  }
}

// 添加页面卸载时的清理
window.addEventListener('beforeunload', () => {
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
  }
});

// 全局错误处理
window.addEventListener('error', (e) => {
  console.error('全局错误:', e.error);
  if (statusEl) {
    statusEl.textContent = '发生错误: ' + e.message;
    statusEl.className = 'error';
  }
});
</script>

</body>
</html>
