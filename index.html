<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Sign In - 增强版</title>
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:20px; }
#video { width: 640px; height: 480px; border-radius:10px; }
#status { margin: 10px 0; font-weight: bold; font-size: 18px; }
.loading { color: blue; }
.success { color: green; }
.error { color: red; }
canvas { position: absolute; top: 0; left: 0; z-index: 10; }
.video-container { 
    position: relative; 
    display: inline-block; 
    margin-bottom: 20px;
}
#recognitionInfo {
    margin: 20px auto;
    padding: 15px;
    background-color: #f5f5f5;
    border-radius: 8px;
    max-width: 600px;
    text-align: left;
}
.signin-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 15px;
    margin: 20px auto;
    border-radius: 8px;
    max-width: 600px;
}
#resultIframe {
    display: none;
    width: 0;
    height: 0;
    border: 0;
}
.security-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}
.security-high { background-color: #4CAF50; }
.security-medium { background-color: #FFC107; }
.security-low { background-color: #F44336; }
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
}
.stat-item {
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-size: 14px;
}
</style>
</head>
<body>

<h2>会议签到 - 增强版人脸识别</h2>

<div class="video-container">
    <video id="video" width="640" height="480" autoplay muted></video>
</div>

<div id="status" class="loading">正在初始化增强版识别系统...</div>

<div id="recognitionInfo" style="display: none;">
    <h3>识别结果</h3>
    <p>姓名: <span id="recognizedName">-</span></p>
    <div class="stats-grid">
        <div class="stat-item">置信度: <span id="recognitionConfidence">-</span></div>
        <div class="stat-item">相似度: <span id="recognitionSimilarity">-</span></div>
        <div class="stat-item">连续匹配: <span id="consecutiveMatches">0/3</span></div>
        <div class="stat-item">Z-score: <span id="zScore">-</span></div>
    </div>
    <p>状态: <span id="recognitionStatus">正在初始化...</span></p>
</div>

<!-- 签到成功提示区域 -->
<div id="signinSuccess" class="signin-success" style="display: none;">
    <h3>✓ 签到成功！</h3>
    <p>姓名: <span id="successName">-</span></p>
    <p>时间: <span id="successTime">-</span></p>
    <p>安全等级: <span id="securityLevel">高</span> <span class="security-indicator security-high"></span></p>
    <p>数据已成功提交到Google表格</p>
</div>

<!-- 隐藏的表单和iframe -->
<iframe id="resultIframe" name="resultIframe"></iframe>
<form id="sendForm" method="post" target="resultIframe" 
      action="https://script.google.com/macros/s/AKfycbwredN437XGaJCdq8qH9dQPM2CkXNNIkPLFfvB8BMxqAvSv7Dd4WnlhIn5wXKY5nsZs/exec" 
      style="display: none;">
    <input type="hidden" name="name" id="nameField">
    <input type="hidden" name="timestamp" id="timeField">
</form>

<script>
// ===============================
// 增强版人脸验证器
// ===============================
class EnhancedFaceVerifier {
  constructor() {
    this.knownFaces = new Map();
    this.consecutiveMatches = new Map();
    this.REQUIRED_CONSECUTIVE = 3; // 需要连续3帧匹配
    this.lastVerificationTime = 0;
    this.verificationDelay = 300; // 毫秒
  }
  
  // 添加已知人脸（支持多样本）
  addKnownFace(name, embeddings) {
    if (!Array.isArray(embeddings[0])) {
      embeddings = [embeddings]; // 单样本转为数组
    }
    
    // 计算统计特征
    const mean = this.calculateMean(embeddings);
    const std = this.calculateStd(embeddings, mean);
    const minSimilarity = this.calculateMinSimilarity(embeddings);
    
    this.knownFaces.set(name, {
      name: name,
      embeddings: embeddings,
      mean: mean,
      std: std,
      minSimilarity: minSimilarity
    });
    
    this.consecutiveMatches.set(name, 0);
    console.log(`已加载用户: ${name}, 样本数: ${embeddings.length}, 内部相似度: ${minSimilarity.toFixed(4)}`);
  }
  
  // 计算均值向量
  calculateMean(embeddings) {
    const dimensions = embeddings[0].length;
    const mean = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        mean[i] += emb[i];
      }
    }
    
    return mean.map(val => val / embeddings.length);
  }
  
  // 计算标准差向量
  calculateStd(embeddings, mean) {
    const dimensions = embeddings[0].length;
    const variance = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        variance[i] += Math.pow(emb[i] - mean[i], 2);
      }
    }
    
    // 加一个小值防止除零
    return variance.map(val => Math.sqrt(val / embeddings.length) + 1e-8);
  }
  
  // 计算内部最小相似度
  calculateMinSimilarity(embeddings) {
    if (embeddings.length <= 1) return 0.9; // 单样本默认
    
    let minSim = 1;
    for (let i = 0; i < embeddings.length; i++) {
      for (let j = i + 1; j < embeddings.length; j++) {
        const sim = this.cosineSimilarity(embeddings[i], embeddings[j]);
        if (sim < minSim) minSim = sim;
      }
    }
    return minSim;
  }
  
  // 余弦相似度（更准确）
  cosineSimilarity(a, b) {
    let dot = 0, normA = 0, normB = 0;
    for (let i = 0; i < a.length; i++) {
      dot += a[i] * b[i];
      normA += a[i] * a[i];
      normB += b[i] * b[i];
    }
    return dot / (Math.sqrt(normA) * Math.sqrt(normB));
  }
  
  // Z-score标准化距离
  zScoreDistance(liveEmbedding, knownFace) {
    let totalZ = 0;
    const dimensions = liveEmbedding.length;
    
    for (let i = 0; i < dimensions; i++) {
      const z = Math.abs((liveEmbedding[i] - knownFace.mean[i]) / knownFace.std[i]);
      totalZ += z;
    }
    
    return totalZ / dimensions; // 平均Z-score
  }
  
  // 综合验证人脸
  verifyFace(liveEmbedding) {
    const now = Date.now();
    if (now - this.lastVerificationTime < this.verificationDelay) {
      return null; // 防止过于频繁验证
    }
    this.lastVerificationTime = now;
    
    let bestMatch = null;
    let bestScore = Infinity;
    let bestSimilarity = -1;
    let bestZScore = Infinity;
    
    // 遍历所有已知人脸
    for (const [name, faceData] of this.knownFaces) {
      // 计算Z-score距离
      const zScore = this.zScoreDistance(liveEmbedding, faceData);
      
      // 计算余弦相似度
      const similarity = this.cosineSimilarity(liveEmbedding, faceData.mean);
      
      // 综合得分（Z-score权重70%，相似度30%）
      const combinedScore = zScore * 0.7 + (1 - similarity) * 0.3;
      
      if (combinedScore < bestScore) {
        bestScore = combinedScore;
        bestSimilarity = similarity;
        bestZScore = zScore;
        bestMatch = name;
      }
    }
    
    if (!bestMatch) return null;
    
    const faceData = this.knownFaces.get(bestMatch);
    
    // 三重阈值验证
    const isZScoreValid = bestZScore < 0.85;                    // Z-score阈值
    const isSimilarityValid = bestSimilarity > 0.75;           // 相似度阈值
    const isInternalValid = bestSimilarity > (faceData.minSimilarity * 0.85); // 内部一致性
    
    if (isZScoreValid && isSimilarityValid && isInternalValid) {
      // 更新连续匹配计数
      const currentCount = this.consecutiveMatches.get(bestMatch) + 1;
      this.consecutiveMatches.set(bestMatch, currentCount);
      
      // 重置其他用户的计数
      for (const [name] of this.consecutiveMatches) {
        if (name !== bestMatch) {
          this.consecutiveMatches.set(name, 0);
        }
      }
      
      // 计算综合置信度
      const confidence = Math.min(0.99, 0.7 * (1 - bestZScore) + 0.3 * bestSimilarity);
      
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: confidence,
        consecutiveMatches: currentCount,
        isConfirmed: currentCount >= this.REQUIRED_CONSECUTIVE,
        securityLevel: this.getSecurityLevel(confidence, bestZScore, bestSimilarity)
      };
    } else {
      // 验证失败，重置该用户的计数
      this.consecutiveMatches.set(bestMatch, 0);
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: 0,
        consecutiveMatches: 0,
        isConfirmed: false,
        securityLevel: 'low',
        reason: !isZScoreValid ? 'Z-score过高' : !isSimilarityValid ? '相似度不足' : '内部不一致'
      };
    }
  }
  
  // 获取安全等级
  getSecurityLevel(confidence, zScore, similarity) {
    if (confidence > 0.85 && zScore < 0.7 && similarity > 0.8) return 'high';
    if (confidence > 0.75 && zScore < 0.8 && similarity > 0.75) return 'medium';
    return 'low';
  }
  
  // 获取状态
  getStatus() {
    const status = {};
    for (const [name, count] of this.consecutiveMatches) {
      status[name] = { consecutiveMatches: count };
    }
    return status;
  }
}

// ===============================
// 已知用户数据（需要从collector复制过来）
// ===============================
const KNOWN_DATA = [
{
  "name": "Cyril",
  "embeddings": [
    [
      -0.030268773436546326,
      0.028647685423493385,
      0.01344209536910057,
      0.01286239828914404,
      -0.05328315496444702,
      -0.033739618957042694,
      -0.017431795597076416,
      -0.12948891520500183,
      0.15640045702457428,
      -0.10953832417726517,
      0.21125805377960205,
      -0.1011425331234932,
      -0.19313234090805054,
      -0.0873982310295105,
      -0.07060094177722931,
      0.15554986894130707,
      -0.1680256724357605,
      -0.06839926540851593,
      -0.011241062544286251,
      -0.06280922889709473,
      0.11522802710533142,
      0.023751074448227882,
      0.008999128825962543,
      0.006107529625296593,
      -0.05456728860735893,
      -0.34165722131729126,
      -0.12414059787988663,
      -0.11688133329153061,
      0.037949394434690475,
      -0.05494740232825279,
      -0.05497774854302406,
      0.032082416117191315,
      -0.13351483643054962,
      -0.0696297213435173,
      0.01866559498012066,
      0.0635366439819336,
      -0.06226274371147156,
      -0.08735348284244537,
      0.1922575831413269,
      -0.06903683394193649,
      -0.16101424396038055,
      -0.02251879870891571,
      0.0838487520813942,
      0.19623294472694397,
      0.13233834505081177,
      0.10926711559295654,
      -0.0014434176264330745,
      -0.13936185836791992,
      0.07966047525405884,
      -0.10907036066055298,
      -0.0009039062424562871,
      0.13569988310337067,
      0.05454001575708389,
      0.08564140647649765,
      0.012534994632005692,
      -0.0827929675579071,
      0.05608491227030754,
      0.10106652975082397,
      -0.1459062546491623,
      0.011933310888707638,
      0.0840742215514183,
      -0.14005586504936218,
      -0.011919867247343063,
      -0.017654044553637505,
      0.26745423674583435,
      0.02380295656621456,
      -0.07342637330293655,
      -0.13934455811977386,
      0.1114729568362236,
      -0.18219052255153656,
      -0.11589819192886353,
      0.025648655369877815,
      -0.12330900877714157,
      -0.18875983357429504,
      -0.29310062527656555,
      0.025279585272073746,
      0.4178767502307892,
      0.09791756421327591,
      -0.10453025996685028,
      0.10237526893615723,
      -0.006656228564679623,
      -0.02167689986526966,
      0.23499706387519836,
      0.15689967572689056,
      -0.014106032438576221,
      -0.013078604824841022,
      -0.1016121357679367,
      -0.0009086659993045032,
      0.21012894809246063,
      -0.0981745719909668,
      -0.04057697206735611,
      0.13965092599391937,
      -0.06732824444770813,
      0.09152331948280334,
      -0.0017100190743803978,
      -0.004551464691758156,
      -0.053703244775533676,
      0.10488340258598328,
      -0.06816526502370834,
      -0.001762805157341063,
      0.1473008245229721,
      -0.01594366319477558,
      0.03262059763073921,
      0.0980275422334671,
      -0.13329000771045685,
      0.0526217520236969,
      -0.027197085320949554,
      -0.0012321195099502802,
      0.0793541818857193,
      -0.06947111338376999,
      -0.1231866106390953,
      -0.03641374409198761,
      0.1533123254776001,
      -0.24059659242630005,
      0.20803898572921753,
      0.151210218667984,
      0.03300841525197029,
      0.14990770816802979,
      0.10588192939758301,
      0.11370005458593369,
      -0.002847386756911874,
      -0.05454271659255028,
      -0.28175491094589233,
      0.0003333764907438308,
      0.12195725739002228,
      0.01770901493728161,
      0.1111929714679718,
      -0.023971227928996086
    ],
    [
      -0.07335467636585236,
      0.031642843037843704,
      0.02647409215569496,
      -0.010745400562882423,
      -0.027621887624263763,
      -0.040966182947158813,
      -0.03546059504151344,
      -0.1127304881811142,
      0.16464844346046448,
      -0.12756143510341644,
      0.21750374138355255,
      -0.04455522447824478,
      -0.2027471512556076,
      -0.08563622832298279,
      -0.08440199494361877,
      0.1591450273990631,
      -0.19916404783725739,
      -0.07553622871637344,
      -0.03340878337621689,
      -0.03912533074617386,
      0.13770191371440887,
      0.037954553961753845,
      0.023356223478913307,
      -0.0019157975912094116,
      -0.06898852437734604,
      -0.3137155771255493,
      -0.11895276606082916,
      -0.10066892951726913,
      0.06067734584212303,
      -0.04083731025457382,
      -0.04931316524744034,
      0.008156895637512207,
      -0.15866310894489288,
      -0.06279297918081284,
      0.01877257414162159,
      0.0929538756608963,
      -0.02331276796758175,
      -0.07568824291229248,
      0.1828155666589737,
      -0.0827869400382042,
      -0.17732729017734528,
      0.006496824324131012,
      0.07642851769924164,
      0.2235630303621292,
      0.16869671642780304,
      0.07491444051265717,
      -0.023440882563591003,
      -0.13708211481571198,
      0.08523385971784592,
      -0.17026017606258392,
      0.03391656279563904,
      0.1119803711771965,
      0.06511066854000092,
      0.1098237857222557,
      -0.0013265659799799323,
      -0.09909051656723022,
      0.07492755353450775,
      0.1342179924249649,
      -0.17482353746891022,
      0.01024538278579712,
      0.08531706780195236,
      -0.15105469524860382,
      -0.0009479975560680032,
      0.007693313993513584,
      0.2547672986984253,
      0.062232304364442825,
      -0.11138278245925903,
      -0.1784939020872116,
      0.0870516449213028,
      -0.20076191425323486,
      -0.07390184700489044,
      0.04959738999605179,
      -0.12934158742427826,
      -0.1542588174343109,
      -0.31988662481307983,
      0.02040848694741726,
      0.40549710392951965,
      0.08746141195297241,
      -0.10975410789251328,
      0.09839104861021042,
      -0.020339690148830414,
      -0.011361046694219112,
      0.21779830753803253,
      0.16237129271030426,
      -0.0011146561009809375,
      -0.020717430859804153,
      -0.103927381336689,
      0.02786046452820301,
      0.2088644802570343,
      -0.08394154906272888,
      -0.0456421859562397,
      0.16728992760181427,
      -0.03389541432261467,
      0.06928416341543198,
      0.0016150525771081448,
      0.03571077063679695,
      -0.047783806920051575,
      0.06754998862743378,
      -0.07736995816230774,
      0.033585719764232635,
      0.0930604562163353,
      0.007327665574848652,
      0.01914314553141594,
      0.10793911665678024,
      -0.10818997770547867,
      0.06995987147092819,
      -0.029130494222044945,
      0.010810519568622112,
      0.08291086554527283,
      -0.09075456857681274,
      -0.09592828154563904,
      -0.05423247814178467,
      0.12530183792114258,
      -0.24005281925201416,
      0.22958682477474213,
      0.15757636725902557,
      0.0483354851603508,
      0.1413838267326355,
      0.08139274269342422,
      0.09935452789068222,
      0.001691343612037599,
      -0.02567555382847786,
      -0.2693488597869873,
      0.019177738577127457,
      0.10196748375892639,
      -0.01129657682031393,
      0.11746160686016083,
      -0.024161946028470993
    ],
    [
      -0.048830993473529816,
      0.05819302424788475,
      0.03308723866939545,
      0.034542303532361984,
      -0.05050688982009888,
      -0.008126643486320972,
      -0.04164491221308708,
      -0.12825682759284973,
      0.12876182794570923,
      -0.1285407692193985,
      0.19944463670253754,
      -0.06390867382287979,
      -0.2169262319803238,
      -0.07076315581798553,
      -0.10401453077793121,
      0.14948371052742004,
      -0.18236558139324188,
      -0.07955826818943024,
      -0.0208780188113451,
      -0.04880645126104355,
      0.13485859334468842,
      0.025516556575894356,
      0.04496947303414345,
      -0.002826786134392023,
      -0.0805281326174736,
      -0.31412822008132935,
      -0.12286198884248734,
      -0.1296941488981247,
      0.02318066917359829,
      -0.051515914499759674,
      -0.05721012502908707,
      0.0445159375667572,
      -0.16592475771903992,
      -0.04542146250605583,
      -0.016923675313591957,
      0.07837284356355667,
      -0.039746515452861786,
      -0.045866597443819046,
      0.20112714171409607,
      -0.021494587883353233,
      -0.1757102608680725,
      0.003007733728736639,
      0.041481878608465195,
      0.241215780377388,
      0.17256513237953186,
      0.04753422364592552,
      -0.010982263833284378,
      -0.13171260058879852,
      0.0786328986287117,
      -0.13152186572551727,
      0.045292675495147705,
      0.16988205909729004,
      0.0783974826335907,
      0.11538983136415482,
      -0.00035875861067324877,
      -0.07439637929201126,
      0.07637369632720947,
      0.10205043107271194,
      -0.1115197241306305,
      0.03262036666274071,
      0.12332788854837418,
      -0.1396084576845169,
      0.04280891269445419,
      0.00564563786610961,
      0.2387315034866333,
      0.019716838374733925,
      -0.07754576206207275,
      -0.15387868881225586,
      0.1005026251077652,
      -0.1703057587146759,
      -0.10178316384553909,
      0.04493384808301926,
      -0.16313335299491882,
      -0.17439769208431244,
      -0.3256150186061859,
      0.048904284834861755,
      0.422500342130661,
      0.11458456516265869,
      -0.10686258226633072,
      0.0855158269405365,
      -0.039179109036922455,
      -0.044602666050195694,
      0.22422459721565247,
      0.19140227138996124,
      -0.005667489487677813,
      0.0011214574333280325,
      -0.0995858758687973,
      0.04362471401691437,
      0.20471583306789398,
      -0.09192699193954468,
      -0.06394661962985992,
      0.1830184906721115,
      -0.049611084163188934,
      0.08121483772993088,
      0.02124081179499626,
      0.003241793718189001,
      -0.05133875459432602,
      0.07916891574859619,
      -0.10107819736003876,
      0.02834133803844452,
      0.04802113026380539,
      -0.03637567162513733,
      -0.0018843578873202205,
      0.10030606389045715,
      -0.08692696690559387,
      0.04240656644105911,
      -0.031280189752578735,
      0.013910513371229172,
      0.031766392290592194,
      -0.08085992932319641,
      -0.15793423354625702,
      -0.04485638067126274,
      0.15339697897434235,
      -0.2087351530790329,
      0.20771382749080658,
      0.14720110595226288,
      0.05723188817501068,
      0.11074363440275192,
      0.14632365107536316,
      0.1201070249080658,
      -0.003979475237429142,
      -0.04557454586029053,
      -0.2693323493003845,
      0.02929435297846794,
      0.13319720327854156,
      0.013486895710229874,
      0.09265552461147308,
      -0.017542414367198944
    ],
    [
      -0.062437281012535095,
      0.0510617271065712,
      0.0697004646062851,
      -0.02694583684206009,
      -0.07442958652973175,
      -0.05233873799443245,
      -0.01896311156451702,
      -0.1623561680316925,
      0.14173220098018646,
      -0.15856027603149414,
      0.26181748509407043,
      -0.08734527975320816,
      -0.2189723551273346,
      -0.07657910883426666,
      -0.07929664850234985,
      0.15464916825294495,
      -0.21231257915496826,
      -0.07605396211147308,
      0.013099683448672295,
      -0.021877802908420563,
      0.10763698816299438,
      -0.008925816975533962,
      0.04753122851252556,
      0.021833689883351326,
      -0.04515402391552925,
      -0.3563232421875,
      -0.14584313333034515,
      -0.1027926653623581,
      0.09797828644514084,
      -0.05755433440208435,
      -0.0641886368393898,
      0.011942587792873383,
      -0.1775263547897339,
      -0.06952620297670364,
      -0.01869986020028591,
      0.059482309967279434,
      -0.06611678004264832,
      -0.06487500667572021,
      0.2016461193561554,
      -0.01440829411149025,
      -0.17416802048683167,
      -0.0068980674259364605,
      0.02782038040459156,
      0.20799832046031952,
      0.15243081748485565,
      0.12912486493587494,
      0.006494431756436825,
      -0.13849256932735443,
      0.051419928669929504,
      -0.160281240940094,
      0.029210399836301804,
      0.13788028061389923,
      0.07255421578884125,
      0.07580609619617462,
      0.03966513276100159,
      -0.1428707242012024,
      0.04615137726068497,
      0.08568732440471649,
      -0.15417934954166412,
      0.03329260274767876,
      0.060517553240060806,
      -0.0641685277223587,
      0.07266665250062943,
      -0.0005583788151852787,
      0.24326476454734802,
      0.016800910234451294,
      -0.07389769703149796,
      -0.10399499535560608,
      0.11615698039531708,
      -0.18566416203975677,
      -0.06244344636797905,
      0.0693167895078659,
      -0.11826225370168686,
      -0.1966499388217926,
      -0.26542213559150696,
      0.01730186864733696,
      0.4054642915725708,
      0.12353372573852539,
      -0.08441075682640076,
      0.04086300730705261,
      -0.020662996917963028,
      -0.08735548704862595,
      0.1972460299730301,
      0.13236676156520844,
      -0.02211281657218933,
      -0.004607520531862974,
      -0.08291973173618317,
      0.014390519820153713,
      0.17859730124473572,
      -0.09447502344846725,
      -0.014213407412171364,
      0.2116139829158783,
      -0.07133877277374268,
      0.08329839259386063,
      -0.0077718342654407024,
      0.004602254834026098,
      -0.07337832450866699,
      0.1129162609577179,
      -0.07240854203701019,
      -0.003722642082720995,
      0.07409081608057022,
      -0.0439293347299099,
      0.01114851888269186,
      0.08913778513669968,
      -0.17137211561203003,
      0.0428808256983757,
      -0.04567325860261917,
      -0.03817901015281677,
      0.009718288667500019,
      -0.07241801917552948,
      -0.139055997133255,
      -0.023271212354302406,
      0.1549486219882965,
      -0.2629978358745575,
      0.2326839715242386,
      0.23707489669322968,
      0.011866630986332893,
      0.13047175109386444,
      0.0994192510843277,
      0.049035415053367615,
      0.0212902519851923,
      -0.07711366564035416,
      -0.21694639325141907,
      -0.004878982901573181,
      0.10827286541461945,
      -0.04471124708652496,
      0.09362475574016571,
      -0.04071667417883873
    ],
    [
      -0.03831572085618973,
      0.03862052783370018,
      0.04081284999847412,
      0.04298919811844826,
      -0.03320585936307907,
      -0.048792995512485504,
      -0.0023020170629024506,
      -0.14647510647773743,
      0.1317199021577835,
      -0.08662936836481094,
      0.22810207307338715,
      -0.08434031158685684,
      -0.20663666725158691,
      -0.0886278972029686,
      -0.09726091474294662,
      0.16283659636974335,
      -0.18086101114749908,
      -0.05799480155110359,
      -0.004483983851969242,
      -0.04395922273397446,
      0.1261056810617447,
      0.03987612947821617,
      0.03043436072766781,
      0.0062402645125985146,
      -0.06468711048364639,
      -0.2931394577026367,
      -0.0903611034154892,
      -0.12428783625364304,
      0.04948481172323227,
      -0.053206104785203934,
      -0.052506472915410995,
      0.03482101485133171,
      -0.1556372493505478,
      -0.06302376091480255,
      0.008266596123576164,
      0.036512602120637894,
      -0.06752034276723862,
      -0.08230780065059662,
      0.18736402690410614,
      -0.05663912743330002,
      -0.1768011599779129,
      -0.012217666953802109,
      0.07022300362586975,
      0.2231825888156891,
      0.16167603433132172,
      0.08553333580493927,
      -0.00784249510616064,
      -0.13701117038726807,
      0.057173553854227066,
      -0.1548953503370285,
      -0.007860294543206692,
      0.09432022273540497,
      0.058850858360528946,
      0.07696512341499329,
      -0.027439525350928307,
      -0.13043947517871857,
      0.025082778185606003,
      0.054776955395936966,
      -0.1552697867155075,
      0.009171280078589916,
      0.09155979752540588,
      -0.13548187911510468,
      -0.007263828534632921,
      -0.02348117157816887,
      0.2448575496673584,
      0.010777335613965988,
      -0.10609357804059982,
      -0.11401501297950745,
      0.07933682948350906,
      -0.20804473757743835,
      -0.08214737474918365,
      0.04517196863889694,
      -0.09756913036108017,
      -0.1863386183977127,
      -0.3069697618484497,
      0.02641899324953556,
      0.42606881260871887,
      0.08406481891870499,
      -0.10354923456907272,
      0.08053138107061386,
      -0.0007344492478296161,
      -0.011567809619009495,
      0.19971387088298798,
      0.17215052247047424,
      -0.013346199877560139,
      0.02151843160390854,
      -0.09304224699735641,
      -0.00392554746940732,
      0.1855282336473465,
      -0.10979814827442169,
      -0.05139343813061714,
      0.15934079885482788,
      -0.06452358514070511,
      0.06041915342211723,
      0.007003675680607557,
      0.010592899285256863,
      -0.050398509949445724,
      0.09090475738048553,
      -0.07384995371103287,
      0.014433790929615498,
      0.0810680016875267,
      -0.028156211599707603,
      0.03749684989452362,
      0.08975082635879517,
      -0.11672957241535187,
      0.081141896545887,
      -0.023177707567811012,
      -0.013671726919710636,
      0.06812454015016556,
      -0.08720917254686356,
      -0.12372108548879623,
      -0.03193635493516922,
      0.13664236664772034,
      -0.23203836381435394,
      0.19882068037986755,
      0.14823958277702332,
      0.059993546456098557,
      0.16111867129802704,
      0.10094160586595535,
      0.1075703427195549,
      -0.016859523952007294,
      -0.009843479841947556,
      -0.24982663989067078,
      -0.0022917529568076134,
      0.12488796561956406,
      -0.015456578694283962,
      0.1361323893070221,
      -0.037152621895074844
    ],
    [
      -0.03821755573153496,
      0.06024850159883499,
      0.023968975991010666,
      0.035389967262744904,
      -0.054733309894800186,
      -0.03216995671391487,
      -0.029504872858524323,
      -0.13887687027454376,
      0.10148978978395462,
      -0.130928173661232,
      0.20325490832328796,
      -0.10568917542695999,
      -0.20618444681167603,
      -0.104855477809906,
      -0.07525531202554703,
      0.18032382428646088,
      -0.22416366636753082,
      -0.08594813942909241,
      -0.025908373296260834,
      -0.05957465618848801,
      0.10899809747934341,
      0.03925075754523277,
      0.024649647995829582,
      0.0001906559627968818,
      -0.08961032330989838,
      -0.34036463499069214,
      -0.1097746193408966,
      -0.10579390823841095,
      0.08490119874477386,
      -0.07674167305231094,
      -0.03455153852701187,
      0.005538573954254389,
      -0.16189336776733398,
      -0.03460628166794777,
      0.025052985176444054,
      0.025515787303447723,
      -0.06586701422929764,
      -0.09727870672941208,
      0.19190162420272827,
      -0.04191328212618828,
      -0.1658075898885727,
      -0.05069626867771149,
      0.06499264389276505,
      0.21317344903945923,
      0.1383441537618637,
      0.05758930742740631,
      -0.007765916641801596,
      -0.14162150025367737,
      0.08207806199789047,
      -0.15049418807029724,
      0.006850928533822298,
      0.1186232715845108,
      0.038861919194459915,
      0.12106423079967499,
      0.013325506821274757,
      -0.07896005362272263,
      0.023298509418964386,
      0.11680879443883896,
      -0.12411189079284668,
      0.02700132504105568,
      0.054382890462875366,
      -0.11498335748910904,
      -0.00326622580178082,
      -0.027804726734757423,
      0.24174539744853973,
      0.013830726966261864,
      -0.08559092879295349,
      -0.14785662293434143,
      0.11626120656728745,
      -0.17389579117298126,
      -0.08730975538492203,
      0.05609429255127907,
      -0.07984976470470428,
      -0.161249577999115,
      -0.2968567907810211,
      0.0010028729448094964,
      0.435390442609787,
      0.0842103511095047,
      -0.10944647341966629,
      0.04242868721485138,
      -0.019375359639525414,
      -0.04598509892821312,
      0.2178921401500702,
      0.14961197972297668,
      -0.02325400523841381,
      -0.015149224549531937,
      -0.05923353135585785,
      0.03809081017971039,
      0.21812602877616882,
      -0.10527659207582474,
      -0.06594689190387726,
      0.15100552141666412,
      -0.06824880838394165,
      0.0764320120215416,
      0.018436014652252197,
      -0.0075255692936480045,
      -0.053387392312288284,
      0.07514788955450058,
      -0.05183976888656616,
      -0.007668676786124706,
      0.11415017396211624,
      -0.04412795975804329,
      0.019566303119063377,
      0.10821051150560379,
      -0.0914313793182373,
      0.076969675719738,
      0.013457559049129486,
      -0.007140960544347763,
      0.09202536195516586,
      -0.03209230303764343,
      -0.16057761013507843,
      -0.04900497570633888,
      0.14257235825061798,
      -0.2499571591615677,
      0.23932397365570068,
      0.16303183138370514,
      0.030211003497242928,
      0.13434618711471558,
      0.08297749608755112,
      0.10964109748601913,
      -0.020857656374573708,
      -0.050956424325704575,
      -0.2121484875679016,
      -0.010735295712947845,
      0.1312815546989441,
      0.009093514643609524,
      0.08884648233652115,
      -0.0692068561911583
    ],
    [
      -0.036851074546575546,
      0.0362141877412796,
      0.03480745479464531,
      0.005763339344412088,
      -0.04264277592301369,
      -0.028367461636662483,
      -0.04701301455497742,
      -0.14242061972618103,
      0.13129928708076477,
      -0.1435828059911728,
      0.2422138899564743,
      -0.0817480981349945,
      -0.19704432785511017,
      -0.10562120378017426,
      -0.06341569125652313,
      0.15009136497974396,
      -0.20170341432094574,
      -0.061533257365226746,
      0.005833344534039497,
      -0.05778671056032181,
      0.11532440036535263,
      -0.009889957495033741,
      -0.011297903954982758,
      -0.006030770484358072,
      -0.04538963362574577,
      -0.3198257386684418,
      -0.13333511352539062,
      -0.09710811823606491,
      0.09011384844779968,
      -0.0636463537812233,
      -0.05883370339870453,
      0.00964067131280899,
      -0.15082396566867828,
      -0.05251485854387283,
      0.006673465948551893,
      0.04523313790559769,
      -0.042286425828933716,
      -0.06094108894467354,
      0.1709643453359604,
      -0.07477010786533356,
      -0.15867361426353455,
      -0.012762365862727165,
      0.0529455803334713,
      0.19928258657455444,
      0.15977786481380463,
      0.08246586471796036,
      -0.006130183581262827,
      -0.12858158349990845,
      0.09208149462938309,
      -0.13209664821624756,
      0.006497349124401808,
      0.14498570561408997,
      0.08184599876403809,
      0.0848531424999237,
      0.006529719568789005,
      -0.09562651067972183,
      0.035823382437229156,
      0.10505035519599915,
      -0.14862194657325745,
      0.034554824233055115,
      0.07974449545145035,
      -0.1261560022830963,
      -0.00040091772098094225,
      0.00687810406088829,
      0.23101773858070374,
      0.02560599520802498,
      -0.0940404012799263,
      -0.1802997589111328,
      0.09866410493850708,
      -0.194546639919281,
      -0.07508397102355957,
      0.0461602509021759,
      -0.12312498688697815,
      -0.18271097540855408,
      -0.3048182725906372,
      0.02414313517510891,
      0.4028397798538208,
      0.08765637874603271,
      -0.10264457017183304,
      0.10426434129476547,
      -0.026212342083454132,
      -0.04570290446281433,
      0.21601007878780365,
      0.14597199857234955,
      -0.010777194984257221,
      -0.005466918461024761,
      -0.08019634336233139,
      0.013049581088125706,
      0.19436517357826233,
      -0.10196098685264587,
      -0.027211308479309082,
      0.16588567197322845,
      -0.08160030096769333,
      0.07068293541669846,
      -0.004172260873019695,
      0.017223911359906197,
      -0.04699501022696495,
      0.07581361383199692,
      -0.05420128256082535,
      -0.007122555281966925,
      0.10583997517824173,
      -0.0485495887696743,
      0.031477637588977814,
      0.09535297751426697,
      -0.14858253300189972,
      0.07303537428379059,
      -0.03194747120141983,
      0.025412296876311302,
      0.07076948881149292,
      -0.07306211441755295,
      -0.12798602879047394,
      -0.03407599404454231,
      0.15374712646007538,
      -0.26545363664627075,
      0.21813242137432098,
      0.1783386766910553,
      0.04500718414783478,
      0.12660370767116547,
      0.10111814737319946,
      0.08818382024765015,
      0.00871102325618267,
      -0.06110618636012077,
      -0.22942304611206055,
      0.00009644100646255538,
      0.0801253616809845,
      -0.011721981689333916,
      0.08066973090171814,
      -0.04810275882482529
    ]
  ],
  "sample_count": 7,
  "collected_at": "2025-12-10T07:54:44.402Z",
  "angles_collected": [
    "正面",
    "左转",
    "右转",
    "抬头",
    "低头",
    "微笑",
    "中性"
  ],
  "average_quality": "high",
  "note": "增强版多角度采集数据"
}
];

// ===============================
// 主程序
// ===============================
let faceVerifier = null;
let isRecognizing = false;
let modelsLoaded = false;
let hasSignedIn = false;
let isSubmitting = false;

// DOM 元素引用
const videoElement = document.getElementById('video');
const statusEl = document.getElementById('status');
const recognitionInfoEl = document.getElementById('recognitionInfo');
const recognizedNameEl = document.getElementById('recognizedName');
const recognitionConfidenceEl = document.getElementById('recognitionConfidence');
const recognitionSimilarityEl = document.getElementById('recognitionSimilarity');
const consecutiveMatchesEl = document.getElementById('consecutiveMatches');
const zScoreEl = document.getElementById('zScore');
const recognitionStatusEl = document.getElementById('recognitionStatus');
const signinSuccessEl = document.getElementById('signinSuccess');
const successNameEl = document.getElementById('successName');
const successTimeEl = document.getElementById('successTime');
const securityLevelEl = document.getElementById('securityLevel');

// 页面加载后执行
window.addEventListener('load', async () => {
  try {
    statusEl.textContent = '正在初始化增强版人脸识别系统...';
    statusEl.className = 'loading';
    
    // 1. 检查face-api.js
    await checkFaceAPI();
    
    // 2. 启动摄像头
    await startCamera();
    
    // 3. 加载模型
    await loadModels();
    
    // 4. 初始化增强验证器
    faceVerifier = new EnhancedFaceVerifier();
    
    // 5. 加载已知人脸数据
    await loadKnownFaces();
    
    modelsLoaded = true;
    statusEl.textContent = '✓ 增强版系统已就绪！开始识别...';
    statusEl.className = 'success';
    
    // 显示识别信息区域
    recognitionInfoEl.style.display = 'block';
    
    // 开始识别循环
    recognizeLoop();
    
  } catch (error) {
    console.error('初始化失败:', error);
    statusEl.textContent = '初始化失败: ' + error.message;
    statusEl.className = 'error';
  }
});

// 检查 faceapi 是否加载
function checkFaceAPI() {
  return new Promise((resolve, reject) => {
    if (window.faceapi) {
      console.log('faceapi 已加载');
      resolve();
      return;
    }
    
    let attempts = 0;
    const maxAttempts = 30;
    const interval = setInterval(() => {
      attempts++;
      if (window.faceapi) {
        clearInterval(interval);
        console.log('faceapi 加载成功');
        resolve();
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        reject(new Error('face-api.js 加载超时'));
      }
    }, 100);
  });
}

// 启动摄像头
async function startCamera() {
  try {
    statusEl.textContent = '正在请求摄像头权限...';
    statusEl.className = 'loading';
    
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: 640, 
        height: 480,
        facingMode: "user" 
      } 
    });
    
    videoElement.srcObject = stream;
    
    return new Promise((resolve) => {
      videoElement.onloadedmetadata = () => {
        videoElement.play();
        console.log('摄像头启动完成');
        resolve();
      };
    });
  } catch (error) {
    console.error('摄像头错误:', error);
    throw new Error('无法访问摄像头: ' + error.message);
  }
}

// 加载模型
async function loadModels() {
  try {
    statusEl.textContent = '正在加载人脸识别模型...';
    statusEl.className = 'loading';
    
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
    
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    
    console.log('所有模型加载成功');
    
  } catch (error) {
    console.error('模型加载失败:', error);
    throw new Error('模型加载失败: ' + error.message);
  }
}

// 加载已知人脸数据
async function loadKnownFaces() {
  try {
    statusEl.textContent = '正在加载已知人脸数据...';
    
    // 支持两种格式：旧格式（单样本）和新格式（多样本）
    KNOWN_DATA.forEach(person => {
      if (person.embeddings && Array.isArray(person.embeddings[0])) {
        // 新格式：多样本
        faceVerifier.addKnownFace(person.name, person.embeddings);
      } else if (person.embedding) {
        // 旧格式：单样本
        faceVerifier.addKnownFace(person.name, person.embedding);
      } else {
        console.warn('未知的数据格式:', person);
      }
    });
    
    const userCount = faceVerifier.knownFaces.size;
    console.log(`已加载 ${userCount} 个用户数据`);
    statusEl.textContent = `✓ 已加载 ${userCount} 个用户数据`;
    
  } catch (error) {
    console.error('加载人脸数据失败:', error);
    throw new Error('人脸数据加载失败: ' + error.message);
  }
}

// 增强版识别循环
async function recognizeLoop() {
  if (!modelsLoaded || isRecognizing || hasSignedIn) return;
  
  try {
    isRecognizing = true;
    
    // 检测人脸（提高检测阈值）
    const detection = await faceapi
      .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions({
        inputSize: 320,
        scoreThreshold: 0.6
      }))
      .withFaceLandmarks()
      .withFaceDescriptor();
    
    if (detection && detection.detection.score > 0.7) {
      // 使用增强验证器
      const result = faceVerifier.verifyFace(detection.descriptor);
      
      if (result && result.confidence > 0) {
        // 更新UI显示
        updateRecognitionUI(result);
        
        // 检查是否确认
        if (result.isConfirmed && result.confidence > 0.85 && !hasSignedIn) {
          hasSignedIn = true;
          showSignInSuccess(result.name, result);
          sendSignIn(result.name, result.confidence);
        }
        
        // 绘制检测框
        drawDetection(detection, result);
        
      } else {
        // 验证失败
        resetRecognitionUI();
        if (result && result.reason) {
          recognitionStatusEl.textContent = `验证失败: ${result.reason}`;
        } else {
          recognitionStatusEl.textContent = '验证失败';
        }
        recognitionStatusEl.style.color = 'red';
      }
      
    } else {
      // 未检测到人脸或质量太低
      resetRecognitionUI();
      if (detection) {
        recognitionStatusEl.textContent = `检测质量低: ${detection.detection.score.toFixed(3)}`;
      } else {
        recognitionStatusEl.textContent = '未检测到人脸';
      }
      recognitionStatusEl.style.color = 'orange';
    }
    
  } catch (error) {
    console.error('识别错误:', error);
    recognitionStatusEl.textContent = '识别错误: ' + error.message;
    recognitionStatusEl.style.color = 'red';
  } finally {
    isRecognizing = false;
    
    // 继续识别循环（如果未签到）
    if (!hasSignedIn) {
      setTimeout(recognizeLoop, 300);
    }
  }
}

// 更新识别UI
function updateRecognitionUI(result) {
  recognizedNameEl.textContent = result.name;
  recognitionConfidenceEl.textContent = result.confidence.toFixed(4);
  recognitionSimilarityEl.textContent = result.similarity.toFixed(4);
  consecutiveMatchesEl.textContent = `${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE}`;
  zScoreEl.textContent = result.zScore.toFixed(4);
  
  // 设置状态颜色
  if (result.isConfirmed) {
    recognitionStatusEl.textContent = '✓ 高置信度确认！';
    recognitionStatusEl.style.color = 'green';
  } else if (result.confidence > 0.8) {
    recognitionStatusEl.textContent = `✓ 匹配中... (${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE})`;
    recognitionStatusEl.style.color = 'orange';
  } else if (result.confidence > 0.7) {
    recognitionStatusEl.textContent = `低置信度，请保持姿势`;
    recognitionStatusEl.style.color = '#FF9800';
  } else {
    recognitionStatusEl.textContent = '置信度不足';
    recognitionStatusEl.style.color = 'red';
  }
}

// 重置识别UI
function resetRecognitionUI() {
  recognizedNameEl.textContent = '-';
  recognitionConfidenceEl.textContent = '-';
  recognitionSimilarityEl.textContent = '-';
  consecutiveMatchesEl.textContent = '0/3';
  zScoreEl.textContent = '-';
}

// 绘制检测框
function drawDetection(detection, result) {
  const oldCanvas = document.querySelector('canvas');
  if (oldCanvas) oldCanvas.remove();
  
  const canvas = faceapi.createCanvasFromMedia(videoElement);
  const container = document.querySelector('.video-container');
  container.appendChild(canvas);
  
  const displaySize = { width: videoElement.width, height: videoElement.height };
  faceapi.matchDimensions(canvas, displaySize);
  
  const resizedDetection = faceapi.resizeResults(detection, displaySize);
  
  // 设置边框颜色
  const borderColor = result.confidence > 0.85 ? '#00ff00' : 
                     result.confance > 0.75 ? '#ff9900' : '#ff0000';
  
  const ctx = canvas.getContext('2d');
  
  // 绘制检测框
  faceapi.draw.drawDetections(canvas, [resizedDetection]);
  faceapi.draw.drawFaceLandmarks(canvas, [resizedDetection]);
  
  // 添加文字标签
  ctx.font = '16px Arial';
  ctx.fillStyle = borderColor;
  ctx.fillText(`${result.name} (${(result.confidence*100).toFixed(1)}%)`, 
               resizedDetection.detection.box.x, 
               resizedDetection.detection.box.y - 10);
}

// 显示签到成功信息
function showSignInSuccess(name, result) {
  const now = new Date();
  successNameEl.textContent = name;
  successTimeEl.textContent = now.toLocaleString();
  
  // 设置安全等级显示
  const securityLevels = {
    high: { text: '高', class: 'security-high', color: '#4CAF50' },
    medium: { text: '中', class: 'security-medium', color: '#FFC107' },
    low: { text: '低', class: 'security-low', color: '#F44336' }
  };
  
  const level = securityLevels[result.securityLevel || 'medium'];
  securityLevelEl.textContent = level.text;
  securityLevelEl.style.color = level.color;
  
  // 隐藏识别信息区域，显示成功区域
  recognitionInfoEl.style.display = 'none';
  signinSuccessEl.style.display = 'block';
  
  // 停止摄像头
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
    videoElement.style.opacity = '0.3';
  }
  
  statusEl.textContent = `✓ ${name} 签到成功！安全等级: ${level.text}`;
  statusEl.className = 'success';
}

// 发送签到信息
function sendSignIn(name, confidence) {
  try {
    isSubmitting = true;
    
    document.getElementById("nameField").value = name;
    document.getElementById("timeField").value = new Date().toISOString();
    
    console.log('正在提交签到数据:', name, '置信度:', confidence);
    
    const iframe = document.getElementById('resultIframe');
    iframe.onload = function() {
      console.log('数据提交完成！');
      isSubmitting = false;
      
      // 显示成功消息
      setTimeout(() => {
        alert(`✓ 签到成功！\n姓名: ${name}\n置信度: ${(confidence*100).toFixed(1)}%\n数据已保存到Google表格`);
      }, 300);
    };
    
    // 提交表单
    document.getElementById("sendForm").submit();
    
  } catch (error) {
    console.error('提交失败:', error);
    statusEl.textContent = '提交失败: ' + error.message;
    statusEl.className = 'error';
    alert('签到提交失败，请手动记录。错误: ' + error.message);
    isSubmitting = false;
    hasSignedIn = false; // 允许重试
  }
}

// 添加页面卸载时的清理
window.addEventListener('beforeunload', () => {
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
  }
});

// 全局错误处理
window.addEventListener('error', (e) => {
  console.error('全局错误:', e.error);
  if (statusEl) {
    statusEl.textContent = '发生错误: ' + e.message;
    statusEl.className = 'error';
  }
});
</script>

</body>
</html>
