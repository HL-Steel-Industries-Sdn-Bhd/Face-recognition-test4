<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Sign In - 增强版</title>
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:20px; }
#video { width: 640px; height: 480px; border-radius:10px; }
#status { margin: 10px 0; font-weight: bold; font-size: 18px; }
.loading { color: blue; }
.success { color: green; }
.error { color: red; }
canvas { position: absolute; top: 0; left: 0; z-index: 10; }
.video-container { 
    position: relative; 
    display: inline-block; 
    margin-bottom: 20px;
}
#recognitionInfo {
    margin: 20px auto;
    padding: 15px;
    background-color: #f5f5f5;
    border-radius: 8px;
    max-width: 600px;
    text-align: left;
}
.signin-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 15px;
    margin: 20px auto;
    border-radius: 8px;
    max-width: 600px;
}
#resultIframe {
    display: none;
    width: 0;
    height: 0;
    border: 0;
}
.security-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}
.security-high { background-color: #4CAF50; }
.security-medium { background-color: #FFC107; }
.security-low { background-color: #F44336; }
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
}
.stat-item {
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-size: 14px;
}
</style>
</head>
<body>

<h2>会议签到 - 增强版人脸识别</h2>

<div class="video-container">
    <video id="video" width="640" height="480" autoplay muted></video>
</div>

<div id="status" class="loading">正在初始化增强版识别系统...</div>

<div id="recognitionInfo" style="display: none;">
    <h3>识别结果</h3>
    <p>姓名: <span id="recognizedName">-</span></p>
    <div class="stats-grid">
        <div class="stat-item">置信度: <span id="recognitionConfidence">-</span></div>
        <div class="stat-item">相似度: <span id="recognitionSimilarity">-</span></div>
        <div class="stat-item">连续匹配: <span id="consecutiveMatches">0/3</span></div>
        <div class="stat-item">Z-score: <span id="zScore">-</span></div>
    </div>
    <p>状态: <span id="recognitionStatus">正在初始化...</span></p>
</div>

<!-- 签到成功提示区域 -->
<div id="signinSuccess" class="signin-success" style="display: none;">
    <h3>✓ 签到成功！</h3>
    <p>姓名: <span id="successName">-</span></p>
    <p>时间: <span id="successTime">-</span></p>
    <p>安全等级: <span id="securityLevel">高</span> <span class="security-indicator security-high"></span></p>
    <p>数据已成功提交到Google表格</p>
</div>

<!-- 隐藏的表单和iframe -->
<iframe id="resultIframe" name="resultIframe"></iframe>
<form id="sendForm" method="post" target="resultIframe" 
      action="https://script.google.com/macros/s/AKfycbwredN437XGaJCdq8qH9dQPM2CkXNNIkPLFfvB8BMxqAvSv7Dd4WnlhIn5wXKY5nsZs/exec" 
      style="display: none;">
    <input type="hidden" name="name" id="nameField">
    <input type="hidden" name="timestamp" id="timeField">
</form>

<script>
// ===============================
// 增强版人脸验证器
// ===============================
class EnhancedFaceVerifier {
  constructor() {
    this.knownFaces = new Map();
    this.consecutiveMatches = new Map();
    this.REQUIRED_CONSECUTIVE = 3; // 需要连续3帧匹配
    this.lastVerificationTime = 0;
    this.verificationDelay = 300; // 毫秒
  }
  
  // 添加已知人脸（支持多样本）
  addKnownFace(name, embeddings) {
    if (!Array.isArray(embeddings[0])) {
      embeddings = [embeddings]; // 单样本转为数组
    }
    
    // 计算统计特征
    const mean = this.calculateMean(embeddings);
    const std = this.calculateStd(embeddings, mean);
    const minSimilarity = this.calculateMinSimilarity(embeddings);
    
    this.knownFaces.set(name, {
      name: name,
      embeddings: embeddings,
      mean: mean,
      std: std,
      minSimilarity: minSimilarity
    });
    
    this.consecutiveMatches.set(name, 0);
    console.log(`已加载用户: ${name}, 样本数: ${embeddings.length}, 内部相似度: ${minSimilarity.toFixed(4)}`);
  }
  
  // 计算均值向量
  calculateMean(embeddings) {
    const dimensions = embeddings[0].length;
    const mean = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        mean[i] += emb[i];
      }
    }
    
    return mean.map(val => val / embeddings.length);
  }
  
  // 计算标准差向量
  calculateStd(embeddings, mean) {
    const dimensions = embeddings[0].length;
    const variance = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        variance[i] += Math.pow(emb[i] - mean[i], 2);
      }
    }
    
    // 加一个小值防止除零
    return variance.map(val => Math.sqrt(val / embeddings.length) + 1e-8);
  }
  
  // 计算内部最小相似度
  calculateMinSimilarity(embeddings) {
    if (embeddings.length <= 1) return 0.9; // 单样本默认
    
    let minSim = 1;
    for (let i = 0; i < embeddings.length; i++) {
      for (let j = i + 1; j < embeddings.length; j++) {
        const sim = this.cosineSimilarity(embeddings[i], embeddings[j]);
        if (sim < minSim) minSim = sim;
      }
    }
    return minSim;
  }
  
  // 余弦相似度（更准确）
  cosineSimilarity(a, b) {
    let dot = 0, normA = 0, normB = 0;
    for (let i = 0; i < a.length; i++) {
      dot += a[i] * b[i];
      normA += a[i] * a[i];
      normB += b[i] * b[i];
    }
    return dot / (Math.sqrt(normA) * Math.sqrt(normB));
  }
  
  // Z-score标准化距离
  zScoreDistance(liveEmbedding, knownFace) {
    let totalZ = 0;
    const dimensions = liveEmbedding.length;
    
    for (let i = 0; i < dimensions; i++) {
      const z = Math.abs((liveEmbedding[i] - knownFace.mean[i]) / knownFace.std[i]);
      totalZ += z;
    }
    
    return totalZ / dimensions; // 平均Z-score
  }
  
  // 综合验证人脸
  verifyFace(liveEmbedding) {
    const now = Date.now();
    if (now - this.lastVerificationTime < this.verificationDelay) {
      return null; // 防止过于频繁验证
    }
    this.lastVerificationTime = now;
    
    let bestMatch = null;
    let bestScore = Infinity;
    let bestSimilarity = -1;
    let bestZScore = Infinity;
    
    // 遍历所有已知人脸
    for (const [name, faceData] of this.knownFaces) {
      // 计算Z-score距离
      const zScore = this.zScoreDistance(liveEmbedding, faceData);
      
      // 计算余弦相似度
      const similarity = this.cosineSimilarity(liveEmbedding, faceData.mean);
      
      // 综合得分（Z-score权重70%，相似度30%）
      const combinedScore = zScore * 0.7 + (1 - similarity) * 0.3;
      
      if (combinedScore < bestScore) {
        bestScore = combinedScore;
        bestSimilarity = similarity;
        bestZScore = zScore;
        bestMatch = name;
      }
    }
    
    if (!bestMatch) return null;
    
    const faceData = this.knownFaces.get(bestMatch);
    
    // 三重阈值验证
    const isZScoreValid = bestZScore < 0.85;                    // Z-score阈值
    const isSimilarityValid = bestSimilarity > 0.75;           // 相似度阈值
    const isInternalValid = bestSimilarity > (faceData.minSimilarity * 0.85); // 内部一致性
    
    if (isZScoreValid && isSimilarityValid && isInternalValid) {
      // 更新连续匹配计数
      const currentCount = this.consecutiveMatches.get(bestMatch) + 1;
      this.consecutiveMatches.set(bestMatch, currentCount);
      
      // 重置其他用户的计数
      for (const [name] of this.consecutiveMatches) {
        if (name !== bestMatch) {
          this.consecutiveMatches.set(name, 0);
        }
      }
      
      // 计算综合置信度
      const confidence = Math.min(0.99, 0.7 * (1 - bestZScore) + 0.3 * bestSimilarity);
      
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: confidence,
        consecutiveMatches: currentCount,
        isConfirmed: currentCount >= this.REQUIRED_CONSECUTIVE,
        securityLevel: this.getSecurityLevel(confidence, bestZScore, bestSimilarity)
      };
    } else {
      // 验证失败，重置该用户的计数
      this.consecutiveMatches.set(bestMatch, 0);
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: 0,
        consecutiveMatches: 0,
        isConfirmed: false,
        securityLevel: 'low',
        reason: !isZScoreValid ? 'Z-score过高' : !isSimilarityValid ? '相似度不足' : '内部不一致'
      };
    }
  }
  
  // 获取安全等级
  getSecurityLevel(confidence, zScore, similarity) {
    if (confidence > 0.85 && zScore < 0.7 && similarity > 0.8) return 'high';
    if (confidence > 0.75 && zScore < 0.8 && similarity > 0.75) return 'medium';
    return 'low';
  }
  
  // 获取状态
  getStatus() {
    const status = {};
    for (const [name, count] of this.consecutiveMatches) {
      status[name] = { consecutiveMatches: count };
    }
    return status;
  }
}

// ===============================
// 已知用户数据（需要从collector复制过来）
// ===============================
const KNOWN_DATA = [
{
  "name": "lalala",
  "embeddings": [
    [
      -0.061613719910383224,
      0.04128227382898331,
      0.034501537680625916,
      -0.006096209399402142,
      -0.025847967714071274,
      -0.048778485506772995,
      -0.058224983513355255,
      -0.15246804058551788,
      0.14639516174793243,
      -0.13222408294677734,
      0.2153090387582779,
      -0.061134908348321915,
      -0.1919485181570053,
      -0.083962082862854,
      -0.0680590346455574,
      0.1565442681312561,
      -0.19430875778198242,
      -0.05636860802769661,
      -0.017767511308193207,
      -0.03995174914598465,
      0.10809608548879623,
      0.022392861545085907,
      0.018187472596764565,
      0.008391386829316616,
      -0.06827783584594727,
      -0.2921791672706604,
      -0.1227201595902443,
      -0.0975862443447113,
      0.049107927829027176,
      -0.036172956228256226,
      -0.09152507036924362,
      0.018595736473798752,
      -0.1499839723110199,
      -0.07024576514959335,
      0.011546793393790722,
      0.10770168155431747,
      -0.06536198407411575,
      -0.07177900522947311,
      0.15852490067481995,
      -0.05487872287631035,
      -0.16173511743545532,
      0.02122385986149311,
      0.04422840476036072,
      0.21473829448223114,
      0.17930924892425537,
      0.11430691927671432,
      -0.013703898526728153,
      -0.11901777237653732,
      0.08065880835056305,
      -0.1770174503326416,
      0.004538489039987326,
      0.11290374398231506,
      0.06078432872891426,
      0.09085247665643692,
      0.006626704707741737,
      -0.12856315076351166,
      0.05393011495471001,
      0.06883987784385681,
      -0.1251406967639923,
      -0.00710249412804842,
      0.09750039875507355,
      -0.13381215929985046,
      0.010906850919127464,
      -0.0177269596606493,
      0.2698671221733093,
      0.04091993719339371,
      -0.1356971263885498,
      -0.12202414870262146,
      0.056417763233184814,
      -0.18321877717971802,
      -0.08984275162220001,
      0.03291253000497818,
      -0.11226507276296616,
      -0.16940021514892578,
      -0.3153342306613922,
      0.040886688977479935,
      0.4281511604785919,
      0.10658615082502365,
      -0.11918651312589645,
      0.08155008405447006,
      -0.02837940864264965,
      -0.011348441243171692,
      0.20824681222438812,
      0.1520247608423233,
      -0.0096952635794878,
      -0.00011703748896252364,
      -0.1036069244146347,
      -0.021291961893439293,
      0.19584159553050995,
      -0.0960293635725975,
      -0.039854880422353745,
      0.15855568647384644,
      -0.055234041064977646,
      0.10361137241125107,
      -0.012172273360192776,
      0.02384006977081299,
      -0.0654120221734047,
      0.07130233943462372,
      -0.0609070248901844,
      0.020991209894418716,
      0.10534600913524628,
      -0.018622729927301407,
      0.016854342073202133,
      0.1074816957116127,
      -0.12032727152109146,
      0.1019076332449913,
      -0.029415486380457878,
      0.013559367507696152,
      0.07728470116853714,
      -0.05951680988073349,
      -0.139982670545578,
      -0.036802928894758224,
      0.12893085181713104,
      -0.26581770181655884,
      0.20113132894039154,
      0.18228262662887573,
      0.03991043567657471,
      0.1459852010011673,
      0.12618790566921234,
      0.10390320420265198,
      -0.015460618771612644,
      0.011323303915560246,
      -0.25025126338005066,
      -0.03500431030988693,
      0.10832977294921875,
      -0.0017214127583429217,
      0.11937866359949112,
      -0.02083752676844597
    ],
    [
      -0.05298104137182236,
      0.045083917677402496,
      0.014665103517472744,
      -0.015945855528116226,
      -0.028178291395306587,
      -0.035937972366809845,
      -0.05758412927389145,
      -0.13863946497440338,
      0.1794314831495285,
      -0.1461130976676941,
      0.20024307072162628,
      -0.0377139113843441,
      -0.22125495970249176,
      -0.04441031813621521,
      -0.08873318135738373,
      0.1699320673942566,
      -0.1932966411113739,
      -0.08274917304515839,
      -0.046488743275403976,
      -0.017911532893776894,
      0.14704327285289764,
      0.025847241282463074,
      0.005158836022019386,
      -0.013303887099027634,
      -0.07452890276908875,
      -0.2938883900642395,
      -0.13047108054161072,
      -0.062142230570316315,
      0.02580108493566513,
      -0.038865827023983,
      -0.0820579081773758,
      0.02266252227127552,
      -0.14397168159484863,
      -0.040065471082925797,
      0.001258404809050262,
      0.09766530990600586,
      -0.046736013144254684,
      -0.07329641282558441,
      0.17341788113117218,
      -0.042754124850034714,
      -0.1970570832490921,
      0.02917560748755932,
      0.056563228368759155,
      0.21806952357292175,
      0.16341844201087952,
      0.09882102161645889,
      -0.003028406295925379,
      -0.12561462819576263,
      0.07033948600292206,
      -0.20092816650867462,
      0.013728917576372623,
      0.12652984261512756,
      0.07062193751335144,
      0.0900888666510582,
      0.018341509625315666,
      -0.15957024693489075,
      0.05727525055408478,
      0.09675882011651993,
      -0.12526489794254303,
      -0.005517005920410156,
      0.10073059797286987,
      -0.14653979241847992,
      0.014622730202972889,
      -0.009120997041463852,
      0.26094260811805725,
      0.053978871554136276,
      -0.12217651307582855,
      -0.12871190905570984,
      0.08430369198322296,
      -0.16352461278438568,
      -0.06106296926736832,
      0.026074247434735298,
      -0.1381949931383133,
      -0.188865527510643,
      -0.31445208191871643,
      0.02946842461824417,
      0.43528133630752563,
      0.09513816982507706,
      -0.09759879857301712,
      0.10628322511911392,
      -0.017885565757751465,
      0.0019411764806136489,
      0.20760872960090637,
      0.14567305147647858,
      -0.01689807139337063,
      0.0005985627067275345,
      -0.12778808176517487,
      0.025820890441536903,
      0.21090258657932281,
      -0.10951969772577286,
      -0.019929371774196625,
      0.16383454203605652,
      -0.03140150010585785,
      0.0866929292678833,
      -0.025402165949344635,
      0.027119256556034088,
      -0.051673270761966705,
      0.07198797911405563,
      -0.06740491092205048,
      0.05423358827829361,
      0.08317125588655472,
      -0.01018874254077673,
      0.013044402934610844,
      0.11187779158353806,
      -0.098879374563694,
      0.05717657506465912,
      -0.022729771211743355,
      0.0036564988549798727,
      0.05149151757359505,
      -0.059393804520368576,
      -0.12099739909172058,
      -0.06129646301269531,
      0.11115168780088425,
      -0.25133591890335083,
      0.18352589011192322,
      0.18156233429908752,
      0.02570147067308426,
      0.13941644132137299,
      0.09970267117023468,
      0.11664879322052002,
      -0.0010094167664647102,
      0.0027702045626938343,
      -0.2785643935203552,
      0.00048268423415720463,
      0.10431304574012756,
      0.012206388637423515,
      0.09327728301286697,
      -0.0013782979222014546
    ],
    [
      -0.05407414212822914,
      0.06375764310359955,
      0.02548837661743164,
      0.01959904097020626,
      -0.025880461558699608,
      -0.03254261985421181,
      -0.041928961873054504,
      -0.1629050076007843,
      0.14706209301948547,
      -0.12912103533744812,
      0.21314144134521484,
      -0.049134694039821625,
      -0.20005790889263153,
      -0.08372408151626587,
      -0.09135553240776062,
      0.15605348348617554,
      -0.19391880929470062,
      -0.09619954228401184,
      -0.006457164417952299,
      -0.05047259479761124,
      0.13593165576457977,
      0.02290649153292179,
      0.006042084656655788,
      0.0034127223771065474,
      -0.12269088625907898,
      -0.26827478408813477,
      -0.10553306341171265,
      -0.1087433472275734,
      0.015873942524194717,
      -0.03619128838181496,
      -0.08124350011348724,
      0.027187954634428024,
      -0.17409895360469818,
      -0.06722188740968704,
      0.01765442080795765,
      0.08198031038045883,
      -0.050078608095645905,
      -0.06604254245758057,
      0.19333960115909576,
      -0.034742072224617004,
      -0.16834808886051178,
      0.032542068511247635,
      0.05324412137269974,
      0.23634469509124756,
      0.14818257093429565,
      0.0813947319984436,
      -0.029268696904182434,
      -0.1376296430826187,
      0.08160829544067383,
      -0.16974885761737823,
      -0.0046046520583331585,
      0.14467310905456543,
      0.04259801656007767,
      0.09264113754034042,
      -0.018068227916955948,
      -0.1309083253145218,
      0.0646614283323288,
      0.05160773918032646,
      -0.13876193761825562,
      -0.0030049423221498728,
      0.10021007061004639,
      -0.16178569197654724,
      0.016065722331404686,
      -0.020255202427506447,
      0.2517845034599304,
      0.033813562244176865,
      -0.10990184545516968,
      -0.12269269675016403,
      0.06083540990948677,
      -0.16716107726097107,
      -0.0863756611943245,
      0.03245416656136513,
      -0.12167245149612427,
      -0.1790093332529068,
      -0.32963258028030396,
      0.03725865110754967,
      0.4431876242160797,
      0.111005499958992,
      -0.11885181814432144,
      0.09298014640808105,
      -0.028626644983887672,
      -0.009136829525232315,
      0.2317192107439041,
      0.15774540603160858,
      -0.006978974677622318,
      0.012496140785515308,
      -0.10345252603292465,
      0.01968620903789997,
      0.2115222066640854,
      -0.08730226755142212,
      -0.05990002676844597,
      0.15876324474811554,
      -0.052160296589136124,
      0.09818500280380249,
      0.011736233718693256,
      0.01856214366853237,
      -0.07626709342002869,
      0.06445890665054321,
      -0.08019082248210907,
      0.03495147079229355,
      0.07706241309642792,
      -0.008157996460795403,
      0.027069367468357086,
      0.12755656242370605,
      -0.10012073814868927,
      0.05775291472673416,
      -0.02086041122674942,
      -0.011450451798737049,
      0.041358280926942825,
      -0.05972142517566681,
      -0.1502135843038559,
      -0.04811398312449455,
      0.11091407388448715,
      -0.2411930114030838,
      0.21095390617847443,
      0.1576891541481018,
      0.036202628165483475,
      0.13822132349014282,
      0.13920342922210693,
      0.08711249381303787,
      -0.03501570597290993,
      0.005229394882917404,
      -0.2572912573814392,
      -0.020219851285219193,
      0.12630990147590637,
      0.005826051812618971,
      0.1492089182138443,
      -0.03651629760861397
    ],
    [
      -0.046354301273822784,
      0.049091048538684845,
      0.027590887621045113,
      0.007526146247982979,
      -0.03385838121175766,
      -0.04873017221689224,
      -0.045119792222976685,
      -0.1765281707048416,
      0.16219651699066162,
      -0.1620071828365326,
      0.2278163880109787,
      -0.059804122895002365,
      -0.20704586803913116,
      -0.08816001564264297,
      -0.0822189599275589,
      0.1650930643081665,
      -0.18966926634311676,
      -0.09329631179571152,
      -0.005962484981864691,
      -0.03320637345314026,
      0.13993938267230988,
      0.010653182864189148,
      0.017879098653793335,
      0.01636950671672821,
      -0.0994139090180397,
      -0.27869677543640137,
      -0.13875289261341095,
      -0.07961568236351013,
      0.023123061284422874,
      -0.051915060728788376,
      -0.0889245942234993,
      0.018493730574846268,
      -0.17549248039722443,
      -0.07401426136493683,
      -0.001661797403357923,
      0.0770331621170044,
      -0.05802953988313675,
      -0.08179450780153275,
      0.1723099797964096,
      -0.056325122714042664,
      -0.17623654007911682,
      0.015363258309662342,
      0.055443018674850464,
      0.20981600880622864,
      0.16220295429229736,
      0.0803767591714859,
      -0.02020234987139702,
      -0.141731858253479,
      0.06803998351097107,
      -0.15840497612953186,
      -0.005626602564007044,
      0.1261853128671646,
      0.0669906735420227,
      0.08504104614257812,
      -0.015214739367365837,
      -0.13216567039489746,
      0.03818529099225998,
      0.09359066188335419,
      -0.10101640969514847,
      0.008409596048295498,
      0.09640464186668396,
      -0.14973139762878418,
      0.0054540871642529964,
      -0.025164196267724037,
      0.26345735788345337,
      0.02392871119081974,
      -0.1307765245437622,
      -0.13477635383605957,
      0.07636501640081406,
      -0.16200144588947296,
      -0.09111250191926956,
      0.03548011928796768,
      -0.12695448100566864,
      -0.18650229275226593,
      -0.3169718384742737,
      0.026560168713331223,
      0.4305849075317383,
      0.08371586352586746,
      -0.12461981922388077,
      0.09767624735832214,
      -0.04208601266145706,
      -0.0012900371802970767,
      0.18921612203121185,
      0.16424426436424255,
      0.004407686647027731,
      0.006290579680353403,
      -0.11798442900180817,
      0.007900891825556755,
      0.20786961913108826,
      -0.09792321175336838,
      -0.03723907470703125,
      0.17815910279750824,
      -0.06417465209960938,
      0.10494767874479294,
      -0.002483928110450506,
      0.021710263565182686,
      -0.07612135261297226,
      0.08064033091068268,
      -0.06841754168272018,
      0.026781078428030014,
      0.0942324697971344,
      -0.01887071132659912,
      0.007914155721664429,
      0.12657292187213898,
      -0.1017109677195549,
      0.08235806971788406,
      -0.022135159000754356,
      0.021392816677689552,
      0.07438924163579941,
      -0.058487605303525925,
      -0.15024882555007935,
      -0.05564311519265175,
      0.11725074797868729,
      -0.2553310990333557,
      0.1969272643327713,
      0.16243968904018402,
      0.040599171072244644,
      0.13707688450813293,
      0.13299570977687836,
      0.11596189439296722,
      -0.01580287516117096,
      0.0027148565277457237,
      -0.27767181396484375,
      -0.005450644064694643,
      0.12300659716129303,
      -0.01924794726073742,
      0.12621501088142395,
      -0.026482101529836655
    ],
    [
      -0.07108578085899353,
      0.01288808323442936,
      0.02598848007619381,
      0.012704538181424141,
      -0.01617777906358242,
      -0.07528695464134216,
      -0.04234648123383522,
      -0.16780208051204681,
      0.12744294106960297,
      -0.10209114104509354,
      0.23128823935985565,
      -0.07448281347751617,
      -0.2141229808330536,
      -0.09168394654989243,
      -0.07896842807531357,
      0.1595190465450287,
      -0.19673456251621246,
      -0.05622584745287895,
      -0.010737921111285686,
      -0.06121460720896721,
      0.07749801129102707,
      0.021037796512246132,
      0.03248533234000206,
      0.027642058208584785,
      -0.08951664716005325,
      -0.28624656796455383,
      -0.09998650848865509,
      -0.12132218480110168,
      0.02938171848654747,
      -0.048389535397291183,
      -0.07527241855859756,
      0.03116719052195549,
      -0.1525576412677765,
      -0.05228343605995178,
      0.029943492263555527,
      0.10510941594839096,
      -0.08199580013751984,
      -0.06608987599611282,
      0.20064742863178253,
      -0.052178457379341125,
      -0.14803574979305267,
      -0.030071169137954712,
      0.0600726380944252,
      0.2362883985042572,
      0.1835993081331253,
      0.09016932547092438,
      -0.026343323290348053,
      -0.10662088543176651,
      0.08287256956100464,
      -0.18269136548042297,
      0.005243373569101095,
      0.10599856823682785,
      0.062235984951257706,
      0.08205697685480118,
      -0.012520494870841503,
      -0.116249680519104,
      0.05203700810670853,
      0.07703471928834915,
      -0.14881035685539246,
      -0.013536383397877216,
      0.1009984165430069,
      -0.15315577387809753,
      -0.011986407451331615,
      0.002911425195634365,
      0.2726738750934601,
      0.030401505529880524,
      -0.13226129114627838,
      -0.08757953345775604,
      0.08531475812196732,
      -0.1938142478466034,
      -0.08247532695531845,
      0.026539847254753113,
      -0.1067742183804512,
      -0.1965886652469635,
      -0.3138197064399719,
      0.03231564536690712,
      0.4378519356250763,
      0.10455796867609024,
      -0.12008301913738251,
      0.07462805509567261,
      -0.0033389015588909388,
      -0.023382844403386116,
      0.2270345836877823,
      0.13975128531455994,
      -0.009584534913301468,
      -0.0023290133103728294,
      -0.10716033726930618,
      -0.0017023035325109959,
      0.19904591143131256,
      -0.09187382459640503,
      -0.04806072264909744,
      0.13317115604877472,
      -0.05122289061546326,
      0.09131532907485962,
      0.01401477586477995,
      0.0018716877093538642,
      -0.0479344017803669,
      0.06781774014234543,
      -0.09514956921339035,
      0.026580212637782097,
      0.07888562977313995,
      -0.00015145729412324727,
      0.03207862004637718,
      0.08965260535478592,
      -0.10149358212947845,
      0.10473444312810898,
      0.012459422461688519,
      -0.029297109693288803,
      0.05677333101630211,
      -0.07241127640008926,
      -0.14636288583278656,
      -0.04745001345872879,
      0.1280326098203659,
      -0.2557418942451477,
      0.20608383417129517,
      0.16130556166172028,
      0.07233723998069763,
      0.16124272346496582,
      0.09351600706577301,
      0.07788357138633728,
      -0.013744628056883812,
      0.005352099891752005,
      -0.2416650950908661,
      -0.026176052168011665,
      0.11625317484140396,
      -0.003441896755248308,
      0.1515023112297058,
      -0.033575572073459625
    ],
    [
      -0.06902210414409637,
      0.05297151207923889,
      0.027967678382992744,
      -0.014692522585391998,
      -0.07784228026866913,
      -0.05279827490448952,
      -0.03928643465042114,
      -0.1547127068042755,
      0.1022765263915062,
      -0.14208796620368958,
      0.20187537372112274,
      -0.08333396911621094,
      -0.18309521675109863,
      -0.10121307522058487,
      -0.08035929501056671,
      0.19356386363506317,
      -0.2403128445148468,
      -0.12698842585086823,
      -0.07728415727615356,
      -0.062342528253793716,
      0.091578409075737,
      0.010663919150829315,
      0.022851761430501938,
      0.010262435302138329,
      -0.07837242633104324,
      -0.33584195375442505,
      -0.06428714841604233,
      -0.09067066013813019,
      0.06552170217037201,
      -0.07452808320522308,
      -0.040680818259716034,
      0.02277638018131256,
      -0.20286087691783905,
      -0.03368689864873886,
      0.01680627465248108,
      0.06971533596515656,
      -0.061604198068380356,
      -0.09367697685956955,
      0.19716207683086395,
      -0.07117965072393417,
      -0.17508317530155182,
      -0.015654057264328003,
      0.07735663652420044,
      0.21772754192352295,
      0.15792237222194672,
      0.03816944733262062,
      -0.00992836244404316,
      -0.14064288139343262,
      0.09321345388889313,
      -0.1847928911447525,
      0.007225699722766876,
      0.11772981286048889,
      0.02263529971241951,
      0.11302602291107178,
      0.002170909894630313,
      -0.10120560973882675,
      0.052963994443416595,
      0.11484936624765396,
      -0.08266036212444305,
      0.014124350622296333,
      0.09331107884645462,
      -0.1642531454563141,
      -0.03983480483293533,
      -0.06595358997583389,
      0.26704689860343933,
      0.02580730989575386,
      -0.0995745062828064,
      -0.10456892102956772,
      0.08983112871646881,
      -0.12509384751319885,
      -0.08930642902851105,
      -0.0091423774138093,
      -0.0958823636174202,
      -0.13569596409797668,
      -0.3145805299282074,
      -0.0035287567880004644,
      0.4487253725528717,
      0.09871130436658859,
      -0.15709258615970612,
      0.05441923066973686,
      -0.036566220223903656,
      0.015692798420786858,
      0.22775954008102417,
      0.13769122958183289,
      -0.04576403647661209,
      -0.003987517207860947,
      -0.08599472790956497,
      0.06467464566230774,
      0.20696532726287842,
      -0.08286862075328827,
      -0.044808246195316315,
      0.1334487944841385,
      -0.03703363239765167,
      0.07771538943052292,
      0.02044711448252201,
      -0.020790064707398415,
      -0.05031999573111534,
      0.048704855144023895,
      -0.10089368373155594,
      0.023218095302581787,
      0.09336960315704346,
      -0.03150634095072746,
      0.010790065862238407,
      0.09990348666906357,
      -0.08756570518016815,
      0.070236437022686,
      0.030656293034553528,
      0.006946980487555265,
      0.08881919085979462,
      -0.021073682233691216,
      -0.12690508365631104,
      -0.06858494132757187,
      0.09954047203063965,
      -0.21701790392398834,
      0.24349679052829742,
      0.18699364364147186,
      0.05277145653963089,
      0.16330567002296448,
      0.11316026002168655,
      0.11320551484823227,
      -0.040423061698675156,
      -0.010149248875677586,
      -0.21620655059814453,
      -0.003989130724221468,
      0.1419985294342041,
      0.04264656826853752,
      0.11922528594732285,
      -0.026760516688227654
    ],
    [
      -0.06083086133003235,
      0.06007092073559761,
      0.025504611432552338,
      0.008318806067109108,
      -0.01890365406870842,
      -0.050564542412757874,
      -0.050501249730587006,
      -0.14992286264896393,
      0.1529342234134674,
      -0.13300395011901855,
      0.23230215907096863,
      -0.052244964987039566,
      -0.19224008917808533,
      -0.08346955478191376,
      -0.060145191848278046,
      0.15580405294895172,
      -0.18218067288398743,
      -0.0885164737701416,
      -0.010636082850396633,
      -0.058232631534338,
      0.12239637225866318,
      0.016992267221212387,
      0.0028166831471025944,
      0.020498495548963547,
      -0.0679965689778328,
      -0.290772408246994,
      -0.12249347567558289,
      -0.0856989324092865,
      0.07535047829151154,
      -0.05969275161623955,
      -0.0696621686220169,
      0.01586114801466465,
      -0.17337262630462646,
      -0.06735475361347198,
      0.026572896167635918,
      0.09534388780593872,
      -0.072012759745121,
      -0.08030351251363754,
      0.1649981588125229,
      -0.07999910414218903,
      -0.15060056746006012,
      0.019109679386019707,
      0.05905328691005707,
      0.22971002757549286,
      0.1631355583667755,
      0.10168302804231644,
      -0.014608558267354965,
      -0.13613668084144592,
      0.07997243851423264,
      -0.15905793011188507,
      0.007098206784576178,
      0.12599611282348633,
      0.06711559742689133,
      0.09804439544677734,
      0.00024235168530140072,
      -0.1257110834121704,
      0.047567278146743774,
      0.08066456019878387,
      -0.13469675183296204,
      0.00019922143837902695,
      0.08543891459703445,
      -0.13352228701114655,
      -0.004211590625345707,
      -0.02530832402408123,
      0.2512630820274353,
      0.022649027407169342,
      -0.11838580667972565,
      -0.13886699080467224,
      0.07571473717689514,
      -0.18305353820323944,
      -0.08140233159065247,
      0.04599146917462349,
      -0.11025713384151459,
      -0.18855740129947662,
      -0.2919082045555115,
      0.04597953334450722,
      0.4195939004421234,
      0.10732798278331757,
      -0.11029594391584396,
      0.11965734511613846,
      -0.004933285992592573,
      -0.015835411846637726,
      0.19288034737110138,
      0.14115753769874573,
      -0.014274857006967068,
      -0.0016962239751592278,
      -0.10892868041992188,
      0.017021676525473595,
      0.21442770957946777,
      -0.0923246368765831,
      -0.03484948351979256,
      0.14923764765262604,
      -0.05822082236409187,
      0.08730089664459229,
      -0.004804962780326605,
      0.020377442240715027,
      -0.0651809498667717,
      0.0695633664727211,
      -0.0913662537932396,
      -0.0015053958632051945,
      0.08797809481620789,
      0.005234197713434696,
      0.006641024257987738,
      0.10255826264619827,
      -0.11317656189203262,
      0.09967870265245438,
      -0.01045413501560688,
      0.004703947808593512,
      0.05515797808766365,
      -0.055684756487607956,
      -0.14118503034114838,
      -0.04198834300041199,
      0.11294730752706528,
      -0.25887322425842285,
      0.21839815378189087,
      0.16786706447601318,
      0.06069283187389374,
      0.14890515804290771,
      0.11767493933439255,
      0.09076765179634094,
      0.007334929890930653,
      -0.02089136838912964,
      -0.2528539001941681,
      -0.028547096997499466,
      0.11972437053918839,
      0.0014802287332713604,
      0.11757665127515793,
      -0.03609295189380646
    ]
  ],
  "sample_count": 7,
  "collected_at": "2025-12-10T07:35:55.967Z",
  "angles_collected": [
    "正面",
    "左转",
    "右转",
    "抬头",
    "低头",
    "微笑",
    "中性"
  ],
  "average_quality": "high",
  "note": "增强版多角度采集数据"
}
];

// ===============================
// 主程序
// ===============================
let faceVerifier = null;
let isRecognizing = false;
let modelsLoaded = false;
let hasSignedIn = false;
let isSubmitting = false;

// DOM 元素引用
const videoElement = document.getElementById('video');
const statusEl = document.getElementById('status');
const recognitionInfoEl = document.getElementById('recognitionInfo');
const recognizedNameEl = document.getElementById('recognizedName');
const recognitionConfidenceEl = document.getElementById('recognitionConfidence');
const recognitionSimilarityEl = document.getElementById('recognitionSimilarity');
const consecutiveMatchesEl = document.getElementById('consecutiveMatches');
const zScoreEl = document.getElementById('zScore');
const recognitionStatusEl = document.getElementById('recognitionStatus');
const signinSuccessEl = document.getElementById('signinSuccess');
const successNameEl = document.getElementById('successName');
const successTimeEl = document.getElementById('successTime');
const securityLevelEl = document.getElementById('securityLevel');

// 页面加载后执行
window.addEventListener('load', async () => {
  try {
    statusEl.textContent = '正在初始化增强版人脸识别系统...';
    statusEl.className = 'loading';
    
    // 1. 检查face-api.js
    await checkFaceAPI();
    
    // 2. 启动摄像头
    await startCamera();
    
    // 3. 加载模型
    await loadModels();
    
    // 4. 初始化增强验证器
    faceVerifier = new EnhancedFaceVerifier();
    
    // 5. 加载已知人脸数据
    await loadKnownFaces();
    
    modelsLoaded = true;
    statusEl.textContent = '✓ 增强版系统已就绪！开始识别...';
    statusEl.className = 'success';
    
    // 显示识别信息区域
    recognitionInfoEl.style.display = 'block';
    
    // 开始识别循环
    recognizeLoop();
    
  } catch (error) {
    console.error('初始化失败:', error);
    statusEl.textContent = '初始化失败: ' + error.message;
    statusEl.className = 'error';
  }
});

// 检查 faceapi 是否加载
function checkFaceAPI() {
  return new Promise((resolve, reject) => {
    if (window.faceapi) {
      console.log('faceapi 已加载');
      resolve();
      return;
    }
    
    let attempts = 0;
    const maxAttempts = 30;
    const interval = setInterval(() => {
      attempts++;
      if (window.faceapi) {
        clearInterval(interval);
        console.log('faceapi 加载成功');
        resolve();
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        reject(new Error('face-api.js 加载超时'));
      }
    }, 100);
  });
}

// 启动摄像头
async function startCamera() {
  try {
    statusEl.textContent = '正在请求摄像头权限...';
    statusEl.className = 'loading';
    
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: 640, 
        height: 480,
        facingMode: "user" 
      } 
    });
    
    videoElement.srcObject = stream;
    
    return new Promise((resolve) => {
      videoElement.onloadedmetadata = () => {
        videoElement.play();
        console.log('摄像头启动完成');
        resolve();
      };
    });
  } catch (error) {
    console.error('摄像头错误:', error);
    throw new Error('无法访问摄像头: ' + error.message);
  }
}

// 加载模型
async function loadModels() {
  try {
    statusEl.textContent = '正在加载人脸识别模型...';
    statusEl.className = 'loading';
    
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
    
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    
    console.log('所有模型加载成功');
    
  } catch (error) {
    console.error('模型加载失败:', error);
    throw new Error('模型加载失败: ' + error.message);
  }
}

// 加载已知人脸数据
async function loadKnownFaces() {
  try {
    statusEl.textContent = '正在加载已知人脸数据...';
    
    // 支持两种格式：旧格式（单样本）和新格式（多样本）
    KNOWN_DATA.forEach(person => {
      if (person.embeddings && Array.isArray(person.embeddings[0])) {
        // 新格式：多样本
        faceVerifier.addKnownFace(person.name, person.embeddings);
      } else if (person.embedding) {
        // 旧格式：单样本
        faceVerifier.addKnownFace(person.name, person.embedding);
      } else {
        console.warn('未知的数据格式:', person);
      }
    });
    
    const userCount = faceVerifier.knownFaces.size;
    console.log(`已加载 ${userCount} 个用户数据`);
    statusEl.textContent = `✓ 已加载 ${userCount} 个用户数据`;
    
  } catch (error) {
    console.error('加载人脸数据失败:', error);
    throw new Error('人脸数据加载失败: ' + error.message);
  }
}

// 增强版识别循环
async function recognizeLoop() {
  if (!modelsLoaded || isRecognizing || hasSignedIn) return;
  
  try {
    isRecognizing = true;
    
    // 检测人脸（提高检测阈值）
    const detection = await faceapi
      .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions({
        inputSize: 320,
        scoreThreshold: 0.6
      }))
      .withFaceLandmarks()
      .withFaceDescriptor();
    
    if (detection && detection.detection.score > 0.7) {
      // 使用增强验证器
      const result = faceVerifier.verifyFace(detection.descriptor);
      
      if (result && result.confidence > 0) {
        // 更新UI显示
        updateRecognitionUI(result);
        
        // 检查是否确认
        if (result.isConfirmed && result.confidence > 0.85 && !hasSignedIn) {
          hasSignedIn = true;
          showSignInSuccess(result.name, result);
          sendSignIn(result.name, result.confidence);
        }
        
        // 绘制检测框
        drawDetection(detection, result);
        
      } else {
        // 验证失败
        resetRecognitionUI();
        if (result && result.reason) {
          recognitionStatusEl.textContent = `验证失败: ${result.reason}`;
        } else {
          recognitionStatusEl.textContent = '验证失败';
        }
        recognitionStatusEl.style.color = 'red';
      }
      
    } else {
      // 未检测到人脸或质量太低
      resetRecognitionUI();
      if (detection) {
        recognitionStatusEl.textContent = `检测质量低: ${detection.detection.score.toFixed(3)}`;
      } else {
        recognitionStatusEl.textContent = '未检测到人脸';
      }
      recognitionStatusEl.style.color = 'orange';
    }
    
  } catch (error) {
    console.error('识别错误:', error);
    recognitionStatusEl.textContent = '识别错误: ' + error.message;
    recognitionStatusEl.style.color = 'red';
  } finally {
    isRecognizing = false;
    
    // 继续识别循环（如果未签到）
    if (!hasSignedIn) {
      setTimeout(recognizeLoop, 300);
    }
  }
}

// 更新识别UI
function updateRecognitionUI(result) {
  recognizedNameEl.textContent = result.name;
  recognitionConfidenceEl.textContent = result.confidence.toFixed(4);
  recognitionSimilarityEl.textContent = result.similarity.toFixed(4);
  consecutiveMatchesEl.textContent = `${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE}`;
  zScoreEl.textContent = result.zScore.toFixed(4);
  
  // 设置状态颜色
  if (result.isConfirmed) {
    recognitionStatusEl.textContent = '✓ 高置信度确认！';
    recognitionStatusEl.style.color = 'green';
  } else if (result.confidence > 0.8) {
    recognitionStatusEl.textContent = `✓ 匹配中... (${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE})`;
    recognitionStatusEl.style.color = 'orange';
  } else if (result.confidence > 0.7) {
    recognitionStatusEl.textContent = `低置信度，请保持姿势`;
    recognitionStatusEl.style.color = '#FF9800';
  } else {
    recognitionStatusEl.textContent = '置信度不足';
    recognitionStatusEl.style.color = 'red';
  }
}

// 重置识别UI
function resetRecognitionUI() {
  recognizedNameEl.textContent = '-';
  recognitionConfidenceEl.textContent = '-';
  recognitionSimilarityEl.textContent = '-';
  consecutiveMatchesEl.textContent = '0/3';
  zScoreEl.textContent = '-';
}

// 绘制检测框
function drawDetection(detection, result) {
  const oldCanvas = document.querySelector('canvas');
  if (oldCanvas) oldCanvas.remove();
  
  const canvas = faceapi.createCanvasFromMedia(videoElement);
  const container = document.querySelector('.video-container');
  container.appendChild(canvas);
  
  const displaySize = { width: videoElement.width, height: videoElement.height };
  faceapi.matchDimensions(canvas, displaySize);
  
  const resizedDetection = faceapi.resizeResults(detection, displaySize);
  
  // 设置边框颜色
  const borderColor = result.confidence > 0.85 ? '#00ff00' : 
                     result.confance > 0.75 ? '#ff9900' : '#ff0000';
  
  const ctx = canvas.getContext('2d');
  
  // 绘制检测框
  faceapi.draw.drawDetections(canvas, [resizedDetection]);
  faceapi.draw.drawFaceLandmarks(canvas, [resizedDetection]);
  
  // 添加文字标签
  ctx.font = '16px Arial';
  ctx.fillStyle = borderColor;
  ctx.fillText(`${result.name} (${(result.confidence*100).toFixed(1)}%)`, 
               resizedDetection.detection.box.x, 
               resizedDetection.detection.box.y - 10);
}

// 显示签到成功信息
function showSignInSuccess(name, result) {
  const now = new Date();
  successNameEl.textContent = name;
  successTimeEl.textContent = now.toLocaleString();
  
  // 设置安全等级显示
  const securityLevels = {
    high: { text: '高', class: 'security-high', color: '#4CAF50' },
    medium: { text: '中', class: 'security-medium', color: '#FFC107' },
    low: { text: '低', class: 'security-low', color: '#F44336' }
  };
  
  const level = securityLevels[result.securityLevel || 'medium'];
  securityLevelEl.textContent = level.text;
  securityLevelEl.style.color = level.color;
  
  // 隐藏识别信息区域，显示成功区域
  recognitionInfoEl.style.display = 'none';
  signinSuccessEl.style.display = 'block';
  
  // 停止摄像头
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
    videoElement.style.opacity = '0.3';
  }
  
  statusEl.textContent = `✓ ${name} 签到成功！安全等级: ${level.text}`;
  statusEl.className = 'success';
}

// 发送签到信息
function sendSignIn(name, confidence) {
  try {
    isSubmitting = true;
    
    document.getElementById("nameField").value = name;
    document.getElementById("timeField").value = new Date().toISOString();
    
    console.log('正在提交签到数据:', name, '置信度:', confidence);
    
    const iframe = document.getElementById('resultIframe');
    iframe.onload = function() {
      console.log('数据提交完成！');
      isSubmitting = false;
      
      // 显示成功消息
      setTimeout(() => {
        alert(`✓ 签到成功！\n姓名: ${name}\n置信度: ${(confidence*100).toFixed(1)}%\n数据已保存到Google表格`);
      }, 300);
    };
    
    // 提交表单
    document.getElementById("sendForm").submit();
    
  } catch (error) {
    console.error('提交失败:', error);
    statusEl.textContent = '提交失败: ' + error.message;
    statusEl.className = 'error';
    alert('签到提交失败，请手动记录。错误: ' + error.message);
    isSubmitting = false;
    hasSignedIn = false; // 允许重试
  }
}

// 添加页面卸载时的清理
window.addEventListener('beforeunload', () => {
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
  }
});

// 全局错误处理
window.addEventListener('error', (e) => {
  console.error('全局错误:', e.error);
  if (statusEl) {
    statusEl.textContent = '发生错误: ' + e.message;
    statusEl.className = 'error';
  }
});
</script>

</body>
</html>
