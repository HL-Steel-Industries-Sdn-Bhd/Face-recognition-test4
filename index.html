<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Sign In - 增强版</title>
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:20px; }
#video { width: 640px; height: 480px; border-radius:10px; }
#status { margin: 10px 0; font-weight: bold; font-size: 18px; }
.loading { color: blue; }
.success { color: green; }
.error { color: red; }
canvas { position: absolute; top: 0; left: 0; z-index: 10; }
.video-container { 
    position: relative; 
    display: inline-block; 
    margin-bottom: 20px;
}
#recognitionInfo {
    margin: 20px auto;
    padding: 15px;
    background-color: #f5f5f5;
    border-radius: 8px;
    max-width: 600px;
    text-align: left;
}
.signin-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 15px;
    margin: 20px auto;
    border-radius: 8px;
    max-width: 600px;
}
#resultIframe {
    display: none;
    width: 0;
    height: 0;
    border: 0;
}
.security-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}
.security-high { background-color: #4CAF50; }
.security-medium { background-color: #FFC107; }
.security-low { background-color: #F44336; }
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
}
.stat-item {
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-size: 14px;
}
</style>
</head>
<body>

<h2>会议签到 - 增强版人脸识别</h2>

<div class="video-container">
    <video id="video" width="640" height="480" autoplay muted></video>
</div>

<div id="status" class="loading">正在初始化增强版识别系统...</div>

<div id="recognitionInfo" style="display: none;">
    <h3>识别结果</h3>
    <p>姓名: <span id="recognizedName">-</span></p>
    <div class="stats-grid">
        <div class="stat-item">置信度: <span id="recognitionConfidence">-</span></div>
        <div class="stat-item">相似度: <span id="recognitionSimilarity">-</span></div>
        <div class="stat-item">连续匹配: <span id="consecutiveMatches">0/3</span></div>
        <div class="stat-item">Z-score: <span id="zScore">-</span></div>
    </div>
    <p>状态: <span id="recognitionStatus">正在初始化...</span></p>
</div>

<!-- 签到成功提示区域 -->
<div id="signinSuccess" class="signin-success" style="display: none;">
    <h3>✓ 签到成功！</h3>
    <p>姓名: <span id="successName">-</span></p>
    <p>时间: <span id="successTime">-</span></p>
    <p>安全等级: <span id="securityLevel">高</span> <span class="security-indicator security-high"></span></p>
    <p>数据已成功提交到Google表格</p>
</div>

<!-- 隐藏的表单和iframe -->
<iframe id="resultIframe" name="resultIframe"></iframe>
<form id="sendForm" method="post" target="resultIframe" 
      action="https://script.google.com/macros/s/AKfycbwredN437XGaJCdq8qH9dQPM2CkXNNIkPLFfvB8BMxqAvSv7Dd4WnlhIn5wXKY5nsZs/exec" 
      style="display: none;">
    <input type="hidden" name="name" id="nameField">
    <input type="hidden" name="timestamp" id="timeField">
</form>

<script>
// ===============================
// 增强版人脸验证器
// ===============================
class EnhancedFaceVerifier {
  constructor() {
    this.knownFaces = new Map();
    this.consecutiveMatches = new Map();
    this.REQUIRED_CONSECUTIVE = 3; // 需要连续3帧匹配
    this.lastVerificationTime = 0;
    this.verificationDelay = 300; // 毫秒
  }
  
  // 添加已知人脸（支持多样本）
  addKnownFace(name, embeddings) {
    if (!Array.isArray(embeddings[0])) {
      embeddings = [embeddings]; // 单样本转为数组
    }
    
    // 计算统计特征
    const mean = this.calculateMean(embeddings);
    const std = this.calculateStd(embeddings, mean);
    const minSimilarity = this.calculateMinSimilarity(embeddings);
    
    this.knownFaces.set(name, {
      name: name,
      embeddings: embeddings,
      mean: mean,
      std: std,
      minSimilarity: minSimilarity
    });
    
    this.consecutiveMatches.set(name, 0);
    console.log(`已加载用户: ${name}, 样本数: ${embeddings.length}, 内部相似度: ${minSimilarity.toFixed(4)}`);
  }
  
  // 计算均值向量
  calculateMean(embeddings) {
    const dimensions = embeddings[0].length;
    const mean = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        mean[i] += emb[i];
      }
    }
    
    return mean.map(val => val / embeddings.length);
  }
  
  // 计算标准差向量
  calculateStd(embeddings, mean) {
    const dimensions = embeddings[0].length;
    const variance = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        variance[i] += Math.pow(emb[i] - mean[i], 2);
      }
    }
    
    // 加一个小值防止除零
    return variance.map(val => Math.sqrt(val / embeddings.length) + 1e-8);
  }
  
  // 计算内部最小相似度
  calculateMinSimilarity(embeddings) {
    if (embeddings.length <= 1) return 0.9; // 单样本默认
    
    let minSim = 1;
    for (let i = 0; i < embeddings.length; i++) {
      for (let j = i + 1; j < embeddings.length; j++) {
        const sim = this.cosineSimilarity(embeddings[i], embeddings[j]);
        if (sim < minSim) minSim = sim;
      }
    }
    return minSim;
  }
  
  // 余弦相似度（更准确）
  cosineSimilarity(a, b) {
    let dot = 0, normA = 0, normB = 0;
    for (let i = 0; i < a.length; i++) {
      dot += a[i] * b[i];
      normA += a[i] * a[i];
      normB += b[i] * b[i];
    }
    return dot / (Math.sqrt(normA) * Math.sqrt(normB));
  }
  
  // Z-score标准化距离
  zScoreDistance(liveEmbedding, knownFace) {
    let totalZ = 0;
    const dimensions = liveEmbedding.length;
    
    for (let i = 0; i < dimensions; i++) {
      const z = Math.abs((liveEmbedding[i] - knownFace.mean[i]) / knownFace.std[i]);
      totalZ += z;
    }
    
    return totalZ / dimensions; // 平均Z-score
  }
  
  // 综合验证人脸
  verifyFace(liveEmbedding) {
    const now = Date.now();
    if (now - this.lastVerificationTime < this.verificationDelay) {
      return null; // 防止过于频繁验证
    }
    this.lastVerificationTime = now;
    
    let bestMatch = null;
    let bestScore = Infinity;
    let bestSimilarity = -1;
    let bestZScore = Infinity;
    
    // 遍历所有已知人脸
    for (const [name, faceData] of this.knownFaces) {
      // 计算Z-score距离
      const zScore = this.zScoreDistance(liveEmbedding, faceData);
      
      // 计算余弦相似度
      const similarity = this.cosineSimilarity(liveEmbedding, faceData.mean);
      
      // 综合得分（Z-score权重70%，相似度30%）
      const combinedScore = zScore * 0.7 + (1 - similarity) * 0.3;
      
      if (combinedScore < bestScore) {
        bestScore = combinedScore;
        bestSimilarity = similarity;
        bestZScore = zScore;
        bestMatch = name;
      }
    }
    
    if (!bestMatch) return null;
    
    const faceData = this.knownFaces.get(bestMatch);
    
    // 三重阈值验证
    const isZScoreValid = bestZScore < 1.1;                    // Z-score阈值
    const isSimilarityValid = bestSimilarity > 0.68;           // 相似度阈值
    const isInternalValid = bestSimilarity > (faceData.minSimilarity * 0.8); // 内部一致性
    
    if (isZScoreValid && isSimilarityValid && isInternalValid) {
      // 更新连续匹配计数
      const currentCount = this.consecutiveMatches.get(bestMatch) + 1;
      this.consecutiveMatches.set(bestMatch, currentCount);
      
      // 重置其他用户的计数
      for (const [name] of this.consecutiveMatches) {
        if (name !== bestMatch) {
          this.consecutiveMatches.set(name, 0);
        }
      }
      
      // 计算综合置信度
      const confidence = Math.min(0.99, 0.7 * (1 - bestZScore) + 0.3 * bestSimilarity);
      
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: confidence,
        consecutiveMatches: currentCount,
        isConfirmed: currentCount >= this.REQUIRED_CONSECUTIVE,
        securityLevel: this.getSecurityLevel(confidence, bestZScore, bestSimilarity)
      };
    } else {
      // 验证失败，重置该用户的计数
      this.consecutiveMatches.set(bestMatch, 0);
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: 0,
        consecutiveMatches: 0,
        isConfirmed: false,
        securityLevel: 'low',
        reason: !isZScoreValid ? 'Z-score过高' : !isSimilarityValid ? '相似度不足' : '内部不一致'
      };
    }
  }
  
  // 获取安全等级
  getSecurityLevel(confidence, zScore, similarity) {
    if (confidence > 0.85 && zScore < 0.7 && similarity > 0.8) return 'high';
    if (confidence > 0.75 && zScore < 0.8 && similarity > 0.75) return 'medium';
    return 'low';
  }
  
  // 获取状态
  getStatus() {
    const status = {};
    for (const [name, count] of this.consecutiveMatches) {
      status[name] = { consecutiveMatches: count };
    }
    return status;
  }
}

// ===============================
// 已知用户数据（需要从collector复制过来）
// ===============================
const KNOWN_DATA = [
{
  "name": "Ptilopsis",
  "embeddings": [
    [
      -0.051675692200660706,
      0.05241002142429352,
      0.05809638649225235,
      -0.004197609610855579,
      -0.028548462316393852,
      -0.03763683885335922,
      -0.04514235630631447,
      -0.14039216935634613,
      0.14433784782886505,
      -0.1322110891342163,
      0.21716216206550598,
      -0.04540567472577095,
      -0.19915030896663666,
      -0.08455171436071396,
      -0.07258457690477371,
      0.16312171518802643,
      -0.1798458993434906,
      -0.07302776724100113,
      -0.022327393293380737,
      -0.04499072581529617,
      0.12298756092786789,
      0.03323811665177345,
      0.0016511506401002407,
      -0.004788412246853113,
      -0.06879477202892303,
      -0.29546213150024414,
      -0.1207379549741745,
      -0.08393379300832748,
      0.04913587495684624,
      -0.02586499974131584,
      -0.07198780030012131,
      -0.001959536923095584,
      -0.15971431136131287,
      -0.060097139328718185,
      -0.0017348984256386757,
      0.09642890095710754,
      -0.06635089963674545,
      -0.09633927047252655,
      0.14273980259895325,
      -0.04661669582128525,
      -0.1690354347229004,
      0.02600453980267048,
      0.03739434853196144,
      0.20014537870883942,
      0.1533356010913849,
      0.09416186064481735,
      0.003921233117580414,
      -0.11471351981163025,
      0.05608045682311058,
      -0.17592895030975342,
      0.006555670872330666,
      0.11504434794187546,
      0.06022056192159653,
      0.09293949604034424,
      0.014928318560123444,
      -0.12213563174009323,
      0.041252389550209045,
      0.08631659299135208,
      -0.12222003191709518,
      -0.004652236122637987,
      0.07890736311674118,
      -0.1270250827074051,
      0.007934728637337685,
      -0.03629869967699051,
      0.2443252056837082,
      0.048135723918676376,
      -0.11669625341892242,
      -0.13458241522312164,
      0.06923437863588333,
      -0.17283135652542114,
      -0.10435548424720764,
      0.028030235320329666,
      -0.10868855565786362,
      -0.16192348301410675,
      -0.30350998044013977,
      0.056638527661561966,
      0.41817373037338257,
      0.10792182385921478,
      -0.11393057554960251,
      0.08618002384901047,
      -0.023608462885022163,
      -0.0029982696287333965,
      0.19286201894283295,
      0.13855628669261932,
      -0.0010074368910863996,
      0.007729535922408104,
      -0.10074890404939651,
      -0.002705046208575368,
      0.19864121079444885,
      -0.09823396801948547,
      -0.0397910475730896,
      0.1586485058069229,
      -0.06481129676103592,
      0.08995682746171951,
      -0.019404511898756027,
      0.012066138908267021,
      -0.05567796155810356,
      0.09123214334249496,
      -0.05277061462402344,
      0.018801042810082436,
      0.12206223607063293,
      -0.014079953543841839,
      0.016460387036204338,
      0.09951258450746536,
      -0.11684475094079971,
      0.08606202155351639,
      -0.02986549586057663,
      0.0054145934991538525,
      0.08159031718969345,
      -0.05840195342898369,
      -0.14573079347610474,
      -0.022702276706695557,
      0.1364029198884964,
      -0.24586951732635498,
      0.22578968107700348,
      0.18435662984848022,
      0.029309049248695374,
      0.13700786232948303,
      0.13587480783462524,
      0.09455820173025131,
      -0.006538943853229284,
      -0.01658513955771923,
      -0.25581660866737366,
      -0.03773544728755951,
      0.11465562880039215,
      -0.009901350364089012,
      0.1117841824889183,
      -0.019148079678416252
    ],
    [
      -0.05621141940355301,
      0.02400493435561657,
      0.04843893647193909,
      -0.01940232887864113,
      -0.0628357008099556,
      -0.023788975551724434,
      -0.05280696228146553,
      -0.11745120584964752,
      0.13865050673484802,
      -0.15296223759651184,
      0.18069568276405334,
      -0.060542620718479156,
      -0.2132502943277359,
      -0.049964047968387604,
      -0.08328045159578323,
      0.15268199145793915,
      -0.16131938993930817,
      -0.050726741552352905,
      -0.038365595042705536,
      -0.050192710012197495,
      0.12044663727283478,
      0.03389154374599457,
      0.0094747394323349,
      0.0006735608330927789,
      -0.07109098881483078,
      -0.30856800079345703,
      -0.12203121185302734,
      -0.09666488319635391,
      0.026377180591225624,
      -0.02944394201040268,
      -0.08081255853176117,
      0.011718839406967163,
      -0.13258957862854004,
      -0.03439982235431671,
      -0.006474935915321112,
      0.1294778436422348,
      -0.075137197971344,
      -0.0926445871591568,
      0.15260940790176392,
      -0.028881503269076347,
      -0.16479191184043884,
      0.015600981190800667,
      0.031146541237831116,
      0.20338155329227448,
      0.15071044862270355,
      0.10050453990697861,
      0.008961869403719902,
      -0.09550134092569351,
      0.07498861849308014,
      -0.19566573202610016,
      0.024264691397547722,
      0.12718375027179718,
      0.0524141751229763,
      0.10481741279363632,
      0.03454602509737015,
      -0.12685075402259827,
      0.0724046602845192,
      0.09787039458751678,
      -0.11958805471658707,
      0.017071433365345,
      0.08146445453166962,
      -0.1268676519393921,
      0.014339154586195946,
      -0.0210169218480587,
      0.269149512052536,
      0.07061626762151718,
      -0.12829698622226715,
      -0.11920203268527985,
      0.06309976428747177,
      -0.19296275079250336,
      -0.0930720716714859,
      0.021412497386336327,
      -0.13656096160411835,
      -0.1632145792245865,
      -0.2945318818092346,
      0.05832240357995033,
      0.4301905930042267,
      0.1337418407201767,
      -0.10772828757762909,
      0.057131990790367126,
      -0.024513719603419304,
      -0.010160418227314949,
      0.21053217351436615,
      0.15572303533554077,
      -0.013270268216729164,
      -0.0021041501313447952,
      -0.09374305605888367,
      0.00336068170145154,
      0.20040784776210785,
      -0.10306821018457413,
      -0.04137508571147919,
      0.17393507063388824,
      -0.045401591807603836,
      0.09455344080924988,
      -0.02699747122824192,
      -0.0049095554277300835,
      -0.06372379511594772,
      0.06420235335826874,
      -0.03642715513706207,
      0.030234187841415405,
      0.12067172676324844,
      -0.05406353622674942,
      0.00749108474701643,
      0.09271879494190216,
      -0.1294969618320465,
      0.08157341182231903,
      -0.052070502191782,
      0.000366655905963853,
      0.07188015431165695,
      -0.061718426644802094,
      -0.1664702445268631,
      -0.02173212543129921,
      0.15957455337047577,
      -0.23965491354465485,
      0.21371214091777802,
      0.20130062103271484,
      0.03984186053276062,
      0.1371738314628601,
      0.14078570902347565,
      0.10011418163776398,
      0.004624851513653994,
      -0.007498329039663076,
      -0.24574562907218933,
      -0.027890684083104134,
      0.10562846064567566,
      -0.0012820609845221043,
      0.09086478501558304,
      -0.01697417162358761
    ],
    [
      -0.058186132460832596,
      0.05139489099383354,
      0.05789123848080635,
      0.0072888596914708614,
      -0.06816677749156952,
      -0.03493005782365799,
      -0.028274403885006905,
      -0.1219416931271553,
      0.14953204989433289,
      -0.15030045807361603,
      0.19621823728084564,
      -0.07528948038816452,
      -0.20741252601146698,
      -0.04727592691779137,
      -0.05295080319046974,
      0.15727558732032776,
      -0.16485121846199036,
      -0.08036469668149948,
      -0.026459280401468277,
      -0.020916564390063286,
      0.1292748898267746,
      -0.009590868838131428,
      0.003600897965952754,
      -0.0012283142423257232,
      -0.07939706742763519,
      -0.31545397639274597,
      -0.13571186363697052,
      -0.0831213966012001,
      0.03989686816930771,
      -0.037983767688274384,
      -0.07752004265785217,
      0.02383054979145527,
      -0.14525239169597626,
      -0.07048264145851135,
      -0.015195810236036777,
      0.09467673301696777,
      -0.08373603969812393,
      -0.0893709808588028,
      0.17306143045425415,
      -0.06904484331607819,
      -0.19546948373317719,
      0.0181403961032629,
      0.05206326022744179,
      0.18795278668403625,
      0.1545371562242508,
      0.08213716000318527,
      0.013206013478338718,
      -0.11836984008550644,
      0.0662815049290657,
      -0.1737815886735916,
      0.022846749052405357,
      0.1353989541530609,
      0.05636271834373474,
      0.11915627866983414,
      0.021773401647806168,
      -0.11820121854543686,
      0.06153177469968796,
      0.11082082986831665,
      -0.09774657338857651,
      0.0252352524548769,
      0.10121524333953857,
      -0.14120180904865265,
      0.02229228802025318,
      -0.030296802520751953,
      0.23703084886074066,
      0.027838269248604774,
      -0.10348374396562576,
      -0.12839116156101227,
      0.06222626939415932,
      -0.17120590806007385,
      -0.09396135807037354,
      0.03240882232785225,
      -0.13162751495838165,
      -0.1760389804840088,
      -0.318543404340744,
      0.047787491232156754,
      0.4231913685798645,
      0.11417867243289948,
      -0.0999772772192955,
      0.08531314134597778,
      -0.030840212479233742,
      -0.019527120515704155,
      0.1880597174167633,
      0.1603865772485733,
      -0.010140277445316315,
      -0.015393164940178394,
      -0.10269041359424591,
      0.004206004086881876,
      0.2021692991256714,
      -0.09687021374702454,
      -0.019086340442299843,
      0.16821226477622986,
      -0.04801309481263161,
      0.0918368324637413,
      -0.019384056329727173,
      0.01841946318745613,
      -0.06637180596590042,
      0.06304959207773209,
      -0.05083669722080231,
      0.018814587965607643,
      0.10849424451589584,
      -0.06070045381784439,
      -0.006788197439163923,
      0.10446963459253311,
      -0.14595411717891693,
      0.07883446663618088,
      -0.03894412890076637,
      0.032837990671396255,
      0.07610942423343658,
      -0.0514802411198616,
      -0.1456751674413681,
      -0.030705463141202927,
      0.14246833324432373,
      -0.2364702969789505,
      0.18808351457118988,
      0.19496701657772064,
      0.018972305580973625,
      0.12756311893463135,
      0.14843124151229858,
      0.1116502434015274,
      -0.008108747191727161,
      -0.012056787498295307,
      -0.2645795941352844,
      -0.002648590598255396,
      0.11856567114591599,
      0.012223995290696621,
      0.08265046775341034,
      -0.0026647853665053844
    ],
    [
      -0.04704326018691063,
      0.061705607920885086,
      0.039713528007268906,
      0.005786064080893993,
      -0.041600145399570465,
      -0.01918264664709568,
      -0.030827319249510765,
      -0.14449602365493774,
      0.16313470900058746,
      -0.16362501680850983,
      0.19453074038028717,
      -0.04808097705245018,
      -0.20765148103237152,
      -0.0799148827791214,
      -0.07058267295360565,
      0.14685657620429993,
      -0.171561136841774,
      -0.08357711136341095,
      -0.022306734696030617,
      -0.03665958344936371,
      0.13807745277881622,
      0.006613921839743853,
      0.013967694714665413,
      -0.008842170238494873,
      -0.09072420001029968,
      -0.3029524087905884,
      -0.13819967210292816,
      -0.07796263694763184,
      0.02022099681198597,
      -0.040555328130722046,
      -0.06946476548910141,
      0.03949036821722984,
      -0.15794490277767181,
      -0.0673418715596199,
      -0.02795158140361309,
      0.09963050484657288,
      -0.06117839366197586,
      -0.05847618728876114,
      0.17751286923885345,
      -0.049111269414424896,
      -0.1816069632768631,
      0.007545577362179756,
      0.05110977590084076,
      0.22437649965286255,
      0.174118310213089,
      0.0678616315126419,
      -0.000845160975586623,
      -0.11948421597480774,
      0.08049473166465759,
      -0.1638786792755127,
      0.016253238543868065,
      0.14216849207878113,
      0.06460504978895187,
      0.10684209316968918,
      0.011384399607777596,
      -0.1161017045378685,
      0.051979053765535355,
      0.10162391513586044,
      -0.1028699055314064,
      0.017970137298107147,
      0.10121718794107437,
      -0.148321270942688,
      0.021998615935444832,
      -0.011973908171057701,
      0.24731189012527466,
      0.027642466127872467,
      -0.11094975471496582,
      -0.14476004242897034,
      0.07532060891389847,
      -0.17622339725494385,
      -0.08878940343856812,
      0.035228483378887177,
      -0.14329564571380615,
      -0.17507033050060272,
      -0.34000885486602783,
      0.04608970880508423,
      0.4236506521701813,
      0.10923262685537338,
      -0.10130324959754944,
      0.0850149467587471,
      -0.04521528631448746,
      -0.021613426506519318,
      0.206668421626091,
      0.16959090530872345,
      -0.008437175303697586,
      0.007633686065673828,
      -0.11433045566082001,
      0.021166307851672173,
      0.20371820032596588,
      -0.08881831914186478,
      -0.04794931411743164,
      0.17683294415473938,
      -0.04686747491359711,
      0.0923435389995575,
      -0.01092037558555603,
      0.024539045989513397,
      -0.07768038660287857,
      0.07697802782058716,
      -0.08938179165124893,
      0.027529243379831314,
      0.09052964299917221,
      -0.04362579807639122,
      0.005125333555042744,
      0.1254049688577652,
      -0.11224223673343658,
      0.08338554203510284,
      -0.035076964646577835,
      0.0332612507045269,
      0.05643690004944801,
      -0.07208948582410812,
      -0.16562433540821075,
      -0.04241437092423439,
      0.1428222954273224,
      -0.22993135452270508,
      0.17185662686824799,
      0.17094270884990692,
      0.022817770019173622,
      0.12913762032985687,
      0.15921898186206818,
      0.12003970146179199,
      -0.01188527699559927,
      -0.013470761477947235,
      -0.27120721340179443,
      0.011589826084673405,
      0.11646710336208344,
      0.005946183577179909,
      0.10500623285770416,
      -0.011488107964396477
    ],
    [
      -0.048715151846408844,
      0.04495285823941231,
      0.06362548470497131,
      -0.003472777083516121,
      -0.04959044232964516,
      -0.023598264902830124,
      -0.043450918048620224,
      -0.14976418018341064,
      0.14980284869670868,
      -0.13522030413150787,
      0.2211998701095581,
      -0.057685885578393936,
      -0.20051930844783783,
      -0.06387600302696228,
      -0.09128522127866745,
      0.16573631763458252,
      -0.1739995926618576,
      -0.06782873719930649,
      -0.011436386965215206,
      -0.024016745388507843,
      0.12597215175628662,
      0.017810113728046417,
      0.006733987480401993,
      -0.0006661090301349759,
      -0.05148867517709732,
      -0.29260167479515076,
      -0.13561032712459564,
      -0.08741839975118637,
      0.045748017728328705,
      -0.054333239793777466,
      -0.05628705024719238,
      0.0052045187912881374,
      -0.1350127011537552,
      -0.059744495898485184,
      -0.007638201117515564,
      0.09715680032968521,
      -0.08559992164373398,
      -0.09215845912694931,
      0.1734471172094345,
      -0.05257318168878555,
      -0.19239182770252228,
      0.019392458721995354,
      0.04215347766876221,
      0.1966806948184967,
      0.1501108855009079,
      0.1005353182554245,
      -0.0048800003714859486,
      -0.12858827412128448,
      0.06879168748855591,
      -0.17944644391536713,
      -0.005327700171619654,
      0.1325635015964508,
      0.06025094911456108,
      0.09142055362462997,
      0.006141692399978638,
      -0.10226445645093918,
      0.057423993945121765,
      0.07287804782390594,
      -0.13287530839443207,
      0.008656233549118042,
      0.10066710412502289,
      -0.13762110471725464,
      0.023673992604017258,
      -0.019586186856031418,
      0.22638960182666779,
      0.03644012287259102,
      -0.11697468161582947,
      -0.13890165090560913,
      0.06217880919575691,
      -0.1924239844083786,
      -0.11735338717699051,
      0.051187559962272644,
      -0.11899562180042267,
      -0.18130828440189362,
      -0.32485494017601013,
      0.03178492188453674,
      0.44792118668556213,
      0.10261984914541245,
      -0.09583582729101181,
      0.0732652097940445,
      -0.015454343520104885,
      -0.019464608281850815,
      0.19516797363758087,
      0.15789006650447845,
      -0.004906824324280024,
      -0.0014989947667345405,
      -0.1030527800321579,
      -0.012240925803780556,
      0.20224228501319885,
      -0.1080874353647232,
      -0.04758474603295326,
      0.15695224702358246,
      -0.05567128211259842,
      0.11019892245531082,
      -0.022094473242759705,
      0.041780535131692886,
      -0.0431608185172081,
      0.08283191174268723,
      -0.06093627214431763,
      0.020933829247951508,
      0.10638268291950226,
      -0.01095796562731266,
      0.020376713946461678,
      0.10000284016132355,
      -0.11496340483427048,
      0.09299685060977936,
      -0.035092469304800034,
      0.003856708761304617,
      0.06896524876356125,
      -0.05697992816567421,
      -0.16785135865211487,
      -0.022063415497541428,
      0.1607367843389511,
      -0.24128203094005585,
      0.2042752206325531,
      0.1959829330444336,
      0.031248506158590317,
      0.10834979265928268,
      0.15603132545948029,
      0.0961645171046257,
      -0.01212544646114111,
      -0.02227109856903553,
      -0.25285977125167847,
      -0.033669013530015945,
      0.10323499888181686,
      -0.006758532021194696,
      0.11048666387796402,
      -0.028242282569408417
    ],
    [
      -0.07904837280511856,
      0.06159514561295509,
      0.04185444489121437,
      -0.005936159752309322,
      -0.11071014404296875,
      -0.01889888197183609,
      -0.04815831035375595,
      -0.1278316229581833,
      0.11084554344415665,
      -0.16916197538375854,
      0.1710812747478485,
      -0.05047702416777611,
      -0.20410092175006866,
      -0.05546575039625168,
      -0.048328667879104614,
      0.15421347320079803,
      -0.17081625759601593,
      -0.12158918380737305,
      -0.050816603004932404,
      -0.0983978733420372,
      0.09791319072246552,
      0.007972192950546741,
      -0.005795276258140802,
      0.02169639989733696,
      -0.09799440205097198,
      -0.32993224263191223,
      -0.11740848422050476,
      -0.08196122199296951,
      0.0673758015036583,
      -0.07026273012161255,
      -0.045679349452257156,
      -0.014193405397236347,
      -0.17360839247703552,
      -0.03392196446657181,
      -0.0009367353632114828,
      0.08546504378318787,
      -0.09884584695100784,
      -0.11656156927347183,
      0.18324780464172363,
      -0.03826725855469704,
      -0.16723781824111938,
      -0.05709703639149666,
      0.05110654607415199,
      0.2172299325466156,
      0.1306830644607544,
      0.05190711095929146,
      0.010304577648639679,
      -0.09343258291482925,
      0.07814798504114151,
      -0.19462597370147705,
      0.01814408041536808,
      0.16396023333072662,
      0.020958460867404938,
      0.12381874769926071,
      0.040933385491371155,
      -0.08954969793558121,
      0.06872683018445969,
      0.13350334763526917,
      -0.08617822080850601,
      0.024364789947867393,
      0.06444167345762253,
      -0.12880255281925201,
      -0.002265883842483163,
      -0.04569976031780243,
      0.2747657001018524,
      0.05579152703285217,
      -0.08177969604730606,
      -0.1284891664981842,
      0.08882661908864975,
      -0.16872811317443848,
      -0.10552496463060379,
      0.03027617186307907,
      -0.12126494944095612,
      -0.16582432389259338,
      -0.29157617688179016,
      0.027334563434123993,
      0.44460204243659973,
      0.1499890387058258,
      -0.10428711026906967,
      0.04953335225582123,
      -0.044939350336790085,
      -0.01647833175957203,
      0.24140626192092896,
      0.12679937481880188,
      -0.028751937672495842,
      -0.014651261270046234,
      -0.07589586824178696,
      0.05893738195300102,
      0.2394128441810608,
      -0.08359986543655396,
      -0.05488181859254837,
      0.14897318184375763,
      -0.0315808430314064,
      0.089521124958992,
      0.004828265402466059,
      -0.0217695701867342,
      -0.05905018746852875,
      0.040383998304605484,
      -0.06922021508216858,
      0.009132361970841885,
      0.10716462880373001,
      -0.025556083768606186,
      0.005335564259439707,
      0.10631707310676575,
      -0.11183951795101166,
      0.06051957607269287,
      0.010095254518091679,
      -0.0023992382921278477,
      0.05076249688863754,
      -0.03726055845618248,
      -0.20152626931667328,
      -0.05443549156188965,
      0.14271396398544312,
      -0.22928814589977264,
      0.22710248827934265,
      0.21164503693580627,
      0.017991429194808006,
      0.12709511816501617,
      0.14342087507247925,
      0.0684816986322403,
      -0.005457678809762001,
      -0.06196672469377518,
      -0.21046610176563263,
      -0.0042271981947124004,
      0.13786064088344574,
      0.0034338929690420628,
      0.0737622082233429,
      -0.051034681499004364
    ],
    [
      -0.04256310313940048,
      0.06406295299530029,
      0.045864228159189224,
      -0.008395436219871044,
      -0.060143984854221344,
      -0.025147482752799988,
      -0.05585404485464096,
      -0.13135188817977905,
      0.14379936456680298,
      -0.15907248854637146,
      0.1887316107749939,
      -0.05849117413163185,
      -0.21418587863445282,
      -0.07216886430978775,
      -0.06379290670156479,
      0.16369906067848206,
      -0.15751636028289795,
      -0.09647886455059052,
      -0.023847557604312897,
      -0.05697866901755333,
      0.11069608479738235,
      0.010467073880136013,
      0.0017994060181081295,
      0.006022125948220491,
      -0.08222318440675735,
      -0.3052852153778076,
      -0.13521654903888702,
      -0.06690715998411179,
      0.05092309042811394,
      -0.044492870569229126,
      -0.07602383196353912,
      0.010088363662362099,
      -0.16007335484027863,
      -0.05770858749747276,
      0.001546849962323904,
      0.11732955276966095,
      -0.0731024295091629,
      -0.08893973380327225,
      0.153501957654953,
      -0.029540373012423515,
      -0.16444523632526398,
      -0.0016376122366636992,
      0.03735499829053879,
      0.21953712403774261,
      0.15040217339992523,
      0.09121429175138474,
      0.012494825758039951,
      -0.10500559210777283,
      0.05640806257724762,
      -0.16932165622711182,
      0.02263839915394783,
      0.14446161687374115,
      0.047805238515138626,
      0.11451014876365662,
      0.024566417559981346,
      -0.12687824666500092,
      0.05927194282412529,
      0.11719776690006256,
      -0.10569430887699127,
      0.017920387908816338,
      0.07276342064142227,
      -0.11980009078979492,
      0.009906768798828125,
      -0.028589216992259026,
      0.2547404170036316,
      0.039734866470098495,
      -0.11227062344551086,
      -0.14868392050266266,
      0.06505052000284195,
      -0.181016206741333,
      -0.08994900435209274,
      0.042023666203022,
      -0.13066303730010986,
      -0.16252760589122772,
      -0.3066743016242981,
      0.04916435107588768,
      0.42444461584091187,
      0.12118825316429138,
      -0.10335729271173477,
      0.07319376617670059,
      -0.014644904993474483,
      -0.02546297386288643,
      0.2030417025089264,
      0.15149074792861938,
      -0.0032884806860238314,
      -0.0021383524872362614,
      -0.09423559159040451,
      0.015155826695263386,
      0.20554585754871368,
      -0.09588795155286789,
      -0.040875356644392014,
      0.15997177362442017,
      -0.06217610463500023,
      0.09251929819583893,
      -0.02621564082801342,
      0.012565449811518192,
      -0.06761269271373749,
      0.081386998295784,
      -0.046134207397699356,
      0.0075942459516227245,
      0.11351438611745834,
      -0.04176872596144676,
      -0.0009136683656834066,
      0.10209555178880692,
      -0.12458156049251556,
      0.07592368125915527,
      -0.026735423132777214,
      0.017652878537774086,
      0.060616131871938705,
      -0.04729936271905899,
      -0.17260250449180603,
      -0.0413680262863636,
      0.15604554116725922,
      -0.25316041707992554,
      0.2115326225757599,
      0.21635960042476654,
      0.016386162489652634,
      0.11825016885995865,
      0.14676983654499054,
      0.10072162002325058,
      0.01277779322117567,
      -0.026911260560154915,
      -0.23527002334594727,
      -0.020039329305291176,
      0.09925766289234161,
      -0.012698891572654247,
      0.08595962077379227,
      -0.026864856481552124
    ]
  ],
  "sample_count": 7,
  "collected_at": "2025-12-10T08:51:35.689Z",
  "angles_collected": [
    "正面",
    "左转",
    "右转",
    "抬头",
    "低头",
    "微笑",
    "中性"
  ],
  "average_quality": "high",
  "note": "增强版多角度采集数据"
}
];

// ===============================
// 主程序
// ===============================
let faceVerifier = null;
let isRecognizing = false;
let modelsLoaded = false;
let hasSignedIn = false;
let isSubmitting = false;

// DOM 元素引用
const videoElement = document.getElementById('video');
const statusEl = document.getElementById('status');
const recognitionInfoEl = document.getElementById('recognitionInfo');
const recognizedNameEl = document.getElementById('recognizedName');
const recognitionConfidenceEl = document.getElementById('recognitionConfidence');
const recognitionSimilarityEl = document.getElementById('recognitionSimilarity');
const consecutiveMatchesEl = document.getElementById('consecutiveMatches');
const zScoreEl = document.getElementById('zScore');
const recognitionStatusEl = document.getElementById('recognitionStatus');
const signinSuccessEl = document.getElementById('signinSuccess');
const successNameEl = document.getElementById('successName');
const successTimeEl = document.getElementById('successTime');
const securityLevelEl = document.getElementById('securityLevel');

// 页面加载后执行
window.addEventListener('load', async () => {
  try {
    statusEl.textContent = '正在初始化增强版人脸识别系统...';
    statusEl.className = 'loading';
    
    // 1. 检查face-api.js
    await checkFaceAPI();
    
    // 2. 启动摄像头
    await startCamera();
    
    // 3. 加载模型
    await loadModels();
    
    // 4. 初始化增强验证器
    faceVerifier = new EnhancedFaceVerifier();
    
    // 5. 加载已知人脸数据
    await loadKnownFaces();
    
    modelsLoaded = true;
    statusEl.textContent = '✓ 增强版系统已就绪！开始识别...';
    statusEl.className = 'success';
    
    // 显示识别信息区域
    recognitionInfoEl.style.display = 'block';
    
    // 开始识别循环
    recognizeLoop();
    
  } catch (error) {
    console.error('初始化失败:', error);
    statusEl.textContent = '初始化失败: ' + error.message;
    statusEl.className = 'error';
  }
});

// 检查 faceapi 是否加载
function checkFaceAPI() {
  return new Promise((resolve, reject) => {
    if (window.faceapi) {
      console.log('faceapi 已加载');
      resolve();
      return;
    }
    
    let attempts = 0;
    const maxAttempts = 30;
    const interval = setInterval(() => {
      attempts++;
      if (window.faceapi) {
        clearInterval(interval);
        console.log('faceapi 加载成功');
        resolve();
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        reject(new Error('face-api.js 加载超时'));
      }
    }, 100);
  });
}

// 启动摄像头
async function startCamera() {
  try {
    statusEl.textContent = '正在请求摄像头权限...';
    statusEl.className = 'loading';
    
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: 640, 
        height: 480,
        facingMode: "user" 
      } 
    });
    
    videoElement.srcObject = stream;
    
    return new Promise((resolve) => {
      videoElement.onloadedmetadata = () => {
        videoElement.play();
        console.log('摄像头启动完成');
        resolve();
      };
    });
  } catch (error) {
    console.error('摄像头错误:', error);
    throw new Error('无法访问摄像头: ' + error.message);
  }
}

// 加载模型
async function loadModels() {
  try {
    statusEl.textContent = '正在加载人脸识别模型...';
    statusEl.className = 'loading';
    
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
    
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    
    console.log('所有模型加载成功');
    
  } catch (error) {
    console.error('模型加载失败:', error);
    throw new Error('模型加载失败: ' + error.message);
  }
}

// 加载已知人脸数据
async function loadKnownFaces() {
  try {
    statusEl.textContent = '正在加载已知人脸数据...';
    
    // 支持两种格式：旧格式（单样本）和新格式（多样本）
    KNOWN_DATA.forEach(person => {
      if (person.embeddings && Array.isArray(person.embeddings[0])) {
        // 新格式：多样本
        faceVerifier.addKnownFace(person.name, person.embeddings);
      } else if (person.embedding) {
        // 旧格式：单样本
        faceVerifier.addKnownFace(person.name, person.embedding);
      } else {
        console.warn('未知的数据格式:', person);
      }
    });
    
    const userCount = faceVerifier.knownFaces.size;
    console.log(`已加载 ${userCount} 个用户数据`);
    statusEl.textContent = `✓ 已加载 ${userCount} 个用户数据`;
    
  } catch (error) {
    console.error('加载人脸数据失败:', error);
    throw new Error('人脸数据加载失败: ' + error.message);
  }
}

// 增强版识别循环
async function recognizeLoop() {
  if (!modelsLoaded || isRecognizing || hasSignedIn) return;
  
  try {
    isRecognizing = true;
    
    // 检测人脸（提高检测阈值）
    const detection = await faceapi
      .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions({
        inputSize: 320,
        scoreThreshold: 0.6
      }))
      .withFaceLandmarks()
      .withFaceDescriptor();
    
    if (detection && detection.detection.score > 0.7) {
      // 使用增强验证器
      const result = faceVerifier.verifyFace(detection.descriptor);
      
      if (result && result.confidence > 0) {
        // 更新UI显示
        updateRecognitionUI(result);
        
        // 检查是否确认
        if (result.isConfirmed && result.confidence > 0.85 && !hasSignedIn) {
          hasSignedIn = true;
          showSignInSuccess(result.name, result);
          sendSignIn(result.name, result.confidence);
        }
        
        // 绘制检测框
        drawDetection(detection, result);
        
      } else {
        // 验证失败
        resetRecognitionUI();
        if (result && result.reason) {
          recognitionStatusEl.textContent = `验证失败: ${result.reason}`;
        } else {
          recognitionStatusEl.textContent = '验证失败';
        }
        recognitionStatusEl.style.color = 'red';
      }
      
    } else {
      // 未检测到人脸或质量太低
      resetRecognitionUI();
      if (detection) {
        recognitionStatusEl.textContent = `检测质量低: ${detection.detection.score.toFixed(3)}`;
      } else {
        recognitionStatusEl.textContent = '未检测到人脸';
      }
      recognitionStatusEl.style.color = 'orange';
    }
    
  } catch (error) {
    console.error('识别错误:', error);
    recognitionStatusEl.textContent = '识别错误: ' + error.message;
    recognitionStatusEl.style.color = 'red';
  } finally {
    isRecognizing = false;
    
    // 继续识别循环（如果未签到）
    if (!hasSignedIn) {
      setTimeout(recognizeLoop, 300);
    }
  }
}

// 更新识别UI
function updateRecognitionUI(result) {
  recognizedNameEl.textContent = result.name;
  recognitionConfidenceEl.textContent = result.confidence.toFixed(4);
  recognitionSimilarityEl.textContent = result.similarity.toFixed(4);
  consecutiveMatchesEl.textContent = `${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE}`;
  zScoreEl.textContent = result.zScore.toFixed(4);
  
  // 设置状态颜色
  if (result.isConfirmed) {
    recognitionStatusEl.textContent = '✓ 高置信度确认！';
    recognitionStatusEl.style.color = 'green';
  } else if (result.confidence > 0.8) {
    recognitionStatusEl.textContent = `✓ 匹配中... (${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE})`;
    recognitionStatusEl.style.color = 'orange';
  } else if (result.confidence > 0.7) {
    recognitionStatusEl.textContent = `低置信度，请保持姿势`;
    recognitionStatusEl.style.color = '#FF9800';
  } else {
    recognitionStatusEl.textContent = '置信度不足';
    recognitionStatusEl.style.color = 'red';
  }
}

// 重置识别UI
function resetRecognitionUI() {
  recognizedNameEl.textContent = '-';
  recognitionConfidenceEl.textContent = '-';
  recognitionSimilarityEl.textContent = '-';
  consecutiveMatchesEl.textContent = '0/3';
  zScoreEl.textContent = '-';
}

// 绘制检测框
function drawDetection(detection, result) {
  const oldCanvas = document.querySelector('canvas');
  if (oldCanvas) oldCanvas.remove();
  
  const canvas = faceapi.createCanvasFromMedia(videoElement);
  const container = document.querySelector('.video-container');
  container.appendChild(canvas);
  
  const displaySize = { width: videoElement.width, height: videoElement.height };
  faceapi.matchDimensions(canvas, displaySize);
  
  const resizedDetection = faceapi.resizeResults(detection, displaySize);
  
  // 设置边框颜色
  const borderColor = result.confidence > 0.85 ? '#00ff00' : 
                     result.confance > 0.75 ? '#ff9900' : '#ff0000';
  
  const ctx = canvas.getContext('2d');
  
  // 绘制检测框
  faceapi.draw.drawDetections(canvas, [resizedDetection]);
  faceapi.draw.drawFaceLandmarks(canvas, [resizedDetection]);
  
  // 添加文字标签
  ctx.font = '16px Arial';
  ctx.fillStyle = borderColor;
  ctx.fillText(`${result.name} (${(result.confidence*100).toFixed(1)}%)`, 
               resizedDetection.detection.box.x, 
               resizedDetection.detection.box.y - 10);
}

// 显示签到成功信息
function showSignInSuccess(name, result) {
  const now = new Date();
  successNameEl.textContent = name;
  successTimeEl.textContent = now.toLocaleString();
  
  // 设置安全等级显示
  const securityLevels = {
    high: { text: '高', class: 'security-high', color: '#4CAF50' },
    medium: { text: '中', class: 'security-medium', color: '#FFC107' },
    low: { text: '低', class: 'security-low', color: '#F44336' }
  };
  
  const level = securityLevels[result.securityLevel || 'medium'];
  securityLevelEl.textContent = level.text;
  securityLevelEl.style.color = level.color;
  
  // 隐藏识别信息区域，显示成功区域
  recognitionInfoEl.style.display = 'none';
  signinSuccessEl.style.display = 'block';
  
  // 停止摄像头
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
    videoElement.style.opacity = '0.3';
  }
  
  statusEl.textContent = `✓ ${name} 签到成功！安全等级: ${level.text}`;
  statusEl.className = 'success';
}

// 发送签到信息
function sendSignIn(name, confidence) {
  try {
    isSubmitting = true;
    
    document.getElementById("nameField").value = name;
    document.getElementById("timeField").value = new Date().toISOString();
    
    console.log('正在提交签到数据:', name, '置信度:', confidence);
    
    const iframe = document.getElementById('resultIframe');
    iframe.onload = function() {
      console.log('数据提交完成！');
      isSubmitting = false;
      
      // 显示成功消息
      setTimeout(() => {
        alert(`✓ 签到成功！\n姓名: ${name}\n置信度: ${(confidence*100).toFixed(1)}%\n数据已保存到Google表格`);
      }, 300);
    };
    
    // 提交表单
    document.getElementById("sendForm").submit();
    
  } catch (error) {
    console.error('提交失败:', error);
    statusEl.textContent = '提交失败: ' + error.message;
    statusEl.className = 'error';
    alert('签到提交失败，请手动记录。错误: ' + error.message);
    isSubmitting = false;
    hasSignedIn = false; // 允许重试
  }
}

// 添加页面卸载时的清理
window.addEventListener('beforeunload', () => {
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
  }
});

// 全局错误处理
window.addEventListener('error', (e) => {
  console.error('全局错误:', e.error);
  if (statusEl) {
    statusEl.textContent = '发生错误: ' + e.message;
    statusEl.className = 'error';
  }
});
</script>

</body>
</html>
