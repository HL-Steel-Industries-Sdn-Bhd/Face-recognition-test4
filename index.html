<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Sign In - 增强版</title>
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:20px; }
#video { width: 640px; height: 480px; border-radius:10px; }
#status { margin: 10px 0; font-weight: bold; font-size: 18px; }
.loading { color: blue; }
.success { color: green; }
.error { color: red; }
canvas { position: absolute; top: 0; left: 0; z-index: 10; }
.video-container { 
    position: relative; 
    display: inline-block; 
    margin-bottom: 20px;
}
#recognitionInfo {
    margin: 20px auto;
    padding: 15px;
    background-color: #f5f5f5;
    border-radius: 8px;
    max-width: 600px;
    text-align: left;
}
.signin-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 15px;
    margin: 20px auto;
    border-radius: 8px;
    max-width: 600px;
}
#resultIframe {
    display: none;
    width: 0;
    height: 0;
    border: 0;
}
.security-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}
.security-high { background-color: #4CAF50; }
.security-medium { background-color: #FFC107; }
.security-low { background-color: #F44336; }
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
}
.stat-item {
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-size: 14px;
}
</style>
</head>
<body>

<h2>会议签到 - 增强版人脸识别</h2>

<div class="video-container">
    <video id="video" width="640" height="480" autoplay muted></video>
</div>

<div id="status" class="loading">正在初始化增强版识别系统...</div>

<div id="recognitionInfo" style="display: none;">
    <h3>识别结果</h3>
    <p>姓名: <span id="recognizedName">-</span></p>
    <div class="stats-grid">
        <div class="stat-item">置信度: <span id="recognitionConfidence">-</span></div>
        <div class="stat-item">相似度: <span id="recognitionSimilarity">-</span></div>
        <div class="stat-item">连续匹配: <span id="consecutiveMatches">0/3</span></div>
        <div class="stat-item">Z-score: <span id="zScore">-</span></div>
    </div>
    <p>状态: <span id="recognitionStatus">正在初始化...</span></p>
</div>

<!-- 签到成功提示区域 -->
<div id="signinSuccess" class="signin-success" style="display: none;">
    <h3>✓ 签到成功！</h3>
    <p>姓名: <span id="successName">-</span></p>
    <p>时间: <span id="successTime">-</span></p>
    <p>安全等级: <span id="securityLevel">高</span> <span class="security-indicator security-high"></span></p>
    <p>数据已成功提交到Google表格</p>
</div>

<!-- 隐藏的表单和iframe -->
<iframe id="resultIframe" name="resultIframe"></iframe>
<form id="sendForm" method="post" target="resultIframe" 
      action="https://script.google.com/macros/s/AKfycbwredN437XGaJCdq8qH9dQPM2CkXNNIkPLFfvB8BMxqAvSv7Dd4WnlhIn5wXKY5nsZs/exec" 
      style="display: none;">
    <input type="hidden" name="name" id="nameField">
    <input type="hidden" name="timestamp" id="timeField">
</form>

<script>
// ===============================
// 增强版人脸验证器
// ===============================
class EnhancedFaceVerifier {
  constructor() {
    this.knownFaces = new Map();
    this.consecutiveMatches = new Map();
    this.REQUIRED_CONSECUTIVE = 3; // 需要连续3帧匹配
    this.lastVerificationTime = 0;
    this.verificationDelay = 300; // 毫秒
  }
  
  // 添加已知人脸（支持多样本）
  addKnownFace(name, embeddings) {
    if (!Array.isArray(embeddings[0])) {
      embeddings = [embeddings]; // 单样本转为数组
    }
    
    // 计算统计特征
    const mean = this.calculateMean(embeddings);
    const std = this.calculateStd(embeddings, mean);
    const minSimilarity = this.calculateMinSimilarity(embeddings);
    
    this.knownFaces.set(name, {
      name: name,
      embeddings: embeddings,
      mean: mean,
      std: std,
      minSimilarity: minSimilarity
    });
    
    this.consecutiveMatches.set(name, 0);
    console.log(`已加载用户: ${name}, 样本数: ${embeddings.length}, 内部相似度: ${minSimilarity.toFixed(4)}`);
  }
  
  // 计算均值向量
  calculateMean(embeddings) {
    const dimensions = embeddings[0].length;
    const mean = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        mean[i] += emb[i];
      }
    }
    
    return mean.map(val => val / embeddings.length);
  }
  
  // 计算标准差向量
  calculateStd(embeddings, mean) {
    const dimensions = embeddings[0].length;
    const variance = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        variance[i] += Math.pow(emb[i] - mean[i], 2);
      }
    }
    
    // 加一个小值防止除零
    return variance.map(val => Math.sqrt(val / embeddings.length) + 1e-8);
  }
  
  // 计算内部最小相似度
  calculateMinSimilarity(embeddings) {
    if (embeddings.length <= 1) return 0.9; // 单样本默认
    
    let minSim = 1;
    for (let i = 0; i < embeddings.length; i++) {
      for (let j = i + 1; j < embeddings.length; j++) {
        const sim = this.cosineSimilarity(embeddings[i], embeddings[j]);
        if (sim < minSim) minSim = sim;
      }
    }
    return minSim;
  }
  
  // 余弦相似度（更准确）
  cosineSimilarity(a, b) {
    let dot = 0, normA = 0, normB = 0;
    for (let i = 0; i < a.length; i++) {
      dot += a[i] * b[i];
      normA += a[i] * a[i];
      normB += b[i] * b[i];
    }
    return dot / (Math.sqrt(normA) * Math.sqrt(normB));
  }
  
  // Z-score标准化距离
  zScoreDistance(liveEmbedding, knownFace) {
    let totalZ = 0;
    const dimensions = liveEmbedding.length;
    
    for (let i = 0; i < dimensions; i++) {
      const z = Math.abs((liveEmbedding[i] - knownFace.mean[i]) / knownFace.std[i]);
      totalZ += z;
    }
    
    return totalZ / dimensions; // 平均Z-score
  }
  
  // 综合验证人脸
  verifyFace(liveEmbedding) {
    const now = Date.now();
    if (now - this.lastVerificationTime < this.verificationDelay) {
      return null; // 防止过于频繁验证
    }
    this.lastVerificationTime = now;
    
    let bestMatch = null;
    let bestScore = Infinity;
    let bestSimilarity = -1;
    let bestZScore = Infinity;
    
    // 遍历所有已知人脸
    for (const [name, faceData] of this.knownFaces) {
      // 计算Z-score距离
      const zScore = this.zScoreDistance(liveEmbedding, faceData);
      
      // 计算余弦相似度
      const similarity = this.cosineSimilarity(liveEmbedding, faceData.mean);
      
      // 综合得分（Z-score权重70%，相似度30%）
      const combinedScore = zScore * 0.7 + (1 - similarity) * 0.3;
      
      if (combinedScore < bestScore) {
        bestScore = combinedScore;
        bestSimilarity = similarity;
        bestZScore = zScore;
        bestMatch = name;
      }
    }
    
    if (!bestMatch) return null;
    
    const faceData = this.knownFaces.get(bestMatch);
    
    // 三重阈值验证
    const isZScoreValid = bestZScore < 0.85;                    // Z-score阈值
    const isSimilarityValid = bestSimilarity > 0.75;           // 相似度阈值
    const isInternalValid = bestSimilarity > (faceData.minSimilarity * 0.85); // 内部一致性
    
    if (isZScoreValid && isSimilarityValid && isInternalValid) {
      // 更新连续匹配计数
      const currentCount = this.consecutiveMatches.get(bestMatch) + 1;
      this.consecutiveMatches.set(bestMatch, currentCount);
      
      // 重置其他用户的计数
      for (const [name] of this.consecutiveMatches) {
        if (name !== bestMatch) {
          this.consecutiveMatches.set(name, 0);
        }
      }
      
      // 计算综合置信度
      const confidence = Math.min(0.99, 0.7 * (1 - bestZScore) + 0.3 * bestSimilarity);
      
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: confidence,
        consecutiveMatches: currentCount,
        isConfirmed: currentCount >= this.REQUIRED_CONSECUTIVE,
        securityLevel: this.getSecurityLevel(confidence, bestZScore, bestSimilarity)
      };
    } else {
      // 验证失败，重置该用户的计数
      this.consecutiveMatches.set(bestMatch, 0);
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: 0,
        consecutiveMatches: 0,
        isConfirmed: false,
        securityLevel: 'low',
        reason: !isZScoreValid ? 'Z-score过高' : !isSimilarityValid ? '相似度不足' : '内部不一致'
      };
    }
  }
  
  // 获取安全等级
  getSecurityLevel(confidence, zScore, similarity) {
    if (confidence > 0.85 && zScore < 0.7 && similarity > 0.8) return 'high';
    if (confidence > 0.75 && zScore < 0.8 && similarity > 0.75) return 'medium';
    return 'low';
  }
  
  // 获取状态
  getStatus() {
    const status = {};
    for (const [name, count] of this.consecutiveMatches) {
      status[name] = { consecutiveMatches: count };
    }
    return status;
  }
}

// ===============================
// 已知用户数据（需要从collector复制过来）
// ===============================
const KNOWN_DATA = [
{
  "name": "Shirley",
  "embeddings": [
    [
      -0.09828296303749084,
      0.10334627330303192,
      0.12337391078472137,
      -0.005501100793480873,
      -0.08821440488100052,
      -0.08117328584194183,
      -0.06523118913173676,
      -0.1623440831899643,
      0.1723041832447052,
      -0.15140412747859955,
      0.14013245701789856,
      -0.0894443690776825,
      -0.22145482897758484,
      -0.03942766413092613,
      -0.019805900752544403,
      0.2026667594909668,
      -0.13851460814476013,
      -0.16436035931110382,
      -0.08283110707998276,
      0.009538435377180576,
      0.09880095720291138,
      0.014283842407166958,
      0.03031770884990692,
      0.048364073038101196,
      -0.16422706842422485,
      -0.3211539685726166,
      -0.11423657089471817,
      -0.036462511867284775,
      -0.03813943266868591,
      -0.1151450127363205,
      -0.14120692014694214,
      0.009240900166332722,
      -0.14224933087825775,
      -0.09314414113759995,
      0.017791694030165672,
      0.05022568628191948,
      0.010342923924326897,
      -0.12667672336101532,
      0.16455978155136108,
      -0.05106383562088013,
      -0.3206935226917267,
      0.026278266683220863,
      0.09459305554628372,
      0.20489166676998138,
      0.19607464969158173,
      0.00866712722927332,
      -0.013484623283147812,
      -0.12834760546684265,
      0.15618671476840973,
      -0.1527126580476761,
      -0.033895593136548996,
      0.11956547200679779,
      0.06573821604251862,
      0.0745561346411705,
      0.05342651531100273,
      -0.11033016443252563,
      0.018669627606868744,
      0.13089388608932495,
      -0.16767443716526031,
      -0.024599580094218254,
      0.08938539773225784,
      -0.10894447565078735,
      0.017436103895306587,
      -0.0948195531964302,
      0.18993709981441498,
      0.0697798877954483,
      -0.09284181892871857,
      -0.15615572035312653,
      0.11974751204252243,
      -0.1493091881275177,
      -0.051687631756067276,
      0.03765766695141792,
      -0.14236770570278168,
      -0.18970482051372528,
      -0.28536415100097656,
      -0.059136535972356796,
      0.37152379751205444,
      0.10379400104284286,
      -0.2000672072172165,
      0.08411979675292969,
      -0.04504464566707611,
      -0.0024128942750394344,
      0.09548783302307129,
      0.1592177301645279,
      0.02258102037012577,
      0.09283798187971115,
      -0.04535296559333801,
      -0.003490551607683301,
      0.24070100486278534,
      -0.05255291610956192,
      0.013618335127830505,
      0.20809385180473328,
      0.02870105393230915,
      0.03382796794176102,
      0.04913758113980293,
      0.0018225937383249402,
      -0.11187613755464554,
      0.023252980783581734,
      -0.1480920910835266,
      0.02624271996319294,
      -0.020861590281128883,
      -0.018553845584392548,
      0.018415501341223717,
      0.09500674158334732,
      -0.14410512149333954,
      0.1318022906780243,
      0.04469505324959755,
      0.023553568869829178,
      -0.01168158557265997,
      0.03316390514373779,
      -0.08338741958141327,
      -0.09240400046110153,
      0.08982518315315247,
      -0.2501049041748047,
      0.13568462431430817,
      0.16915616393089294,
      0.01836155354976654,
      0.11523659527301788,
      0.031489089131355286,
      0.10405369102954865,
      -0.002785608172416687,
      0.05578909441828728,
      -0.1421309858560562,
      -0.028668340295553207,
      0.153769850730896,
      -0.05827488377690315,
      0.11515665054321289,
      0.01792658306658268
    ],
    [
      -0.1227240115404129,
      0.12015996873378754,
      0.12798075377941132,
      -0.0001729297946440056,
      -0.07973966747522354,
      -0.05397023260593414,
      -0.06070660054683685,
      -0.1561468094587326,
      0.1617959886789322,
      -0.14159034192562103,
      0.1067802906036377,
      -0.08939778059720993,
      -0.2431243509054184,
      -0.028223218396306038,
      -0.005188885610550642,
      0.21566805243492126,
      -0.13988180458545685,
      -0.15720795094966888,
      -0.07877150177955627,
      0.008464575745165348,
      0.08413530141115189,
      0.02280295267701149,
      0.032178301364183426,
      0.03071380779147148,
      -0.18511714041233063,
      -0.34587711095809937,
      -0.11784742772579193,
      -0.03416718170046806,
      -0.029654480516910553,
      -0.09930775314569473,
      -0.15587541460990906,
      0.026223018765449524,
      -0.15030990540981293,
      -0.09542184323072433,
      0.015043394640088081,
      0.08362384140491486,
      -0.014389154501259327,
      -0.11390163749456406,
      0.14838771522045135,
      -0.03441198542714119,
      -0.3434653878211975,
      0.04375896602869034,
      0.10070014744997025,
      0.21596714854240417,
      0.2292533814907074,
      0.004068705718964338,
      -0.01168150920420885,
      -0.09506559371948242,
      0.1291937232017517,
      -0.1689002811908722,
      -0.057562362402677536,
      0.13349805772304535,
      0.06305354088544846,
      0.08423026651144028,
      0.05752510577440262,
      -0.08896734565496445,
      0.0221096221357584,
      0.11684735864400864,
      -0.17429350316524506,
      -0.034448232501745224,
      0.11986525356769562,
      -0.1153695359826088,
      0.04955926164984703,
      -0.06865796446800232,
      0.19195951521396637,
      0.06346361339092255,
      -0.09532979130744934,
      -0.13693274557590485,
      0.1493360847234726,
      -0.1517348289489746,
      -0.025265371426939964,
      0.038731034845113754,
      -0.14572536945343018,
      -0.19837485253810883,
      -0.28303641080856323,
      -0.041124600917100906,
      0.37868109345436096,
      0.13759201765060425,
      -0.15907840430736542,
      0.09360864758491516,
      -0.05599329248070717,
      0.008625758811831474,
      0.10135209560394287,
      0.16235578060150146,
      0.027142994105815887,
      0.08117744326591492,
      -0.026743773370981216,
      0.008907820098102093,
      0.23790733516216278,
      -0.03389696776866913,
      0.014232389628887177,
      0.20722395181655884,
      0.03655719757080078,
      0.03437783196568489,
      0.05103383585810661,
      0.00921082217246294,
      -0.11743340641260147,
      -0.0017057224176824093,
      -0.1554080843925476,
      0.019132591784000397,
      -0.04197987541556358,
      -0.03651445358991623,
      0.045369118452072144,
      0.13302507996559143,
      -0.12373892217874527,
      0.1458161473274231,
      0.03922789916396141,
      0.03968716785311699,
      -0.004057303071022034,
      0.0661872997879982,
      -0.06936655938625336,
      -0.08635447919368744,
      0.07908482849597931,
      -0.2522483766078949,
      0.12972941994667053,
      0.1836928427219391,
      -0.02729898691177368,
      0.08388125151395798,
      0.04591355100274086,
      0.10707172751426697,
      -0.0072213769890367985,
      0.06074481084942818,
      -0.151933491230011,
      -0.043495047837495804,
      0.15001662075519562,
      -0.06675935536623001,
      0.12181112915277481,
      0.023441500961780548
    ],
    [
      -0.07342389971017838,
      0.08856293559074402,
      0.12163826078176498,
      -0.04731987044215202,
      -0.10582596808671951,
      -0.12386805564165115,
      -0.07974080741405487,
      -0.12496824562549591,
      0.20366476476192474,
      -0.16297578811645508,
      0.15018679201602936,
      -0.06567342579364777,
      -0.20744964480400085,
      -0.012244299985468388,
      -0.012654171325266361,
      0.2144758403301239,
      -0.18249697983264923,
      -0.1982465535402298,
      -0.06397968530654907,
      0.01435697078704834,
      0.07795416563749313,
      -0.0051767220720648766,
      0.027381399646401405,
      0.030454285442829132,
      -0.14088137447834015,
      -0.3149232864379883,
      -0.12336193025112152,
      -0.019335631281137466,
      0.005528763402253389,
      -0.05750644579529762,
      -0.10926546156406403,
      0.028842568397521973,
      -0.19300726056098938,
      -0.11654873192310333,
      0.06459669768810272,
      0.09961618483066559,
      -0.01713934913277626,
      -0.12156865000724792,
      0.177176833152771,
      -0.03683451935648918,
      -0.3109355866909027,
      -0.003514077514410019,
      0.0965295135974884,
      0.19642077386379242,
      0.21983662247657776,
      0.05541585013270378,
      -0.0015985830686986446,
      -0.14865101873874664,
      0.12950864434242249,
      -0.17551249265670776,
      0.0054704961366951466,
      0.11859586089849472,
      0.09353674203157425,
      0.05181073769927025,
      0.05355972796678543,
      -0.13763514161109924,
      0.04815292730927467,
      0.14473743736743927,
      -0.17744559049606323,
      -0.034384965896606445,
      0.10165976732969284,
      -0.09873125702142715,
      0.018381865695118904,
      -0.06615820527076721,
      0.2563556730747223,
      0.08141601830720901,
      -0.0906277671456337,
      -0.16325174272060394,
      0.1813509166240692,
      -0.15249405801296234,
      -0.05870139226317406,
      0.053822603076696396,
      -0.13815346360206604,
      -0.1362299919128418,
      -0.3221912980079651,
      -0.09320927411317825,
      0.42737334966659546,
      0.05111004784703255,
      -0.14559406042099,
      0.0831751674413681,
      -0.02343965321779251,
      -0.010193632915616035,
      0.06941408663988113,
      0.15953952074050903,
      -0.05983709171414375,
      0.0668102577328682,
      -0.06598244607448578,
      0.0025101685896515846,
      0.2663023769855499,
      -0.048749830573797226,
      0.003982313442975283,
      0.15937231481075287,
      0.012890714220702648,
      0.042559362947940826,
      0.048401691019535065,
      -0.022248266264796257,
      -0.08976281434297562,
      -0.003063477808609605,
      -0.1762944906949997,
      -0.028191151097416878,
      -0.014674022793769836,
      -0.008515574038028717,
      -0.00330824195407331,
      0.17288640141487122,
      -0.14385244250297546,
      0.0433136448264122,
      0.007747657131403685,
      -0.011743194423615932,
      -0.009398255497217178,
      0.04983821511268616,
      -0.08796072006225586,
      -0.15487845242023468,
      0.08440456539392471,
      -0.21555444598197937,
      0.11802767217159271,
      0.17692916095256805,
      0.007691435050219297,
      0.0767531543970108,
      0.05113326385617256,
      0.10379085689783096,
      0.0026093239430338144,
      0.04183214530348778,
      -0.17374560236930847,
      -0.005333120469003916,
      0.11653179675340652,
      -0.03988275304436684,
      0.13888166844844818,
      0.025099145248532295
    ],
    [
      -0.08125936985015869,
      0.09263268113136292,
      0.11369756609201431,
      -0.04872461035847664,
      -0.09098311513662338,
      -0.1112198680639267,
      -0.07801484316587448,
      -0.12686072289943695,
      0.20059430599212646,
      -0.16032114624977112,
      0.14260025322437286,
      -0.07615803182125092,
      -0.21109968423843384,
      -0.030902527272701263,
      -0.008367816917598248,
      0.2129857987165451,
      -0.1749466061592102,
      -0.17877306044101715,
      -0.0676589384675026,
      0.01754986122250557,
      0.08141686022281647,
      0.005426397547125816,
      0.033434174954891205,
      0.03152424469590187,
      -0.1414671093225479,
      -0.3188406527042389,
      -0.12126554548740387,
      -0.019382920116186142,
      -0.014172538183629513,
      -0.054216645658016205,
      -0.12273392081260681,
      0.039353013038635254,
      -0.18792231380939484,
      -0.11659795045852661,
      0.048049479722976685,
      0.10479150712490082,
      -0.010011915117502213,
      -0.10720472782850266,
      0.16480842232704163,
      -0.03867592290043831,
      -0.3081781268119812,
      0.004561115056276321,
      0.10522148013114929,
      0.18904222548007965,
      0.21095821261405945,
      0.05974951386451721,
      -0.0034769601188600063,
      -0.14143690466880798,
      0.12345965206623077,
      -0.17071399092674255,
      0.0010016118176281452,
      0.11737159639596939,
      0.08342504501342773,
      0.051149189472198486,
      0.05993448197841644,
      -0.1343660205602646,
      0.044256336987018585,
      0.13913105428218842,
      -0.15681739151477814,
      -0.04242471605539322,
      0.0998169407248497,
      -0.08898718655109406,
      0.01842675730586052,
      -0.0637063980102539,
      0.2561957538127899,
      0.08078737556934357,
      -0.0929592028260231,
      -0.1511792242527008,
      0.16150890290737152,
      -0.14386700093746185,
      -0.0632164403796196,
      0.04808034747838974,
      -0.13545486330986023,
      -0.13851800560951233,
      -0.32510441541671753,
      -0.07948942482471466,
      0.41894158720970154,
      0.05983424931764603,
      -0.1513603925704956,
      0.09140625596046448,
      -0.028476450592279434,
      -0.012063927948474884,
      0.0860733613371849,
      0.16685819625854492,
      -0.05538605898618698,
      0.07820459455251694,
      -0.06286855787038803,
      0.0019062894862145185,
      0.2522240877151489,
      -0.0406581312417984,
      0.011251074261963367,
      0.17028363049030304,
      0.023286769166588783,
      0.057595960795879364,
      0.04040855914354324,
      -0.02568826638162136,
      -0.08738266676664352,
      0.001634072745218873,
      -0.17097792029380798,
      -0.016491930931806564,
      -0.00030099309515208006,
      -0.005794689059257507,
      -0.0031272016931325197,
      0.16828614473342896,
      -0.1454649269580841,
      0.05253510922193527,
      0.015098191797733307,
      -0.0026384363882243633,
      0.002163130324333906,
      0.054624948650598526,
      -0.07623527199029922,
      -0.14261987805366516,
      0.07283619046211243,
      -0.2209181785583496,
      0.10122032463550568,
      0.16887284815311432,
      -0.0037626405246555805,
      0.0831431970000267,
      0.0629192590713501,
      0.11575488746166229,
      0.00420957338064909,
      0.049059491604566574,
      -0.1812613606452942,
      -0.006024484988301992,
      0.1356961727142334,
      -0.040408484637737274,
      0.13804970681667328,
      0.031000154092907906
    ],
    [
      -0.12706239521503448,
      0.13744321465492249,
      0.07188273221254349,
      -0.05735936760902405,
      -0.159242182970047,
      -0.02545248158276081,
      -0.054437536746263504,
      -0.07258512079715729,
      0.21544231474399567,
      -0.14202091097831726,
      0.0963226854801178,
      -0.07798931747674942,
      -0.23184071481227875,
      -0.024553336203098297,
      -0.013160845264792442,
      0.1876819133758545,
      -0.16856615245342255,
      -0.15126082301139832,
      -0.05591979995369911,
      0.001406311523169279,
      0.118056520819664,
      -0.0018798300297930837,
      0.04528788849711418,
      0.08328642696142197,
      -0.10040555149316788,
      -0.47236037254333496,
      -0.10363443940877914,
      -0.0434371680021286,
      0.021482590585947037,
      -0.10914438962936401,
      -0.15176089107990265,
      0.04394835606217384,
      -0.2231769859790802,
      -0.13091008365154266,
      -0.0012877742992714047,
      0.11800912022590637,
      -0.022581564262509346,
      -0.11117693781852722,
      0.1347474604845047,
      0.030659550800919533,
      -0.26945120096206665,
      -0.0314810574054718,
      0.07815726846456528,
      0.24768105149269104,
      0.20590069890022278,
      0.025750093162059784,
      0.01975419372320175,
      -0.04790451005101204,
      0.10445693135261536,
      -0.19110402464866638,
      -0.08343049138784409,
      0.16758373379707336,
      0.03989873453974724,
      0.07450081408023834,
      0.048234909772872925,
      -0.11257695406675339,
      0.05871950462460518,
      0.05811843276023865,
      -0.17648251354694366,
      -0.03563724085688591,
      0.07251245528459549,
      -0.13814687728881836,
      -0.030367819592356682,
      -0.06726891547441483,
      0.2929748594760895,
      0.0891769602894783,
      -0.05518215522170067,
      -0.15729908645153046,
      0.1666906327009201,
      -0.14042577147483826,
      -0.0014645711053162813,
      0.007941988296806812,
      -0.16871650516986847,
      -0.1482417732477188,
      -0.24557720124721527,
      -0.039098747074604034,
      0.3966357409954071,
      0.1448184996843338,
      -0.1522727757692337,
      0.09710115939378738,
      -0.12272227555513382,
      0.014631269499659538,
      0.08366264402866364,
      0.16382652521133423,
      -0.0004302839224692434,
      0.1373247504234314,
      -0.0726681798696518,
      0.07646498084068298,
      0.18157228827476501,
      -0.057461049407720566,
      0.012733093462884426,
      0.19212289154529572,
      0.04500747099518776,
      0.07596350461244583,
      0.08580128848552704,
      -0.027254365384578705,
      -0.1457529515028,
      -0.027328308671712875,
      -0.21545955538749695,
      -0.025156456977128983,
      -0.007607907056808472,
      -0.04828754812479019,
      0.0026287424843758345,
      0.10397173464298248,
      -0.15432676672935486,
      0.07191338390111923,
      0.026071785017848015,
      -0.032283589243888855,
      -0.04259183630347252,
      -0.00033576638088561594,
      -0.10789886862039566,
      -0.10638316720724106,
      0.0826834961771965,
      -0.23206086456775665,
      0.145933598279953,
      0.21725545823574066,
      -0.01471963431686163,
      0.15003043413162231,
      0.05840568244457245,
      0.07856716215610504,
      0.0006803973810747266,
      -0.0022326218895614147,
      -0.11159689724445343,
      -0.022950900718569756,
      0.11832671612501144,
      -0.025782281532883644,
      0.06308884918689728,
      -0.03425852209329605
    ],
    [
      -0.10508575290441513,
      0.11330664157867432,
      0.08465582132339478,
      0.001037024543620646,
      -0.11164457350969315,
      -0.044791605323553085,
      -0.04623815417289734,
      -0.12413584440946579,
      0.15881112217903137,
      -0.13718543946743011,
      0.14224718511104584,
      -0.10080140084028244,
      -0.21655908226966858,
      -0.04607918858528137,
      -0.027326656505465508,
      0.1862734854221344,
      -0.1362932324409485,
      -0.14925268292427063,
      -0.04950602725148201,
      0.009524436667561531,
      0.0897887647151947,
      0.016346780583262444,
      0.016586652025580406,
      0.03521379828453064,
      -0.20600567758083344,
      -0.3187740445137024,
      -0.09342183917760849,
      -0.04656955227255821,
      -0.03418542444705963,
      -0.14421600103378296,
      -0.10003050416707993,
      0.03588427975773811,
      -0.17182324826717377,
      -0.08930742740631104,
      0.01755128614604473,
      0.04676451534032822,
      -0.0015958494041115046,
      -0.06565852463245392,
      0.18774327635765076,
      -0.05449126288294792,
      -0.3273233473300934,
      0.009679574519395828,
      0.11926025152206421,
      0.2162545919418335,
      0.17951881885528564,
      0.021390549838542938,
      -0.029542159289121628,
      -0.11398585885763168,
      0.13606230914592743,
      -0.15437796711921692,
      -0.019339285790920258,
      0.13390576839447021,
      0.05162760987877846,
      0.08236056566238403,
      0.015474324114620686,
      -0.08896617591381073,
      0.01831829361617565,
      0.11681221425533295,
      -0.16273820400238037,
      -0.015890737995505333,
      0.0955875888466835,
      -0.08667073398828506,
      0.037184420973062515,
      -0.04747922345995903,
      0.20417718589305878,
      0.04008537903428078,
      -0.07145273685455322,
      -0.15163451433181763,
      0.1391136348247528,
      -0.18253275752067566,
      -0.052023109048604965,
      0.06896614283323288,
      -0.11328909546136856,
      -0.20283235609531403,
      -0.2984379529953003,
      -0.06072400137782097,
      0.36801907420158386,
      0.1386943906545639,
      -0.16662518680095673,
      0.0930636003613472,
      -0.03743181750178337,
      -0.028648875653743744,
      0.11706788092851639,
      0.177892804145813,
      0.01748487539589405,
      0.10567186772823334,
      -0.013633454218506813,
      0.028900889679789543,
      0.2642693817615509,
      -0.028120504692196846,
      -0.005373750347644091,
      0.21581976115703583,
      0.05355826020240784,
      0.053129199892282486,
      0.054001208394765854,
      -0.020285336300730705,
      -0.08893699198961258,
      -0.010314076207578182,
      -0.14621834456920624,
      0.01153540425002575,
      -0.03450542315840721,
      -0.000055815602536313236,
      0.030737951397895813,
      0.15043948590755463,
      -0.14611952006816864,
      0.16565392911434174,
      0.03730571269989014,
      0.025570841506123543,
      -0.026789948344230652,
      0.06694217771291733,
      -0.045745715498924255,
      -0.09059976786375046,
      0.08399885147809982,
      -0.23383641242980957,
      0.1372542381286621,
      0.14439451694488525,
      0.005404896568506956,
      0.0980253592133522,
      0.05703648924827576,
      0.08434582501649857,
      0.014077969826757908,
      0.03984546288847923,
      -0.1583845466375351,
      -0.018978603184223175,
      0.14690910279750824,
      -0.09809373319149017,
      0.15644295513629913,
      0.00968894362449646
    ],
    [
      -0.11150616407394409,
      0.10405965149402618,
      0.10381819307804108,
      -0.0011959992116317153,
      -0.07184159755706787,
      -0.06173223629593849,
      -0.05526863783597946,
      -0.17423784732818604,
      0.14465048909187317,
      -0.13983063399791718,
      0.13066069781780243,
      -0.1028011292219162,
      -0.21313558518886566,
      -0.0546620711684227,
      -0.02118125930428505,
      0.1975540816783905,
      -0.14200705289840698,
      -0.16686056554317474,
      -0.06480544805526733,
      0.010165571235120296,
      0.10067866742610931,
      -0.017793994396924973,
      0.025872329249978065,
      0.03381408751010895,
      -0.1773681640625,
      -0.3147119879722595,
      -0.12260567396879196,
      -0.036594878882169724,
      -0.00841826107352972,
      -0.12699419260025024,
      -0.10729721933603287,
      0.006417192984372377,
      -0.16560040414333344,
      -0.0641469806432724,
      0.0010163435945287347,
      0.04346192628145218,
      -0.0015658531337976456,
      -0.11695578694343567,
      0.16693906486034393,
      -0.05869055911898613,
      -0.31446170806884766,
      0.014964155852794647,
      0.08604689687490463,
      0.19469724595546722,
      0.19905829429626465,
      0.011827127076685429,
      -0.014509019441902637,
      -0.11485117673873901,
      0.14329521358013153,
      -0.1363816261291504,
      -0.033913638442754745,
      0.1298159509897232,
      0.0441979244351387,
      0.09915588051080704,
      0.018610786646604538,
      -0.08044936507940292,
      0.027149202302098274,
      0.12098828703165054,
      -0.16431690752506256,
      -0.017554184421896935,
      0.09553253650665283,
      -0.10557547956705093,
      0.025288628414273262,
      -0.07602082937955856,
      0.17846502363681793,
      0.04772782698273659,
      -0.08598846942186356,
      -0.1567782759666443,
      0.14469265937805176,
      -0.1609485000371933,
      -0.04011903703212738,
      0.03772538900375366,
      -0.1318339705467224,
      -0.19909606873989105,
      -0.27618342638015747,
      -0.045785289257764816,
      0.3645400106906891,
      0.13234548270702362,
      -0.16993382573127747,
      0.09210730344057083,
      -0.046036235988140106,
      -0.013190269470214844,
      0.09306507557630539,
      0.16793233156204224,
      0.024642977863550186,
      0.09842880070209503,
      -0.024680064991116524,
      0.003483680309727788,
      0.24666665494441986,
      -0.041615087538957596,
      0.008581874892115593,
      0.2180808186531067,
      0.023569118231534958,
      0.03384370729327202,
      0.040883999317884445,
      -0.004079057835042477,
      -0.09425771981477737,
      0.01642332598567009,
      -0.12603358924388885,
      0.006243269424885511,
      -0.02797095663845539,
      -0.01654992625117302,
      0.03420321270823479,
      0.1189088448882103,
      -0.12528696656227112,
      0.1743220090866089,
      0.04634840041399002,
      0.05105762928724289,
      -0.013561534695327282,
      0.053930506110191345,
      -0.06536747515201569,
      -0.09134763479232788,
      0.07676579058170319,
      -0.23995593190193176,
      0.139378160238266,
      0.17591892182826996,
      0.02848513051867485,
      0.09359670430421829,
      0.04498100280761719,
      0.116265669465065,
      0.00734717957675457,
      0.05471412464976311,
      -0.1484198123216629,
      -0.024221783503890038,
      0.1451932042837143,
      -0.05810467526316643,
      0.11320029199123383,
      0.02219308912754059
    ]
  ],
  "sample_count": 7,
  "collected_at": "2025-12-10T07:23:00.957Z",
  "angles_collected": [
    "正面",
    "左转",
    "右转",
    "抬头",
    "低头",
    "微笑",
    "中性"
  ],
  "average_quality": "high",
  "note": "增强版多角度采集数据"
}
];

// ===============================
// 主程序
// ===============================
let faceVerifier = null;
let isRecognizing = false;
let modelsLoaded = false;
let hasSignedIn = false;
let isSubmitting = false;

// DOM 元素引用
const videoElement = document.getElementById('video');
const statusEl = document.getElementById('status');
const recognitionInfoEl = document.getElementById('recognitionInfo');
const recognizedNameEl = document.getElementById('recognizedName');
const recognitionConfidenceEl = document.getElementById('recognitionConfidence');
const recognitionSimilarityEl = document.getElementById('recognitionSimilarity');
const consecutiveMatchesEl = document.getElementById('consecutiveMatches');
const zScoreEl = document.getElementById('zScore');
const recognitionStatusEl = document.getElementById('recognitionStatus');
const signinSuccessEl = document.getElementById('signinSuccess');
const successNameEl = document.getElementById('successName');
const successTimeEl = document.getElementById('successTime');
const securityLevelEl = document.getElementById('securityLevel');

// 页面加载后执行
window.addEventListener('load', async () => {
  try {
    statusEl.textContent = '正在初始化增强版人脸识别系统...';
    statusEl.className = 'loading';
    
    // 1. 检查face-api.js
    await checkFaceAPI();
    
    // 2. 启动摄像头
    await startCamera();
    
    // 3. 加载模型
    await loadModels();
    
    // 4. 初始化增强验证器
    faceVerifier = new EnhancedFaceVerifier();
    
    // 5. 加载已知人脸数据
    await loadKnownFaces();
    
    modelsLoaded = true;
    statusEl.textContent = '✓ 增强版系统已就绪！开始识别...';
    statusEl.className = 'success';
    
    // 显示识别信息区域
    recognitionInfoEl.style.display = 'block';
    
    // 开始识别循环
    recognizeLoop();
    
  } catch (error) {
    console.error('初始化失败:', error);
    statusEl.textContent = '初始化失败: ' + error.message;
    statusEl.className = 'error';
  }
});

// 检查 faceapi 是否加载
function checkFaceAPI() {
  return new Promise((resolve, reject) => {
    if (window.faceapi) {
      console.log('faceapi 已加载');
      resolve();
      return;
    }
    
    let attempts = 0;
    const maxAttempts = 30;
    const interval = setInterval(() => {
      attempts++;
      if (window.faceapi) {
        clearInterval(interval);
        console.log('faceapi 加载成功');
        resolve();
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        reject(new Error('face-api.js 加载超时'));
      }
    }, 100);
  });
}

// 启动摄像头
async function startCamera() {
  try {
    statusEl.textContent = '正在请求摄像头权限...';
    statusEl.className = 'loading';
    
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: 640, 
        height: 480,
        facingMode: "user" 
      } 
    });
    
    videoElement.srcObject = stream;
    
    return new Promise((resolve) => {
      videoElement.onloadedmetadata = () => {
        videoElement.play();
        console.log('摄像头启动完成');
        resolve();
      };
    });
  } catch (error) {
    console.error('摄像头错误:', error);
    throw new Error('无法访问摄像头: ' + error.message);
  }
}

// 加载模型
async function loadModels() {
  try {
    statusEl.textContent = '正在加载人脸识别模型...';
    statusEl.className = 'loading';
    
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
    
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    
    console.log('所有模型加载成功');
    
  } catch (error) {
    console.error('模型加载失败:', error);
    throw new Error('模型加载失败: ' + error.message);
  }
}

// 加载已知人脸数据
async function loadKnownFaces() {
  try {
    statusEl.textContent = '正在加载已知人脸数据...';
    
    // 支持两种格式：旧格式（单样本）和新格式（多样本）
    KNOWN_DATA.forEach(person => {
      if (person.embeddings && Array.isArray(person.embeddings[0])) {
        // 新格式：多样本
        faceVerifier.addKnownFace(person.name, person.embeddings);
      } else if (person.embedding) {
        // 旧格式：单样本
        faceVerifier.addKnownFace(person.name, person.embedding);
      } else {
        console.warn('未知的数据格式:', person);
      }
    });
    
    const userCount = faceVerifier.knownFaces.size;
    console.log(`已加载 ${userCount} 个用户数据`);
    statusEl.textContent = `✓ 已加载 ${userCount} 个用户数据`;
    
  } catch (error) {
    console.error('加载人脸数据失败:', error);
    throw new Error('人脸数据加载失败: ' + error.message);
  }
}

// 增强版识别循环
async function recognizeLoop() {
  if (!modelsLoaded || isRecognizing || hasSignedIn) return;
  
  try {
    isRecognizing = true;
    
    // 检测人脸（提高检测阈值）
    const detection = await faceapi
      .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions({
        inputSize: 320,
        scoreThreshold: 0.6
      }))
      .withFaceLandmarks()
      .withFaceDescriptor();
    
    if (detection && detection.detection.score > 0.7) {
      // 使用增强验证器
      const result = faceVerifier.verifyFace(detection.descriptor);
      
      if (result && result.confidence > 0) {
        // 更新UI显示
        updateRecognitionUI(result);
        
        // 检查是否确认
        if (result.isConfirmed && result.confidence > 0.85 && !hasSignedIn) {
          hasSignedIn = true;
          showSignInSuccess(result.name, result);
          sendSignIn(result.name, result.confidence);
        }
        
        // 绘制检测框
        drawDetection(detection, result);
        
      } else {
        // 验证失败
        resetRecognitionUI();
        if (result && result.reason) {
          recognitionStatusEl.textContent = `验证失败: ${result.reason}`;
        } else {
          recognitionStatusEl.textContent = '验证失败';
        }
        recognitionStatusEl.style.color = 'red';
      }
      
    } else {
      // 未检测到人脸或质量太低
      resetRecognitionUI();
      if (detection) {
        recognitionStatusEl.textContent = `检测质量低: ${detection.detection.score.toFixed(3)}`;
      } else {
        recognitionStatusEl.textContent = '未检测到人脸';
      }
      recognitionStatusEl.style.color = 'orange';
    }
    
  } catch (error) {
    console.error('识别错误:', error);
    recognitionStatusEl.textContent = '识别错误: ' + error.message;
    recognitionStatusEl.style.color = 'red';
  } finally {
    isRecognizing = false;
    
    // 继续识别循环（如果未签到）
    if (!hasSignedIn) {
      setTimeout(recognizeLoop, 300);
    }
  }
}

// 更新识别UI
function updateRecognitionUI(result) {
  recognizedNameEl.textContent = result.name;
  recognitionConfidenceEl.textContent = result.confidence.toFixed(4);
  recognitionSimilarityEl.textContent = result.similarity.toFixed(4);
  consecutiveMatchesEl.textContent = `${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE}`;
  zScoreEl.textContent = result.zScore.toFixed(4);
  
  // 设置状态颜色
  if (result.isConfirmed) {
    recognitionStatusEl.textContent = '✓ 高置信度确认！';
    recognitionStatusEl.style.color = 'green';
  } else if (result.confidence > 0.8) {
    recognitionStatusEl.textContent = `✓ 匹配中... (${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE})`;
    recognitionStatusEl.style.color = 'orange';
  } else if (result.confidence > 0.7) {
    recognitionStatusEl.textContent = `低置信度，请保持姿势`;
    recognitionStatusEl.style.color = '#FF9800';
  } else {
    recognitionStatusEl.textContent = '置信度不足';
    recognitionStatusEl.style.color = 'red';
  }
}

// 重置识别UI
function resetRecognitionUI() {
  recognizedNameEl.textContent = '-';
  recognitionConfidenceEl.textContent = '-';
  recognitionSimilarityEl.textContent = '-';
  consecutiveMatchesEl.textContent = '0/3';
  zScoreEl.textContent = '-';
}

// 绘制检测框
function drawDetection(detection, result) {
  const oldCanvas = document.querySelector('canvas');
  if (oldCanvas) oldCanvas.remove();
  
  const canvas = faceapi.createCanvasFromMedia(videoElement);
  const container = document.querySelector('.video-container');
  container.appendChild(canvas);
  
  const displaySize = { width: videoElement.width, height: videoElement.height };
  faceapi.matchDimensions(canvas, displaySize);
  
  const resizedDetection = faceapi.resizeResults(detection, displaySize);
  
  // 设置边框颜色
  const borderColor = result.confidence > 0.85 ? '#00ff00' : 
                     result.confance > 0.75 ? '#ff9900' : '#ff0000';
  
  const ctx = canvas.getContext('2d');
  
  // 绘制检测框
  faceapi.draw.drawDetections(canvas, [resizedDetection]);
  faceapi.draw.drawFaceLandmarks(canvas, [resizedDetection]);
  
  // 添加文字标签
  ctx.font = '16px Arial';
  ctx.fillStyle = borderColor;
  ctx.fillText(`${result.name} (${(result.confidence*100).toFixed(1)}%)`, 
               resizedDetection.detection.box.x, 
               resizedDetection.detection.box.y - 10);
}

// 显示签到成功信息
function showSignInSuccess(name, result) {
  const now = new Date();
  successNameEl.textContent = name;
  successTimeEl.textContent = now.toLocaleString();
  
  // 设置安全等级显示
  const securityLevels = {
    high: { text: '高', class: 'security-high', color: '#4CAF50' },
    medium: { text: '中', class: 'security-medium', color: '#FFC107' },
    low: { text: '低', class: 'security-low', color: '#F44336' }
  };
  
  const level = securityLevels[result.securityLevel || 'medium'];
  securityLevelEl.textContent = level.text;
  securityLevelEl.style.color = level.color;
  
  // 隐藏识别信息区域，显示成功区域
  recognitionInfoEl.style.display = 'none';
  signinSuccessEl.style.display = 'block';
  
  // 停止摄像头
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
    videoElement.style.opacity = '0.3';
  }
  
  statusEl.textContent = `✓ ${name} 签到成功！安全等级: ${level.text}`;
  statusEl.className = 'success';
}

// 发送签到信息
function sendSignIn(name, confidence) {
  try {
    isSubmitting = true;
    
    document.getElementById("nameField").value = name;
    document.getElementById("timeField").value = new Date().toISOString();
    
    console.log('正在提交签到数据:', name, '置信度:', confidence);
    
    const iframe = document.getElementById('resultIframe');
    iframe.onload = function() {
      console.log('数据提交完成！');
      isSubmitting = false;
      
      // 显示成功消息
      setTimeout(() => {
        alert(`✓ 签到成功！\n姓名: ${name}\n置信度: ${(confidence*100).toFixed(1)}%\n数据已保存到Google表格`);
      }, 300);
    };
    
    // 提交表单
    document.getElementById("sendForm").submit();
    
  } catch (error) {
    console.error('提交失败:', error);
    statusEl.textContent = '提交失败: ' + error.message;
    statusEl.className = 'error';
    alert('签到提交失败，请手动记录。错误: ' + error.message);
    isSubmitting = false;
    hasSignedIn = false; // 允许重试
  }
}

// 添加页面卸载时的清理
window.addEventListener('beforeunload', () => {
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
  }
});

// 全局错误处理
window.addEventListener('error', (e) => {
  console.error('全局错误:', e.error);
  if (statusEl) {
    statusEl.textContent = '发生错误: ' + e.message;
    statusEl.className = 'error';
  }
});
</script>

</body>
</html>
