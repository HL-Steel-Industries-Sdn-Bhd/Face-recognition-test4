<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Sign In - 增强版</title>
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:20px; }
#video { width: 640px; height: 480px; border-radius:10px; }
#status { margin: 10px 0; font-weight: bold; font-size: 18px; }
.loading { color: blue; }
.success { color: green; }
.error { color: red; }
canvas { position: absolute; top: 0; left: 0; z-index: 10; }
.video-container { 
    position: relative; 
    display: inline-block; 
    margin-bottom: 20px;
}
#recognitionInfo {
    margin: 20px auto;
    padding: 15px;
    background-color: #f5f5f5;
    border-radius: 8px;
    max-width: 600px;
    text-align: left;
}
.signin-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 15px;
    margin: 20px auto;
    border-radius: 8px;
    max-width: 600px;
}
#resultIframe {
    display: none;
    width: 0;
    height: 0;
    border: 0;
}
.security-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 5px;
}
.security-high { background-color: #4CAF50; }
.security-medium { background-color: #FFC107; }
.security-low { background-color: #F44336; }
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 10px;
}
.stat-item {
    background: white;
    padding: 8px;
    border-radius: 5px;
    font-size: 14px;
}
</style>
</head>
<body>

<h2>会议签到 - 增强版人脸识别</h2>

<div class="video-container">
    <video id="video" width="640" height="480" autoplay muted></video>
</div>

<div id="status" class="loading">正在初始化增强版识别系统...</div>

<div id="recognitionInfo" style="display: none;">
    <h3>识别结果</h3>
    <p>姓名: <span id="recognizedName">-</span></p>
    <div class="stats-grid">
        <div class="stat-item">置信度: <span id="recognitionConfidence">-</span></div>
        <div class="stat-item">相似度: <span id="recognitionSimilarity">-</span></div>
        <div class="stat-item">连续匹配: <span id="consecutiveMatches">0/3</span></div>
        <div class="stat-item">Z-score: <span id="zScore">-</span></div>
    </div>
    <p>状态: <span id="recognitionStatus">正在初始化...</span></p>
</div>

<!-- 签到成功提示区域 -->
<div id="signinSuccess" class="signin-success" style="display: none;">
    <h3>✓ 签到成功！</h3>
    <p>姓名: <span id="successName">-</span></p>
    <p>时间: <span id="successTime">-</span></p>
    <p>安全等级: <span id="securityLevel">高</span> <span class="security-indicator security-high"></span></p>
    <p>数据已成功提交到Google表格</p>
</div>

<!-- 隐藏的表单和iframe -->
<iframe id="resultIframe" name="resultIframe"></iframe>
<form id="sendForm" method="post" target="resultIframe" 
      action="https://script.google.com/macros/s/AKfycbwredN437XGaJCdq8qH9dQPM2CkXNNIkPLFfvB8BMxqAvSv7Dd4WnlhIn5wXKY5nsZs/exec" 
      style="display: none;">
    <input type="hidden" name="name" id="nameField">
    <input type="hidden" name="timestamp" id="timeField">
</form>

<script>
// ===============================
// 增强版人脸验证器
// ===============================
class EnhancedFaceVerifier {
  constructor() {
    this.knownFaces = new Map();
    this.consecutiveMatches = new Map();
    this.REQUIRED_CONSECUTIVE = 3; // 需要连续3帧匹配
    this.lastVerificationTime = 0;
    this.verificationDelay = 300; // 毫秒
  }
  
  // 添加已知人脸（支持多样本）
  addKnownFace(name, embeddings) {
    if (!Array.isArray(embeddings[0])) {
      embeddings = [embeddings]; // 单样本转为数组
    }
    
    // 计算统计特征
    const mean = this.calculateMean(embeddings);
    const std = this.calculateStd(embeddings, mean);
    const minSimilarity = this.calculateMinSimilarity(embeddings);
    
    this.knownFaces.set(name, {
      name: name,
      embeddings: embeddings,
      mean: mean,
      std: std,
      minSimilarity: minSimilarity
    });
    
    this.consecutiveMatches.set(name, 0);
    console.log(`已加载用户: ${name}, 样本数: ${embeddings.length}, 内部相似度: ${minSimilarity.toFixed(4)}`);
  }
  
  // 计算均值向量
  calculateMean(embeddings) {
    const dimensions = embeddings[0].length;
    const mean = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        mean[i] += emb[i];
      }
    }
    
    return mean.map(val => val / embeddings.length);
  }
  
  // 计算标准差向量
  calculateStd(embeddings, mean) {
    const dimensions = embeddings[0].length;
    const variance = new Array(dimensions).fill(0);
    
    for (const emb of embeddings) {
      for (let i = 0; i < dimensions; i++) {
        variance[i] += Math.pow(emb[i] - mean[i], 2);
      }
    }
    
    // 加一个小值防止除零
    return variance.map(val => Math.sqrt(val / embeddings.length) + 1e-8);
  }
  
  // 计算内部最小相似度
  calculateMinSimilarity(embeddings) {
    if (embeddings.length <= 1) return 0.9; // 单样本默认
    
    let minSim = 1;
    for (let i = 0; i < embeddings.length; i++) {
      for (let j = i + 1; j < embeddings.length; j++) {
        const sim = this.cosineSimilarity(embeddings[i], embeddings[j]);
        if (sim < minSim) minSim = sim;
      }
    }
    return minSim;
  }
  
  // 余弦相似度（更准确）
  cosineSimilarity(a, b) {
    let dot = 0, normA = 0, normB = 0;
    for (let i = 0; i < a.length; i++) {
      dot += a[i] * b[i];
      normA += a[i] * a[i];
      normB += b[i] * b[i];
    }
    return dot / (Math.sqrt(normA) * Math.sqrt(normB));
  }
  
  // Z-score标准化距离
  zScoreDistance(liveEmbedding, knownFace) {
    let totalZ = 0;
    const dimensions = liveEmbedding.length;
    
    for (let i = 0; i < dimensions; i++) {
      const z = Math.abs((liveEmbedding[i] - knownFace.mean[i]) / knownFace.std[i]);
      totalZ += z;
    }
    
    return totalZ / dimensions; // 平均Z-score
  }
  
  // 综合验证人脸
  verifyFace(liveEmbedding) {
    const now = Date.now();
    if (now - this.lastVerificationTime < this.verificationDelay) {
      return null; // 防止过于频繁验证
    }
    this.lastVerificationTime = now;
    
    let bestMatch = null;
    let bestScore = Infinity;
    let bestSimilarity = -1;
    let bestZScore = Infinity;
    
    // 遍历所有已知人脸
    for (const [name, faceData] of this.knownFaces) {
      // 计算Z-score距离
      const zScore = this.zScoreDistance(liveEmbedding, faceData);
      
      // 计算余弦相似度
      const similarity = this.cosineSimilarity(liveEmbedding, faceData.mean);
      
      // 综合得分（Z-score权重70%，相似度30%）
      const combinedScore = zScore * 0.7 + (1 - similarity) * 0.3;
      
      if (combinedScore < bestScore) {
        bestScore = combinedScore;
        bestSimilarity = similarity;
        bestZScore = zScore;
        bestMatch = name;
      }
    }
    
    if (!bestMatch) return null;
    
    const faceData = this.knownFaces.get(bestMatch);
    
    // 三重阈值验证
    const isZScoreValid = bestZScore < 0.85;                    // Z-score阈值
    const isSimilarityValid = bestSimilarity > 0.75;           // 相似度阈值
    const isInternalValid = bestSimilarity > (faceData.minSimilarity * 0.85); // 内部一致性
    
    if (isZScoreValid && isSimilarityValid && isInternalValid) {
      // 更新连续匹配计数
      const currentCount = this.consecutiveMatches.get(bestMatch) + 1;
      this.consecutiveMatches.set(bestMatch, currentCount);
      
      // 重置其他用户的计数
      for (const [name] of this.consecutiveMatches) {
        if (name !== bestMatch) {
          this.consecutiveMatches.set(name, 0);
        }
      }
      
      // 计算综合置信度
      const confidence = Math.min(0.99, 0.7 * (1 - bestZScore) + 0.3 * bestSimilarity);
      
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: confidence,
        consecutiveMatches: currentCount,
        isConfirmed: currentCount >= this.REQUIRED_CONSECUTIVE,
        securityLevel: this.getSecurityLevel(confidence, bestZScore, bestSimilarity)
      };
    } else {
      // 验证失败，重置该用户的计数
      this.consecutiveMatches.set(bestMatch, 0);
      return {
        name: bestMatch,
        zScore: bestZScore,
        similarity: bestSimilarity,
        confidence: 0,
        consecutiveMatches: 0,
        isConfirmed: false,
        securityLevel: 'low',
        reason: !isZScoreValid ? 'Z-score过高' : !isSimilarityValid ? '相似度不足' : '内部不一致'
      };
    }
  }
  
  // 获取安全等级
  getSecurityLevel(confidence, zScore, similarity) {
    if (confidence > 0.85 && zScore < 0.7 && similarity > 0.8) return 'high';
    if (confidence > 0.75 && zScore < 0.8 && similarity > 0.75) return 'medium';
    return 'low';
  }
  
  // 获取状态
  getStatus() {
    const status = {};
    for (const [name, count] of this.consecutiveMatches) {
      status[name] = { consecutiveMatches: count };
    }
    return status;
  }
}

// ===============================
// 已知用户数据（需要从collector复制过来）
// ===============================
const KNOWN_DATA = [
{
  "name": "Cyril Chan",
  "embeddings": [
    [
      -0.05052357539534569,
      0.03414178267121315,
      0.04568585753440857,
      -0.0023473636247217655,
      -0.024656813591718674,
      -0.0406377799808979,
      -0.039388518780469894,
      -0.14819249510765076,
      0.1403765082359314,
      -0.14164257049560547,
      0.22806447744369507,
      -0.052731093019247055,
      -0.21029536426067352,
      -0.09282431751489639,
      -0.08308373391628265,
      0.15841665863990784,
      -0.19272606074810028,
      -0.08144976198673248,
      -0.0029282066971063614,
      -0.049049556255340576,
      0.12930473685264587,
      0.040371958166360855,
      0.015671437606215477,
      -0.01143232174217701,
      -0.1164904236793518,
      -0.3018665611743927,
      -0.11591276526451111,
      -0.09784695506095886,
      0.05668991431593895,
      -0.04031968116760254,
      -0.04533717781305313,
      0.01931057497859001,
      -0.16827493906021118,
      -0.0341646745800972,
      0.008807293139398098,
      0.07710421085357666,
      -0.053332533687353134,
      -0.07289905101060867,
      0.1732269525527954,
      -0.03549515828490257,
      -0.18317773938179016,
      -0.01886145956814289,
      0.047213636338710785,
      0.2272895723581314,
      0.15244454145431519,
      0.07473813742399216,
      -0.016371339559555054,
      -0.12562943994998932,
      0.056949932128190994,
      -0.17558243870735168,
      0.006281209643930197,
      0.11584319174289703,
      0.044252894818782806,
      0.10458860546350479,
      0.008546498604118824,
      -0.09086647629737854,
      0.05828201025724411,
      0.08017891645431519,
      -0.13705013692378998,
      -0.006216965615749359,
      0.07401178032159805,
      -0.12588687241077423,
      0.009403270669281483,
      -0.008180858567357063,
      0.2547065317630768,
      0.015438692644238472,
      -0.1126423329114914,
      -0.129024475812912,
      0.0744437724351883,
      -0.1888490617275238,
      -0.09911913424730301,
      0.0635729432106018,
      -0.09952501952648163,
      -0.1583983600139618,
      -0.31279054284095764,
      0.009346111677587032,
      0.42680516839027405,
      0.09588486701250076,
      -0.11932352185249329,
      0.08656128495931625,
      -0.03363111615180969,
      -0.025059882551431656,
      0.2336782068014145,
      0.1348983347415924,
      0.008773844689130783,
      0.01196442823857069,
      -0.09257666021585464,
      0.013147520832717419,
      0.22304756939411163,
      -0.1060892790555954,
      -0.04850707948207855,
      0.17173199355602264,
      -0.05308953672647476,
      0.07993267476558685,
      0.0019253160571679473,
      0.0206481721252203,
      -0.0541599877178669,
      0.07331173866987228,
      -0.05402139946818352,
      -0.005072386469691992,
      0.12245375663042068,
      0.0018654136219993234,
      0.02324584685266018,
      0.116839200258255,
      -0.12959247827529907,
      0.10400360077619553,
      -0.0005009079468436539,
      -0.002496304688975215,
      0.10461446642875671,
      -0.056071218103170395,
      -0.13854825496673584,
      -0.053372230380773544,
      0.12749354541301727,
      -0.26183614134788513,
      0.21427375078201294,
      0.17096737027168274,
      0.025842830538749695,
      0.12613405287265778,
      0.10394067317247391,
      0.07915268838405609,
      -0.03292315825819969,
      -0.027495404705405235,
      -0.23934245109558105,
      -0.02247448079288006,
      0.11143048107624054,
      -0.015363219194114208,
      0.11871741712093353,
      -0.0517360121011734
    ],
    [
      -0.04152678698301315,
      0.039391182363033295,
      0.04905310273170471,
      -0.006685808300971985,
      -0.019472761079669,
      -0.05355506017804146,
      -0.03912637382745743,
      -0.14219368994235992,
      0.14017616212368011,
      -0.14521099627017975,
      0.22672386467456818,
      -0.04619843140244484,
      -0.2147826850414276,
      -0.082712821662426,
      -0.07751169055700302,
      0.14893978834152222,
      -0.17578880488872528,
      -0.0718432068824768,
      -0.010459830053150654,
      -0.05368686094880104,
      0.13149479031562805,
      0.05953342095017433,
      0.01878327503800392,
      -0.01652277074754238,
      -0.10820761322975159,
      -0.29811227321624756,
      -0.12222763150930405,
      -0.0967637449502945,
      0.03535928204655647,
      -0.034880589693784714,
      -0.043270498514175415,
      0.01862146332859993,
      -0.1618165373802185,
      -0.038667745888233185,
      0.009982237592339516,
      0.06985554844141006,
      -0.06061001121997833,
      -0.07263890653848648,
      0.18245603144168854,
      -0.028246799483895302,
      -0.17911364138126373,
      -0.021829361096024513,
      0.06032191962003708,
      0.22323866188526154,
      0.14866596460342407,
      0.07449767738580704,
      -0.009887258522212505,
      -0.13348114490509033,
      0.06101565808057785,
      -0.168770432472229,
      0.012813896872103214,
      0.11288757622241974,
      0.037592947483062744,
      0.10808015614748001,
      0.020002851262688637,
      -0.08797261118888855,
      0.06284143775701523,
      0.09464426338672638,
      -0.13089075684547424,
      -0.003007075283676386,
      0.08045148849487305,
      -0.1340138018131256,
      -0.009073939174413681,
      -0.005826042033731937,
      0.25681647658348083,
      0.01800401881337166,
      -0.10847439616918564,
      -0.12557847797870636,
      0.07745195180177689,
      -0.18858817219734192,
      -0.1163175031542778,
      0.06811162829399109,
      -0.10151486843824387,
      -0.15653705596923828,
      -0.30518919229507446,
      0.016930121928453445,
      0.42578259110450745,
      0.09126991778612137,
      -0.11585131287574768,
      0.09250509738922119,
      -0.021043963730335236,
      -0.02604619599878788,
      0.24934175610542297,
      0.14154976606369019,
      0.007792677264660597,
      0.0074196322821080685,
      -0.08777379989624023,
      0.016457386314868927,
      0.22961783409118652,
      -0.09932144731283188,
      -0.049234431236982346,
      0.16824392974376678,
      -0.050148092210292816,
      0.09069733321666718,
      0.007412243168801069,
      0.014965245500206947,
      -0.04899517446756363,
      0.06994012743234634,
      -0.06383837014436722,
      0.0031373584643006325,
      0.1303972452878952,
      -0.003281175158917904,
      0.0070389648899436,
      0.1123751774430275,
      -0.12951518595218658,
      0.09599188715219498,
      0.00004087762863491662,
      -0.010663735680282116,
      0.1043366938829422,
      -0.06670042127370834,
      -0.13014556467533112,
      -0.04681406915187836,
      0.12391233444213867,
      -0.25368937849998474,
      0.21239762008190155,
      0.15770858526229858,
      0.01723107323050499,
      0.1287510097026825,
      0.10337826609611511,
      0.08409616351127625,
      -0.02853194624185562,
      -0.03561154007911682,
      -0.25976788997650146,
      -0.023425493389368057,
      0.12325328588485718,
      -0.0039002816192805767,
      0.12241819500923157,
      -0.0571109764277935
    ],
    [
      -0.04531406611204147,
      0.058747656643390656,
      0.050132934004068375,
      -0.0015619113110005856,
      -0.043150339275598526,
      -0.022993145510554314,
      -0.04922909662127495,
      -0.15987731516361237,
      0.1429857611656189,
      -0.170972540974617,
      0.187417134642601,
      -0.060361817479133606,
      -0.207551509141922,
      -0.06248627230525017,
      -0.08236699551343918,
      0.1482028365135193,
      -0.1897028088569641,
      -0.09391186386346817,
      0.0038788646925240755,
      -0.04670587554574013,
      0.1372072547674179,
      0.020907992497086525,
      -0.009516214020550251,
      -0.01836264692246914,
      -0.11678496748209,
      -0.2925208508968353,
      -0.1533578336238861,
      -0.08240824192762375,
      0.048896148800849915,
      -0.026314763352274895,
      -0.08156955987215042,
      0.020073413848876953,
      -0.16386151313781738,
      -0.046281471848487854,
      -0.007779358420521021,
      0.0776120126247406,
      -0.07137548923492432,
      -0.07590989768505096,
      0.16822226345539093,
      -0.05187561735510826,
      -0.17032445967197418,
      0.01980390027165413,
      0.047235772013664246,
      0.20525749027729034,
      0.148894265294075,
      0.08270107954740524,
      -0.0015218968037515879,
      -0.1234806627035141,
      0.06689692288637161,
      -0.1552519053220749,
      0.015061971731483936,
      0.15025007724761963,
      0.05419321730732918,
      0.12246991693973541,
      0.010158972814679146,
      -0.12999072670936584,
      0.05227974057197571,
      0.09956176578998566,
      -0.10831107944250107,
      0.027461128309369087,
      0.08982411026954651,
      -0.14530599117279053,
      0.03375823795795441,
      -0.0066378479823470116,
      0.25134390592575073,
      0.02381671778857708,
      -0.11432093381881714,
      -0.1348113715648651,
      0.09687967598438263,
      -0.17211024463176727,
      -0.0771946981549263,
      0.02888977900147438,
      -0.12142358720302582,
      -0.1714697927236557,
      -0.30232077836990356,
      0.040996212512254715,
      0.41792750358581543,
      0.11656096577644348,
      -0.10641702264547348,
      0.09872744977474213,
      -0.03693605959415436,
      -0.01618370972573757,
      0.2231731414794922,
      0.15682506561279297,
      -0.005968973506242037,
      -0.002072232775390148,
      -0.09471955895423889,
      0.012811119668185711,
      0.21446654200553894,
      -0.09255515784025192,
      -0.038080453872680664,
      0.17747992277145386,
      -0.05465693771839142,
      0.09741290658712387,
      -0.000882832333445549,
      0.019425204023718834,
      -0.08061575144529343,
      0.06287572532892227,
      -0.046888403594493866,
      0.030706778168678284,
      0.09730402380228043,
      -0.042461998760700226,
      0.00034851330565288663,
      0.13934104144573212,
      -0.10187000036239624,
      0.09727571904659271,
      -0.02696966379880905,
      0.02494683675467968,
      0.05263884365558624,
      -0.05426497012376785,
      -0.14887043833732605,
      -0.03972131013870239,
      0.13145855069160461,
      -0.25709646940231323,
      0.20541520416736603,
      0.16979709267616272,
      0.002803474199026823,
      0.13790525496006012,
      0.13787585496902466,
      0.10688570141792297,
      -0.014814541675150394,
      -0.02639039419591427,
      -0.2690510153770447,
      -0.020645543932914734,
      0.12081429362297058,
      -0.011225255206227303,
      0.10421757400035858,
      -0.017477430403232574
    ],
    [
      -0.08429016917943954,
      0.06302184611558914,
      0.058212410658597946,
      -0.07817307859659195,
      -0.13314324617385864,
      0.008910133503377438,
      -0.024255847558379173,
      -0.09615448117256165,
      0.21214540302753448,
      -0.17361874878406525,
      0.2026994526386261,
      -0.04775993525981903,
      -0.2662178874015808,
      0.010854409076273441,
      -0.08894765377044678,
      0.16714638471603394,
      -0.17473576962947845,
      -0.1209728792309761,
      0.02589358016848564,
      -0.014748412184417248,
      0.10545322299003601,
      -0.017841633409261703,
      -0.009869336150586605,
      0.06282690912485123,
      -0.12034663558006287,
      -0.3596779704093933,
      -0.15208680927753448,
      -0.05669371783733368,
      0.03739499673247337,
      -0.08132842928171158,
      -0.046316519379615784,
      0.08274348825216293,
      -0.17635728418827057,
      -0.02975979447364807,
      -0.018338492140173912,
      0.1286458522081375,
      -0.059226904064416885,
      -0.11004943400621414,
      0.1673842966556549,
      0.026642048731446266,
      -0.19246794283390045,
      -0.03898320719599724,
      0.007621291559189558,
      0.2426716536283493,
      0.08472854644060135,
      0.08627033978700638,
      0.02492799051105976,
      -0.06278251856565475,
      0.025757862254977226,
      -0.23348312079906464,
      0.00408624904230237,
      0.16272912919521332,
      0.06259434670209885,
      0.06164819002151489,
      0.036983903497457504,
      -0.15824872255325317,
      0.06402534246444702,
      0.09948314726352692,
      -0.1551477611064911,
      0.020498037338256836,
      0.051150474697351456,
      -0.10927761346101761,
      0.03438209742307663,
      -0.060637425631284714,
      0.2514708340167999,
      0.0843544602394104,
      -0.09647763520479202,
      -0.0960039421916008,
      0.13681837916374207,
      -0.15350225567817688,
      -0.05453396961092949,
      0.04277387633919716,
      -0.1461086869239807,
      -0.20035499334335327,
      -0.2576505243778229,
      0.04115287959575653,
      0.40422800183296204,
      0.18560996651649475,
      -0.07255113869905472,
      0.046392232179641724,
      -0.027455389499664307,
      -0.019690657034516335,
      0.12223490327596664,
      0.12048790603876114,
      -0.04252200946211815,
      0.0054760645143687725,
      -0.09139470010995865,
      0.06644433736801147,
      0.19142216444015503,
      -0.07280092686414719,
      -0.00900338776409626,
      0.19037750363349915,
      -0.04656417295336723,
      0.07858412712812424,
      -0.04230398312211037,
      -0.008369797840714455,
      -0.0821891725063324,
      0.06427740305662155,
      -0.0696692019701004,
      0.026195958256721497,
      0.07533026486635208,
      -0.026826484128832817,
      -0.004909095354378223,
      0.14003252983093262,
      -0.17159990966320038,
      0.03215521574020386,
      -0.04199852794408798,
      -0.07903643697500229,
      0.003466264344751835,
      -0.013166633434593678,
      -0.185520201921463,
      -0.05136417970061302,
      0.15435665845870972,
      -0.26498958468437195,
      0.18653690814971924,
      0.24834437668323517,
      -0.013283063657581806,
      0.12083462625741959,
      0.1204773336648941,
      0.04786097630858421,
      0.0295219998806715,
      -0.08360707759857178,
      -0.20622046291828156,
      -0.03858990594744682,
      0.1330835074186325,
      -0.06259509921073914,
      0.05129574239253998,
      -0.051911789923906326
    ],
    [
      -0.07257246226072311,
      0.028631627559661865,
      0.040764160454273224,
      0.010865931399166584,
      -0.033432599157094955,
      -0.046033862978219986,
      -0.007334867957979441,
      -0.1657746136188507,
      0.1509149670600891,
      -0.10871712118387222,
      0.2281339168548584,
      -0.0641096979379654,
      -0.21789060533046722,
      -0.07186486572027206,
      -0.11369019001722336,
      0.16999121010303497,
      -0.19704163074493408,
      -0.07871242612600327,
      0.0005036226357333362,
      -0.02850491739809513,
      0.1398525834083557,
      0.02590111270546913,
      0.019555406644940376,
      0.0048659383319318295,
      -0.10156875103712082,
      -0.29059264063835144,
      -0.1126820519566536,
      -0.08513236790895462,
      0.03012305311858654,
      -0.05555978789925575,
      -0.03896074742078781,
      0.03762534633278847,
      -0.15116335451602936,
      -0.03580370917916298,
      0.022146152332425117,
      0.08854294568300247,
      -0.06251149624586105,
      -0.07610724866390228,
      0.19825007021427155,
      -0.04505711421370506,
      -0.19816584885120392,
      -0.004120710305869579,
      0.08400872349739075,
      0.2384897619485855,
      0.15496142208576202,
      0.08548332750797272,
      -0.024729585275053978,
      -0.12327323853969574,
      0.07610805332660675,
      -0.17684829235076904,
      0.0075926887802779675,
      0.11452504247426987,
      0.05336996912956238,
      0.08146602660417557,
      -0.01113010011613369,
      -0.1170613244175911,
      0.03659844771027565,
      0.0594591423869133,
      -0.1325724869966507,
      0.0010248523904010653,
      0.10599067807197571,
      -0.1631927341222763,
      -0.003630314953625202,
      -0.016080627217888832,
      0.20940613746643066,
      0.010703778825700283,
      -0.11175203323364258,
      -0.12593893706798553,
      0.08377081900835037,
      -0.1925738900899887,
      -0.09608650952577591,
      0.0407336950302124,
      -0.11468663066625595,
      -0.18336369097232819,
      -0.3193029463291168,
      0.01587325520813465,
      0.4583595097064972,
      0.09089893102645874,
      -0.09836391359567642,
      0.09310168027877808,
      -0.008803817443549633,
      -0.003021980170160532,
      0.20375436544418335,
      0.14941367506980896,
      0.002613286953419447,
      0.01873154379427433,
      -0.12002159655094147,
      0.002134675160050392,
      0.21100279688835144,
      -0.1075097918510437,
      -0.05656498298048973,
      0.15334701538085938,
      -0.0472031906247139,
      0.07093753665685654,
      0.0061149294488132,
      0.020892182365059853,
      -0.05367855355143547,
      0.07752014696598053,
      -0.08686287701129913,
      -0.0012822997523471713,
      0.09093941003084183,
      -0.010301626287400723,
      0.0360851027071476,
      0.10272752493619919,
      -0.12682898342609406,
      0.0988355427980423,
      0.0034133680164813995,
      -0.009782734327018261,
      0.0757221207022667,
      -0.04487806186079979,
      -0.15559439361095428,
      -0.04562259092926979,
      0.12141169607639313,
      -0.24499699473381042,
      0.20492582023143768,
      0.16776375472545624,
      0.05062108114361763,
      0.1413513720035553,
      0.11949674040079117,
      0.09988472610712051,
      -0.014166567474603653,
      0.007994457148015499,
      -0.2225634753704071,
      -0.03396601602435112,
      0.10513746738433838,
      0.010744629427790642,
      0.1411452740430832,
      -0.03141554445028305
    ],
    [
      -0.08536624163389206,
      -0.0029252301901578903,
      0.025760473683476448,
      -0.01758580096065998,
      0.0006359810358844697,
      -0.06090427190065384,
      -0.024474266916513443,
      -0.15230974555015564,
      0.14039959013462067,
      -0.1522344946861267,
      0.20427562296390533,
      -0.07923871278762817,
      -0.2203904390335083,
      -0.04114411026239395,
      -0.07119648903608322,
      0.14430569112300873,
      -0.16608500480651855,
      -0.08031745254993439,
      -0.014088437892496586,
      -0.04498453065752983,
      0.11425386369228363,
      0.04038665443658829,
      0.012268823571503162,
      0.016370320692658424,
      -0.12671974301338196,
      -0.27703413367271423,
      -0.1332457959651947,
      -0.09853381663560867,
      0.03371249884366989,
      -0.04500328749418259,
      -0.025377413257956505,
      0.018596461042761803,
      -0.13105399906635284,
      -0.011218694038689137,
      0.03292826563119888,
      0.10067431628704071,
      -0.0629199966788292,
      -0.07395519316196442,
      0.1853903830051422,
      -0.04037141427397728,
      -0.19241873919963837,
      -0.02238541655242443,
      0.05661901831626892,
      0.23102623224258423,
      0.11541488021612167,
      0.11643806099891663,
      -0.018323052674531937,
      -0.14652198553085327,
      0.06771434843540192,
      -0.19193457067012787,
      0.015338996425271034,
      0.1140374019742012,
      0.03556058555841446,
      0.10286450386047363,
      -0.001429457450285554,
      -0.11260241270065308,
      0.08729087561368942,
      0.08871155977249146,
      -0.1626746505498886,
      0.002462575677782297,
      0.07729651033878326,
      -0.1024879589676857,
      0.03005574457347393,
      0.015183676965534687,
      0.245970219373703,
      0.034042611718177795,
      -0.14005425572395325,
      -0.08094051480293274,
      0.08418985456228256,
      -0.208719402551651,
      -0.1025739461183548,
      0.042189519852399826,
      -0.10157126188278198,
      -0.20524688065052032,
      -0.2981577217578888,
      0.006629666313529015,
      0.46012169122695923,
      0.11513056606054306,
      -0.09764774888753891,
      0.08753854036331177,
      -0.009399758651852608,
      -0.025877155363559723,
      0.21530312299728394,
      0.1447434276342392,
      -0.051090583205223083,
      0.0009072198299691081,
      -0.07541340589523315,
      0.0032958025112748146,
      0.24318620562553406,
      -0.08004438132047653,
      -0.05042913556098938,
      0.13453815877437592,
      -0.03328961133956909,
      0.07822173833847046,
      0.0055970801040530205,
      0.02878727577626705,
      -0.06544948369264603,
      0.03962308540940285,
      -0.06481296569108963,
      -0.014053142629563808,
      0.09107371419668198,
      -0.0013618323719128966,
      0.018928952515125275,
      0.13018165528774261,
      -0.16301478445529938,
      0.16964571177959442,
      0.012403275817632675,
      -0.06250594556331635,
      0.07118966430425644,
      -0.0035865784157067537,
      -0.1178479865193367,
      -0.03631258383393288,
      0.11325444281101227,
      -0.24415504932403564,
      0.1932654082775116,
      0.19445784389972687,
      0.07125065475702286,
      0.15982428193092346,
      0.09925168752670288,
      0.08133665472269058,
      -0.017650656402111053,
      0.017199238762259483,
      -0.23731395602226257,
      -0.05314413458108902,
      0.11751969158649445,
      0.007500140927731991,
      0.14484478533267975,
      -0.041899148374795914
    ],
    [
      -0.06261290609836578,
      0.029091762378811836,
      0.015260946936905384,
      -0.015292959287762642,
      -0.03381844982504845,
      -0.05830187723040581,
      -0.056735411286354065,
      -0.1583881676197052,
      0.14664123952388763,
      -0.14519989490509033,
      0.24606283009052277,
      -0.04879852011799812,
      -0.19174811244010925,
      -0.08104687184095383,
      -0.0675499215722084,
      0.12697985768318176,
      -0.18378379940986633,
      -0.0768125057220459,
      0.010379372164607048,
      -0.060751162469387054,
      0.11373627930879593,
      0.02741336263716221,
      -0.0077381921000778675,
      -0.004395552445203066,
      -0.09084105491638184,
      -0.29632291197776794,
      -0.1285419464111328,
      -0.09305102378129959,
      0.06384061276912689,
      -0.07522270828485489,
      -0.03488771617412567,
      0.016855942085385323,
      -0.17439085245132446,
      -0.04421613737940788,
      0.030614791437983513,
      0.09690698981285095,
      -0.07069315016269684,
      -0.06724151223897934,
      0.17899782955646515,
      -0.054881416261196136,
      -0.15575261414051056,
      -0.021011503413319588,
      0.05651864409446716,
      0.21477125585079193,
      0.13123351335525513,
      0.08242981880903244,
      -0.00943534541875124,
      -0.13497278094291687,
      0.08616529405117035,
      -0.15461747348308563,
      0.011233171448111534,
      0.12605784833431244,
      0.06756865978240967,
      0.0802593007683754,
      0.0009187663672491908,
      -0.11361374706029892,
      0.051357198506593704,
      0.0990065410733223,
      -0.15120463073253632,
      0.006976015400141478,
      0.09431318193674088,
      -0.12579689919948578,
      -0.019738078117370605,
      0.012368143536150455,
      0.24222061038017273,
      0.03542881831526756,
      -0.10863469541072845,
      -0.145609512925148,
      0.08981654793024063,
      -0.19796855747699738,
      -0.09286677092313766,
      0.053245171904563904,
      -0.09691639989614487,
      -0.19809217751026154,
      -0.2872409224510193,
      0.030529921874403954,
      0.423976868391037,
      0.09913946688175201,
      -0.0988989919424057,
      0.1107582077383995,
      -0.009102312847971916,
      -0.033674582839012146,
      0.21300245821475983,
      0.13277721405029297,
      -0.020521171391010284,
      0.01718108355998993,
      -0.09478532522916794,
      0.021647967398166656,
      0.22273512184619904,
      -0.08004239946603775,
      -0.03282371163368225,
      0.14293912053108215,
      -0.060863275080919266,
      0.1011742576956749,
      0.0070524075999855995,
      0.002237534848973155,
      -0.06279711425304413,
      0.05599968880414963,
      -0.06840492784976959,
      -0.008027899079024792,
      0.08874371647834778,
      -0.0015723310643807054,
      0.014152410440146923,
      0.12300219386816025,
      -0.125571146607399,
      0.11107942461967468,
      -0.012504570186138153,
      -0.022810541093349457,
      0.05801108106970787,
      -0.05706002190709114,
      -0.1131868064403534,
      -0.05567586421966553,
      0.11087462306022644,
      -0.261822909116745,
      0.20820721983909607,
      0.1617213934659958,
      0.05326113849878311,
      0.15673629939556122,
      0.10890036821365356,
      0.06922297179698944,
      0.008808553218841553,
      -0.025586150586605072,
      -0.25677672028541565,
      -0.023906351998448372,
      0.08613254129886627,
      -0.004811177030205727,
      0.10766712576150894,
      -0.06262536346912384
    ]
  ],
  "sample_count": 7,
  "collected_at": "2025-12-10T07:06:16.472Z",
  "angles_collected": [
    "正面",
    "左转",
    "右转",
    "抬头",
    "低头",
    "微笑",
    "中性"
  ],
  "average_quality": "high",
  "note": "增强版多角度采集数据"
}
];

// ===============================
// 主程序
// ===============================
let faceVerifier = null;
let isRecognizing = false;
let modelsLoaded = false;
let hasSignedIn = false;
let isSubmitting = false;

// DOM 元素引用
const videoElement = document.getElementById('video');
const statusEl = document.getElementById('status');
const recognitionInfoEl = document.getElementById('recognitionInfo');
const recognizedNameEl = document.getElementById('recognizedName');
const recognitionConfidenceEl = document.getElementById('recognitionConfidence');
const recognitionSimilarityEl = document.getElementById('recognitionSimilarity');
const consecutiveMatchesEl = document.getElementById('consecutiveMatches');
const zScoreEl = document.getElementById('zScore');
const recognitionStatusEl = document.getElementById('recognitionStatus');
const signinSuccessEl = document.getElementById('signinSuccess');
const successNameEl = document.getElementById('successName');
const successTimeEl = document.getElementById('successTime');
const securityLevelEl = document.getElementById('securityLevel');

// 页面加载后执行
window.addEventListener('load', async () => {
  try {
    statusEl.textContent = '正在初始化增强版人脸识别系统...';
    statusEl.className = 'loading';
    
    // 1. 检查face-api.js
    await checkFaceAPI();
    
    // 2. 启动摄像头
    await startCamera();
    
    // 3. 加载模型
    await loadModels();
    
    // 4. 初始化增强验证器
    faceVerifier = new EnhancedFaceVerifier();
    
    // 5. 加载已知人脸数据
    await loadKnownFaces();
    
    modelsLoaded = true;
    statusEl.textContent = '✓ 增强版系统已就绪！开始识别...';
    statusEl.className = 'success';
    
    // 显示识别信息区域
    recognitionInfoEl.style.display = 'block';
    
    // 开始识别循环
    recognizeLoop();
    
  } catch (error) {
    console.error('初始化失败:', error);
    statusEl.textContent = '初始化失败: ' + error.message;
    statusEl.className = 'error';
  }
});

// 检查 faceapi 是否加载
function checkFaceAPI() {
  return new Promise((resolve, reject) => {
    if (window.faceapi) {
      console.log('faceapi 已加载');
      resolve();
      return;
    }
    
    let attempts = 0;
    const maxAttempts = 30;
    const interval = setInterval(() => {
      attempts++;
      if (window.faceapi) {
        clearInterval(interval);
        console.log('faceapi 加载成功');
        resolve();
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        reject(new Error('face-api.js 加载超时'));
      }
    }, 100);
  });
}

// 启动摄像头
async function startCamera() {
  try {
    statusEl.textContent = '正在请求摄像头权限...';
    statusEl.className = 'loading';
    
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: 640, 
        height: 480,
        facingMode: "user" 
      } 
    });
    
    videoElement.srcObject = stream;
    
    return new Promise((resolve) => {
      videoElement.onloadedmetadata = () => {
        videoElement.play();
        console.log('摄像头启动完成');
        resolve();
      };
    });
  } catch (error) {
    console.error('摄像头错误:', error);
    throw new Error('无法访问摄像头: ' + error.message);
  }
}

// 加载模型
async function loadModels() {
  try {
    statusEl.textContent = '正在加载人脸识别模型...';
    statusEl.className = 'loading';
    
    const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
    
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
    
    console.log('所有模型加载成功');
    
  } catch (error) {
    console.error('模型加载失败:', error);
    throw new Error('模型加载失败: ' + error.message);
  }
}

// 加载已知人脸数据
async function loadKnownFaces() {
  try {
    statusEl.textContent = '正在加载已知人脸数据...';
    
    // 支持两种格式：旧格式（单样本）和新格式（多样本）
    KNOWN_DATA.forEach(person => {
      if (person.embeddings && Array.isArray(person.embeddings[0])) {
        // 新格式：多样本
        faceVerifier.addKnownFace(person.name, person.embeddings);
      } else if (person.embedding) {
        // 旧格式：单样本
        faceVerifier.addKnownFace(person.name, person.embedding);
      } else {
        console.warn('未知的数据格式:', person);
      }
    });
    
    const userCount = faceVerifier.knownFaces.size;
    console.log(`已加载 ${userCount} 个用户数据`);
    statusEl.textContent = `✓ 已加载 ${userCount} 个用户数据`;
    
  } catch (error) {
    console.error('加载人脸数据失败:', error);
    throw new Error('人脸数据加载失败: ' + error.message);
  }
}

// 增强版识别循环
async function recognizeLoop() {
  if (!modelsLoaded || isRecognizing || hasSignedIn) return;
  
  try {
    isRecognizing = true;
    
    // 检测人脸（提高检测阈值）
    const detection = await faceapi
      .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions({
        inputSize: 320,
        scoreThreshold: 0.6
      }))
      .withFaceLandmarks()
      .withFaceDescriptor();
    
    if (detection && detection.detection.score > 0.7) {
      // 使用增强验证器
      const result = faceVerifier.verifyFace(detection.descriptor);
      
      if (result && result.confidence > 0) {
        // 更新UI显示
        updateRecognitionUI(result);
        
        // 检查是否确认
        if (result.isConfirmed && result.confidence > 0.85 && !hasSignedIn) {
          hasSignedIn = true;
          showSignInSuccess(result.name, result);
          sendSignIn(result.name, result.confidence);
        }
        
        // 绘制检测框
        drawDetection(detection, result);
        
      } else {
        // 验证失败
        resetRecognitionUI();
        if (result && result.reason) {
          recognitionStatusEl.textContent = `验证失败: ${result.reason}`;
        } else {
          recognitionStatusEl.textContent = '验证失败';
        }
        recognitionStatusEl.style.color = 'red';
      }
      
    } else {
      // 未检测到人脸或质量太低
      resetRecognitionUI();
      if (detection) {
        recognitionStatusEl.textContent = `检测质量低: ${detection.detection.score.toFixed(3)}`;
      } else {
        recognitionStatusEl.textContent = '未检测到人脸';
      }
      recognitionStatusEl.style.color = 'orange';
    }
    
  } catch (error) {
    console.error('识别错误:', error);
    recognitionStatusEl.textContent = '识别错误: ' + error.message;
    recognitionStatusEl.style.color = 'red';
  } finally {
    isRecognizing = false;
    
    // 继续识别循环（如果未签到）
    if (!hasSignedIn) {
      setTimeout(recognizeLoop, 300);
    }
  }
}

// 更新识别UI
function updateRecognitionUI(result) {
  recognizedNameEl.textContent = result.name;
  recognitionConfidenceEl.textContent = result.confidence.toFixed(4);
  recognitionSimilarityEl.textContent = result.similarity.toFixed(4);
  consecutiveMatchesEl.textContent = `${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE}`;
  zScoreEl.textContent = result.zScore.toFixed(4);
  
  // 设置状态颜色
  if (result.isConfirmed) {
    recognitionStatusEl.textContent = '✓ 高置信度确认！';
    recognitionStatusEl.style.color = 'green';
  } else if (result.confidence > 0.8) {
    recognitionStatusEl.textContent = `✓ 匹配中... (${result.consecutiveMatches}/${faceVerifier.REQUIRED_CONSECUTIVE})`;
    recognitionStatusEl.style.color = 'orange';
  } else if (result.confidence > 0.7) {
    recognitionStatusEl.textContent = `低置信度，请保持姿势`;
    recognitionStatusEl.style.color = '#FF9800';
  } else {
    recognitionStatusEl.textContent = '置信度不足';
    recognitionStatusEl.style.color = 'red';
  }
}

// 重置识别UI
function resetRecognitionUI() {
  recognizedNameEl.textContent = '-';
  recognitionConfidenceEl.textContent = '-';
  recognitionSimilarityEl.textContent = '-';
  consecutiveMatchesEl.textContent = '0/3';
  zScoreEl.textContent = '-';
}

// 绘制检测框
function drawDetection(detection, result) {
  const oldCanvas = document.querySelector('canvas');
  if (oldCanvas) oldCanvas.remove();
  
  const canvas = faceapi.createCanvasFromMedia(videoElement);
  const container = document.querySelector('.video-container');
  container.appendChild(canvas);
  
  const displaySize = { width: videoElement.width, height: videoElement.height };
  faceapi.matchDimensions(canvas, displaySize);
  
  const resizedDetection = faceapi.resizeResults(detection, displaySize);
  
  // 设置边框颜色
  const borderColor = result.confidence > 0.85 ? '#00ff00' : 
                     result.confance > 0.75 ? '#ff9900' : '#ff0000';
  
  const ctx = canvas.getContext('2d');
  
  // 绘制检测框
  faceapi.draw.drawDetections(canvas, [resizedDetection]);
  faceapi.draw.drawFaceLandmarks(canvas, [resizedDetection]);
  
  // 添加文字标签
  ctx.font = '16px Arial';
  ctx.fillStyle = borderColor;
  ctx.fillText(`${result.name} (${(result.confidence*100).toFixed(1)}%)`, 
               resizedDetection.detection.box.x, 
               resizedDetection.detection.box.y - 10);
}

// 显示签到成功信息
function showSignInSuccess(name, result) {
  const now = new Date();
  successNameEl.textContent = name;
  successTimeEl.textContent = now.toLocaleString();
  
  // 设置安全等级显示
  const securityLevels = {
    high: { text: '高', class: 'security-high', color: '#4CAF50' },
    medium: { text: '中', class: 'security-medium', color: '#FFC107' },
    low: { text: '低', class: 'security-low', color: '#F44336' }
  };
  
  const level = securityLevels[result.securityLevel || 'medium'];
  securityLevelEl.textContent = level.text;
  securityLevelEl.style.color = level.color;
  
  // 隐藏识别信息区域，显示成功区域
  recognitionInfoEl.style.display = 'none';
  signinSuccessEl.style.display = 'block';
  
  // 停止摄像头
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
    videoElement.style.opacity = '0.3';
  }
  
  statusEl.textContent = `✓ ${name} 签到成功！安全等级: ${level.text}`;
  statusEl.className = 'success';
}

// 发送签到信息
function sendSignIn(name, confidence) {
  try {
    isSubmitting = true;
    
    document.getElementById("nameField").value = name;
    document.getElementById("timeField").value = new Date().toISOString();
    
    console.log('正在提交签到数据:', name, '置信度:', confidence);
    
    const iframe = document.getElementById('resultIframe');
    iframe.onload = function() {
      console.log('数据提交完成！');
      isSubmitting = false;
      
      // 显示成功消息
      setTimeout(() => {
        alert(`✓ 签到成功！\n姓名: ${name}\n置信度: ${(confidence*100).toFixed(1)}%\n数据已保存到Google表格`);
      }, 300);
    };
    
    // 提交表单
    document.getElementById("sendForm").submit();
    
  } catch (error) {
    console.error('提交失败:', error);
    statusEl.textContent = '提交失败: ' + error.message;
    statusEl.className = 'error';
    alert('签到提交失败，请手动记录。错误: ' + error.message);
    isSubmitting = false;
    hasSignedIn = false; // 允许重试
  }
}

// 添加页面卸载时的清理
window.addEventListener('beforeunload', () => {
  if (videoElement.srcObject) {
    const tracks = videoElement.srcObject.getTracks();
    tracks.forEach(track => track.stop());
  }
});

// 全局错误处理
window.addEventListener('error', (e) => {
  console.error('全局错误:', e.error);
  if (statusEl) {
    statusEl.textContent = '发生错误: ' + e.message;
    statusEl.className = 'error';
  }
});
</script>

</body>
</html>
